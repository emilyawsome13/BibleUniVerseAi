<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Bible AI</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Sora:wght@400;500;600;700&display=swap');
        :root {
            color-scheme: light;
            --font-scale: 1;
            --compact-padding: 20px;
            --compact-gap: 15px;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --glass-border: rgba(24, 32, 56, 0.16);
            --glass-highlight: rgba(255, 255, 255, 0.9);
            --primary: #0A84FF;
            --primary-glow: rgba(10, 132, 255, 0.25);
            --secondary: #34C6FF;
            --success: #12D18E;
            --warning: #F59E0B;
            --danger: #EF4444;
            --bg: #f5f7fb;
            --bg-2: #e9eef8;
            --surface: rgba(255, 255, 255, 0.86);
            --surface-strong: rgba(255, 255, 255, 0.96);
            --ink-strong: rgba(15, 23, 42, 0.06);
            --ink: rgba(15, 23, 42, 0.12);
            --ink-soft: rgba(15, 23, 42, 0.08);
            --fullscreen-bg: rgba(245, 247, 251, 0.98);
            --text: #0f172a;
            --text-secondary: #4b5a74;
            --text-tertiary: #6f7f9b;
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --font-size: 1.05rem;
            --animation-speed: 1;
        }

        [data-theme="dark"] {
            color-scheme: dark;
            --glass-bg: rgba(15, 23, 42, 0.78);
            --glass-border: rgba(148, 163, 184, 0.18);
            --glass-highlight: rgba(255, 255, 255, 0.12);
            --bg: #0b1220;
            --bg-2: #0a0f1c;
            --surface: rgba(15, 23, 42, 0.64);
            --surface-strong: rgba(15, 23, 42, 0.82);
            --ink-strong: rgba(0, 0, 0, 0.8);
            --ink: rgba(0, 0, 0, 0.55);
            --ink-soft: rgba(0, 0, 0, 0.25);
            --fullscreen-bg: rgba(8, 8, 12, 0.92);
            --text: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: "Sora", "Segoe UI", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }

        h1, h2, h3, .brand-text, .challenge-title, .bible-reader-title, .bible-picks-title, .auth-title {
            font-family: "Outfit", "Sora", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }

        html {
            font-size: var(--font-size);
        }
        
        /* Font size scaling classes - applied to html element */
        html.font-small, body.font-small {
            --font-size: 0.875rem;
        }
        
        html.font-medium, body.font-medium {
            --font-size: 1rem;
        }
        
        html.font-large, body.font-large {
            --font-size: 1.1875rem;
        }
        
        body {
            min-height: 100vh;
            background: radial-gradient(720px 460px at 8% 10%, rgba(10, 132, 255, 0.18), transparent 66%),
                        radial-gradient(620px 420px at 92% -4%, rgba(52, 198, 255, 0.16), transparent 68%),
                        radial-gradient(520px 420px at 50% 110%, rgba(18, 209, 142, 0.14), transparent 70%),
                        linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
            color: var(--text);
            overflow-x: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
        }

        html[data-theme="dark"] body {
            background: radial-gradient(720px 460px at 10% 8%, rgba(255,255,255,0.05), transparent 68%),
                        radial-gradient(620px 420px at 88% 6%, rgba(255,255,255,0.04), transparent 70%),
                        radial-gradient(520px 420px at 50% 110%, rgba(255,255,255,0.045), transparent 72%),
                        linear-gradient(180deg, #040405 0%, #0a0b10 100%);
        }

        /* Animated Background */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .ambient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.35;
            animation: float 20s infinite ease-in-out;
        }

        .orb-1 { width: 600px; height: 600px; background: var(--primary); top: -300px; right: -200px; }
        .orb-2 { width: 520px; height: 520px; background: var(--secondary); bottom: -220px; left: -120px; animation-delay: -7s; }
        .orb-3 { width: 420px; height: 420px; background: var(--success); top: 40%; left: 60%; animation-delay: -14s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* ===== COMPACT MODE ===== */
        body.compact-mode .verse-card { padding: 15px !important; }
        body.compact-mode .card { padding: 12px !important; }
        body.compact-mode .tab-view { padding: 15px !important; }
        body.compact-mode .library-grid { gap: 10px !important; }
        body.compact-mode .comment { padding: 10px !important; margin-bottom: 8px !important; }
        body.compact-mode .action-btn { padding: 8px 12px !important; }
        body.compact-mode .nav-item { padding: 8px 12px !important; }

        /* ===== NO ANIMATIONS ===== */
        body.no-animations *,
        body.no-animations *::before,
        body.no-animations *::after { 
            animation: none !important;
        }
        body.no-animations .ambient-orb { 
            opacity: 0.1 !important;
            animation: none !important;
        }
        body.no-animations .card,
        body.no-animations .btn,
        body.no-animations .tab-btn {
            transition: none !important;
        }
        body.no-animations .tab-view.active,
        body.no-animations .tab-view.active > * {
            opacity: 1 !important;
            transform: none !important;
            filter: none !important;
            animation: none !important;
        }

        /* ===== PARTICLES ===== */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        body.particles-on .particles {
            opacity: 1;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255,255,255,0.5);
            border-radius: 50%;
            animation: particleFloat 18s infinite linear;
        }
        .particle.symbol {
            width: auto;
            height: auto;
            background: none;
            border-radius: 0;
            color: rgba(255,255,255,0.35);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 0 0 12px rgba(255,255,255,0.12);
            animation: particleFloat 22s infinite linear;
        }
        .particle.cross-image {
            width: 80px;
            height: 80px;
            background: url('/static/images/cross-particle.png') center/contain no-repeat;
            border-radius: 0;
            opacity: 0.8;
            filter: drop-shadow(0 0 28px rgba(255,255,255,0.7)) brightness(1.4) saturate(1.2);
            animation: particleFloatBright 28s infinite linear;
            mix-blend-mode: screen;
        }
        @keyframes particleFloatBright {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            8% { opacity: 0.9; }
            92% { opacity: 0.9; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes particleFloat {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            5% { opacity: 0.4; }
            95% { opacity: 0.4; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* ===== HIGH CONTRAST ===== */
        body.high-contrast {
            --primary: #0a5bff;
            --primary-glow: rgba(10, 91, 255, 0.35);
            --text: #0b1220;
            --text-secondary: #1f2a44;
            --glass-bg: var(--surface-strong);
            --glass-border: rgba(15, 23, 42, 0.18);
        }
        html[data-theme="dark"] body.high-contrast {
            --text: #f8fafc;
            --text-secondary: #e2e8f0;
            --glass-bg: rgba(15, 23, 42, 0.9);
            --glass-border: rgba(148, 163, 184, 0.24);
        }
        body.high-contrast .card,
        body.high-contrast .glass-card {
            border: 2px solid var(--glass-border);
        }
        body.high-contrast .verse-text {
            font-weight: 500;
        }

        body.focus-mode .ambient-bg,
        body.focus-mode .particles {
            opacity: 0.2;
        }

        body.focus-mode .verse-card {
            border-color: rgba(255, 255, 255, 0.22);
            box-shadow: 0 10px 26px rgba(0, 0, 0, 0.3);
        }

        body.focus-mode .verse-text {
            line-height: 1.9;
            letter-spacing: 0.15px;
        }

        /* ===== NOIR REDESIGN (ace.me inspired) ===== */
        body.noir-mode {
            color-scheme: dark;
            background: #020203 !important;
            --bg: #020203;
            --bg-2: #06070a;
            --surface: rgba(14, 14, 18, 0.74);
            --surface-strong: rgba(18, 18, 22, 0.92);
            --glass-bg: rgba(10, 10, 12, 0.92);
            --glass-border: rgba(255, 255, 255, 0.06);
            --glass-highlight: rgba(255, 255, 255, 0.04);
            --primary: #e8ecf4;
            --primary-glow: rgba(180, 190, 230, 0.15);
            --secondary: #9aa7c5;
            --success: #4ce6b2;
            --warning: #ffd27a;
            --danger: #ff6b6b;
            --text: #f1f3f8;
            --text-secondary: #b6bccb;
            --text-tertiary: #7d8698;
            --ink-strong: rgba(0, 0, 0, 0.65);
            --ink: rgba(0, 0, 0, 0.45);
            --ink-soft: rgba(0, 0, 0, 0.2);
            --fullscreen-bg: rgba(6, 7, 9, 0.98);
            position: relative;
        }

        body.noir-mode::before {
            content: '';
            position: fixed;
            inset: -20%;
            background:
                radial-gradient(520px 320px at 14% 10%, rgba(255, 255, 255, 0.06), transparent 62%),
                radial-gradient(520px 320px at 88% 12%, rgba(255, 255, 255, 0.04), transparent 66%),
                radial-gradient(520px 360px at 50% 110%, rgba(255, 255, 255, 0.05), transparent 72%),
                linear-gradient(180deg, #020203 0%, #06070a 100%);
            pointer-events: none;
            z-index: 0;
        }

        body.noir-mode::after {
            content: '';
            position: fixed;
            inset: 0;
            background:
                linear-gradient(0deg, rgba(255,255,255,0.03), rgba(255,255,255,0.03)),
                repeating-linear-gradient(90deg, rgba(255,255,255,0.03) 0, rgba(255,255,255,0.03) 1px, transparent 1px, transparent 110px),
                repeating-linear-gradient(0deg, rgba(255,255,255,0.025) 0, rgba(255,255,255,0.025) 1px, transparent 1px, transparent 110px);
            opacity: 0.12;
            pointer-events: none;
            z-index: 1;
            mix-blend-mode: screen;
        }

        body.noir-mode .ambient-bg { display: none; }
        body.noir-mode .particles { opacity: 0.05; }

        @keyframes floatIn {
            from { opacity: 0; transform: translateY(16px) scale(0.98); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes noirRise {
            from { opacity: 0; transform: translateY(22px) scale(0.985); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
            50% { box-shadow: 0 12px 40px rgba(120, 140, 255, 0.18); }
        }

        body.noir-mode .glass-card,
        body.noir-mode .card,
        body.noir-mode .verse-card,
        body.noir-mode .profile-info-card,
        body.noir-mode .stat-card,
        body.noir-mode .notice-card,
        body.noir-mode .comment,
        body.noir-mode .library-item,
        body.noir-mode .bible-reader,
        body.noir-mode .challenge-card {
            background: rgba(9,9,11,0.94);
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 26px 70px rgba(0,0,0,0.75);
            backdrop-filter: blur(20px);
            animation: noirRise 0.7s ease both;
        }

        body.noir-mode .glass-card:hover,
        body.noir-mode .card:hover,
        body.noir-mode .verse-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 32px 80px rgba(0,0,0,0.7);
            border-color: rgba(255,255,255,0.2);
        }

        body.noir-mode .sidebar {
            background: rgba(10,10,12,0.92);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 30px 80px rgba(0,0,0,0.7);
        }

        body.noir-mode .nav-item {
            color: var(--text-secondary);
            background: transparent;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        body.noir-mode .nav-item:hover {
            color: #fff;
            background: rgba(255,255,255,0.06);
        }

        body.noir-mode .nav-item.active {
            color: #fff;
            background: rgba(255,255,255,0.14);
            border-color: rgba(255,255,255,0.18);
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }

        body.noir-mode .header {
            background: rgba(8,8,10,0.96);
            border-color: rgba(255,255,255,0.08);
        }

        body.noir-mode .brand-icon {
            background: linear-gradient(145deg, #1a1b22, #0b0c10 52%, #1f2026);
            box-shadow: 0 6px 24px rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.12);
        }

        body.noir-mode .brand-icon::before {
            border-color: rgba(255,255,255,0.08);
        }

        body.noir-mode .nav-item.active {
            background: rgba(255,255,255,0.16);
            color: #fff;
            box-shadow: 0 12px 32px rgba(0,0,0,0.7);
        }

        body.noir-mode .nav-item:hover {
            background: rgba(255,255,255,0.08);
            color: #fff;
        }

        body.noir-mode .nav-item.active .nav-icon {
            filter: grayscale(1);
        }

        body.noir-mode .tab-btn,
        body.noir-mode .btn,
        body.noir-mode .action-btn,
        body.noir-mode .bible-reader-btn,
        body.noir-mode .gen-btn,
        body.noir-mode .send-btn {
            background: rgba(255,255,255,0.05);
            color: #f8fafc;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 999px;
            transition: all 0.25s ease;
        }

        body.noir-mode .tab-btn:hover,
        body.noir-mode .btn:hover,
        body.noir-mode .action-btn:hover,
        body.noir-mode .bible-reader-btn:hover,
        body.noir-mode .gen-btn:hover,
        body.noir-mode .send-btn:hover {
            background: rgba(255,255,255,0.18);
            transform: translateY(-2px);
        }

        body.noir-mode input,
        body.noir-mode textarea,
        body.noir-mode select,
        body.noir-mode .search-box,
        body.noir-mode .setting-select {
            background: rgba(8,8,10,0.98);
            border: 1px solid rgba(255,255,255,0.08);
            color: #f5f7ff;
        }

        body.noir-mode:not(.no-animations) .tab-view.active {
            animation: noirRise 0.8s ease;
        }
        body.noir-mode:not(.no-animations) .tab-view.active > * { animation: noirRise 0.75s ease; }
        body.noir-mode .tab-view.active > * {
            opacity: 1;
            transform: none;
            filter: none;
        }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(1) { animation-delay: 0.04s; }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(2) { animation-delay: 0.08s; }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(3) { animation-delay: 0.12s; }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(4) { animation-delay: 0.16s; }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(5) { animation-delay: 0.2s; }
        body.noir-mode:not(.no-animations) .tab-view.active > *:nth-child(6) { animation-delay: 0.24s; }

        body.noir-mode .daily-challenge {
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 22px 60px rgba(0,0,0,0.55);
            animation: glowPulse 6s ease-in-out infinite;
        }

        body.noir-mode .modal-content {
            background: rgba(12,12,14,0.92);
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: 0 30px 70px rgba(0,0,0,0.6);
        }

        /* App Container */
        .app {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
        }

        @media (min-width: 1024px) {
            html {
                font-size: 1.12rem;
            }
            .app {
                flex-direction: row;
                max-width: 1800px;
                margin: 0 auto;
                width: 100%;
                padding: 20px;
                gap: 20px;
            }
        }

        /* Header / Sidebar */
        .header {
            padding: calc(var(--safe-top) + 16px) 20px 16px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            position: relative;
        }

        @media (min-width: 1024px) {
            .header {
                width: 310px;
                flex-direction: column;
                align-items: stretch;
                border-bottom: none;
                border-right: 1px solid var(--glass-border);
                border-radius: 20px;
                height: calc(100vh - 40px);
                position: sticky;
                top: 20px;
                padding: 30px;
            }
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .brand-copy {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            min-width: 0;
        }
        .mobile-donate-btn {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 700;
            color: #ffffff;
            text-decoration: none;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 999px;
            padding: 5px 10px;
            white-space: nowrap;
            box-shadow: 0 6px 14px rgba(34,197,94,0.3);
        }
        .lovewell-donate-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: linear-gradient(135deg, #16a34a, #22c55e);
            color: #ffffff;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 12px;
            font-weight: 700;
            margin-top: 10px;
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.2);
        }

        .brand:active {
            transform: scale(0.95);
        }

        @media (min-width: 1024px) {
            .brand {
                margin-bottom: 32px;
                justify-content: center;
                flex-direction: column;
                text-align: center;
                padding-top: 16px;
            }
            .brand-copy {
                align-items: center;
            }
        }

        .brand-icon {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.24), transparent 55%), linear-gradient(145deg, #0a84ff, #4cc9f0 52%, #30d158);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 19px;
            color: rgba(255,255,255,0.96);
            box-shadow: 0 4px 20px var(--primary-glow);
            flex-shrink: 0;
            position: relative;
            border: 1px solid rgba(255,255,255,0.24);
            animation: brandPulse 3.2s ease-in-out infinite;
        }
        .brand-icon::before {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.2);
            opacity: 0.7;
            animation: brandPulseRing 3.2s ease-in-out infinite;
            pointer-events: none;
        }
        .brand-icon::after {
            content: '';
            position: absolute;
            inset: -8px;
            border-radius: 20px;
            border: 1px dashed rgba(255,255,255,0.18);
            opacity: 0.7;
            animation: brandSpin 14s linear infinite;
            pointer-events: none;
        }
        @keyframes brandPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 20px var(--primary-glow); }
            50% { transform: scale(1.04); box-shadow: 0 8px 28px var(--primary-glow); }
        }
        @keyframes brandPulseRing {
            0% { transform: scale(0.96); opacity: 0.65; }
            60% { transform: scale(1.08); opacity: 0.2; }
            100% { transform: scale(1.12); opacity: 0; }
        }
        @keyframes brandSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes slowSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(-360deg); }
        }

        .admin-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .admin-badge.show {
            display: block;
        }
        
        .role-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            color: white;
            font-size: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .role-badge.show {
            display: block;
        }
        
        .role-user { background: #666; }
        .role-host { background: #30D158; }
        .role-mod { background: #FF9F0A; }
        .role-co_owner { background: #BF5AF2; }
        .role-owner { background: #FF375F; }

        @media (min-width: 1024px) {
            .brand-icon {
                width: 60px;
                height: 60px;
                font-size: 28px;
                border-radius: 18px;
            }
        }
        .lovewell-logo {
            width: 78px;
            height: auto;
            margin-bottom: 5px;
            cursor: pointer;
            opacity: 0.92;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .lovewell-logo:hover {
            transform: translateY(-1px);
            opacity: 1;
        }
        @media (min-width: 1024px) {
            .lovewell-logo {
                width: 96px;
            }
        }

        .lovewell-credit {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            gap: 4px;
            margin: 0 8px;
            min-width: 96px;
            max-width: 130px;
        }

        .lovewell-credit-text {
            font-size: 11px;
            line-height: 1.25;
            color: var(--text-tertiary);
        }

        @media (max-width: 767px) {
            .header {
                display: grid;
                grid-template-columns: 1fr auto;
                grid-template-areas:
                    "brand actions"
                    "credit credit";
                gap: 10px 8px;
                align-items: center;
            }
            .brand {
                grid-area: brand;
            }
            .header-actions {
                grid-area: actions;
                justify-self: end;
            }
            .lovewell-credit {
                grid-area: credit;
            }
            .brand {
                min-width: 0;
            }
            .brand-text {
                font-size: 17px;
                line-height: 1.05;
            }
            .mobile-donate-btn {
                display: inline-flex;
            }
            .lovewell-donate-btn {
                display: none;
            }
            .lovewell-credit {
                width: 100%;
                max-width: none;
                margin: 4px 0 0;
                padding-top: 8px;
                border-top: 1px solid rgba(255,255,255,0.08);
                flex-direction: row;
                justify-content: center;
                gap: 10px;
            }
            .lovewell-logo {
                width: 58px;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .lovewell-credit-text {
                font-size: 11px;
                line-height: 1.25;
                max-width: 220px;
                text-align: left;
            }
            .header-actions {
                gap: 8px;
            }
            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
            }
        }

        .brand-text {
            font-size: 22px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        @media (min-width: 1024px) {
            .brand-text {
                font-size: 26px;
            }
        }

        .desktop-nav {
            display: none;
        }

        @media (min-width: 1024px) {
            .desktop-nav {
                display: flex;
                flex-direction: column;
                gap: 6px;
                flex: 1;
                overflow-y: auto;
            }
            
            .nav-item {
                padding: 16px 18px;
                background: transparent;
                border: 1px solid transparent;
                border-radius: 14px;
                color: var(--text-secondary);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                font-size: 16px;
                font-weight: 600;
                transition: all 0.25s;
                text-align: left;
            }
            
            .nav-item:hover {
                background: var(--surface);
                color: var(--text);
            }
            
            .nav-item.active {
                background: var(--primary);
                color: white;
                box-shadow: 0 4px 15px var(--primary-glow);
            }
            
            .nav-icon {
                font-size: 20px;
            }
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        @media (min-width: 1024px) {
            .lovewell-credit {
                margin-top: auto;
                padding-top: 15px;
                border-top: 1px solid var(--glass-border);
                max-width: 100%;
            }
            .lovewell-credit-text {
                font-size: 10px;
                max-width: 180px;
            }
            .header-actions {
                margin-top: auto;
                justify-content: center;
                padding-top: 16px;
                border-top: 1px solid var(--glass-border);
            }
        }

        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.25s;
            font-size: 19px;
            color: var(--text);
            flex-shrink: 0;
        }

        .icon-btn:hover {
            transform: scale(1.08);
            background: var(--primary);
        }

        /* Content Area */
        .content {
            flex: 1;
            padding: 16px;
            padding-bottom: calc(90px + var(--safe-bottom));
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
            .content {
                padding: 8px 0 24px;
                max-width: 1200px;
                margin: 0 auto;
                overflow-y: auto;
            }
        }

        @media (min-width: 1400px) {
            .content {
                max-width: 1320px;
            }
        }

        /* Tab Views */
        .tab-view {
            display: none;
            animation: fadeIn calc(0.25s * var(--animation-speed)) ease-out;
            max-width: 100%;
        }

        .tab-view.active {
            display: block;
            animation: tabEnter calc(0.34s * var(--animation-speed)) cubic-bezier(0.2, 0.7, 0.2, 1);
        }

        body.tab-discover .ambient-bg { filter: hue-rotate(0deg) saturate(1.02); }
        body.tab-recommendations .ambient-bg { filter: hue-rotate(26deg) saturate(1.08); }
        body.tab-library .ambient-bg { filter: hue-rotate(52deg) saturate(1.08); }
        body.tab-comments .ambient-bg { filter: hue-rotate(78deg) saturate(1.1); }
        body.tab-profile .ambient-bg { filter: hue-rotate(110deg) saturate(1.1); }
        body.tab-about .ambient-bg { filter: hue-rotate(145deg) saturate(1.16); }
        .ambient-bg { transition: filter 280ms ease; }

        @keyframes tabEnter {
            0% { opacity: 0; transform: translateY(10px) scale(0.995); filter: blur(3px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }

        .about-hero {
            margin-bottom: 12px;
            padding: 16px;
            border-radius: 16px;
            background: linear-gradient(145deg, rgba(10,132,255,0.18), rgba(191,90,242,0.14));
            border: 1px solid var(--glass-border);
        }

        .about-shell {
            max-width: 560px;
            margin: 0 auto;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .about-video-column { order: 2; }
        .about-side { order: 1; }

        .about-slider-wrap {
            position: relative;
            overflow: hidden;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            background: var(--ink-strong);
            box-shadow: 0 20px 40px rgba(15,23,42,0.2);
        }

        .about-slider-track {
            display: flex;
            transition: transform 0.35s ease;
            will-change: transform;
        }

        .about-progress {
            position: absolute;
            top: 6px;
            left: 8px;
            right: 108px;
            z-index: 4;
            display: flex;
            gap: 6px;
        }

        .about-progress-item {
            flex: 1;
            height: 3px;
            border-radius: 999px;
            background: rgba(255,255,255,0.22);
            overflow: hidden;
        }

        .about-progress-fill {
            width: 0%;
            height: 100%;
            border-radius: 999px;
            background: rgba(255,255,255,0.92);
            transition: width 120ms linear;
        }

        .about-now-playing {
            position: absolute;
            left: 10px;
            top: 14px;
            z-index: 4;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.2px;
            color: rgba(255,255,255,0.95);
            background: var(--ink);
            border: 1px solid rgba(255,255,255,0.24);
            border-radius: 999px;
            padding: 4px 10px;
            backdrop-filter: blur(6px);
            pointer-events: none;
        }

        .about-slide {
            min-width: 100%;
            padding: 0;
        }

        .about-video-frame {
            position: relative;
            width: 100%;
            aspect-ratio: 9 / 16;
            overflow: hidden;
            cursor: pointer;
        }

        .about-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scale(1.06);
            transform-origin: center;
            background: var(--ink-strong);
            border: none;
            border-radius: 0;
        }

        .about-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 32px;
            height: 32px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.28);
            background: var(--ink);
            color: #fff;
            font-size: 18px;
            line-height: 1;
            cursor: pointer;
            z-index: 3;
            display: grid;
            place-items: center;
            backdrop-filter: blur(6px);
        }

        .about-nav-btn.prev { left: 8px; }
        .about-nav-btn.next { right: 8px; }

        .about-volume-wrap {
            position: absolute;
            top: 8px;
            right: 8px;
            z-index: 4;
            width: 92px;
            height: 24px;
            padding: 0 8px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.24);
            background: var(--ink);
            backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
        }

        .about-volume-slider {
            width: 100%;
            height: 4px;
            margin: 0;
            background: transparent;
            -webkit-appearance: none;
            appearance: none;
            cursor: pointer;
        }

        .about-volume-slider:focus {
            outline: none;
        }

        .about-volume-slider::-webkit-slider-runnable-track {
            height: 4px;
            border-radius: 999px;
            background: rgba(255,255,255,0.38);
        }

        .about-volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 10px;
            height: 10px;
            margin-top: -3px;
            border-radius: 50%;
            border: 0;
            background: #ffffff;
        }

        .about-volume-slider::-moz-range-track {
            height: 4px;
            border-radius: 999px;
            border: 0;
            background: rgba(255,255,255,0.38);
        }

        .about-volume-slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 0;
            background: #ffffff;
        }

        .about-dots {
            position: absolute;
            left: 50%;
            bottom: 10px;
            transform: translateX(-50%);
            display: flex;
            gap: 7px;
            z-index: 4;
        }

        .about-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            border: 0;
            background: rgba(255,255,255,0.42);
            cursor: pointer;
            padding: 0;
        }

        .about-dot.active {
            background: #ffffff;
            transform: scale(1.15);
        }

        .about-paused-indicator {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            color: rgba(255,255,255,0.9);
            background: var(--ink-strong);
            border: 1px solid rgba(255,255,255,0.24);
            border-radius: 999px;
            padding: 8px 14px;
            pointer-events: none;
            z-index: 2;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .about-video-frame.paused .about-paused-indicator {
            opacity: 1;
        }

        .about-info-grid {
            margin-top: 14px;
            display: grid;
            gap: 10px;
        }

        .about-info-card {
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            background: var(--surface);
            padding: 12px;
        }

        .about-info-title {
            font-size: 13px;
            font-weight: 800;
            letter-spacing: 0.4px;
            text-transform: uppercase;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .about-info-text {
            font-size: 13px;
            line-height: 1.55;
            color: var(--text-secondary);
        }

        .about-link-inline {
            color: var(--primary);
            text-decoration: none;
            font-weight: 700;
        }

        @media (min-width: 1024px) {
            #about {
                grid-column: 1 / span 2;
            }

            .about-shell {
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: minmax(520px, 1fr) 340px;
                gap: 24px;
                align-items: start;
            }

            .about-video-column {
                display: flex;
                justify-content: center;
            }

            .about-slider-wrap {
                width: min(760px, 100%);
                margin: 0 auto;
            }

            .about-side {
                display: flex;
                flex-direction: column;
                gap: 14px;
            }
        }

        html[data-theme="light"] .about-slider-wrap,
        html[data-theme="light"] .about-video {
            background: var(--surface-strong);
        }

        html[data-theme="light"] .about-now-playing,
        html[data-theme="light"] .about-nav-btn,
        html[data-theme="light"] .about-volume-wrap,
        html[data-theme="light"] .about-paused-indicator {
            background: var(--surface-strong);
            color: var(--text);
            border-color: var(--glass-border);
        }

        html[data-theme="light"] .about-progress-item {
            background: rgba(15, 23, 42, 0.12);
        }

        html[data-theme="light"] .about-progress-fill {
            background: var(--primary);
        }

        html[data-theme="light"] .about-dot {
            background: rgba(15, 23, 42, 0.2);
        }

        html[data-theme="light"] .about-dot.active {
            background: var(--primary);
        }

        @media (min-width: 1024px) {
            .tab-view {
                display: none;
            }
            
            .tab-view.active {
                display: block;
                overflow-y: visible;
                padding-right: 0;
            }

            #discover,
            #recommendations,
            #library,
            #comments,
            #about,
            #profile,
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Glass Cards */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(150%);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            transition: transform 0.25s, box-shadow 0.25s;
        }

        @media (min-width: 1024px) {
            .glass-card {
                padding: 28px;
            }
        }

        .glass-card:hover {
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.18);
        }

        @media (min-width: 1024px) {
            .glass-card {
                margin-bottom: 0;
            }
        }

        /* Verse Display */
        .verse-container {
            cursor: pointer;
            transition: transform 0.25s;
        }

        .verse-container:hover {
            transform: scale(1.01);
        }

        .verse-container.verse-reveal {
            animation: verseReveal calc(0.7s * var(--animation-speed)) cubic-bezier(0.16, 0.84, 0.3, 1);
        }

        @keyframes verseReveal {
            0% { opacity: 0.22; transform: translateY(14px) scale(0.985); filter: blur(6px); }
            60% { opacity: 1; transform: translateY(0) scale(1.003); filter: blur(0); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }

        .verse-text {
            font-size: 22px;
            line-height: 1.6;
            font-weight: 400;
            letter-spacing: -0.01em;
            margin-bottom: 20px;
            word-wrap: break-word;
        }

        @media (min-width: 768px) {
            .verse-text {
                font-size: 26px;
            }
        }

        @media (min-width: 1024px) {
            .verse-text {
                font-size: 28px;
                line-height: 1.5;
            }
        }

        .verse-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .verse-ref {
            font-size: 16px;
            font-weight: 700;
            color: var(--primary);
        }

        .verse-source-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .verse-badge {
            background: linear-gradient(135deg, var(--warning), #FF6B35);
            color: white;
            padding: 5px 10px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .signed-by {
            font-size: 10px;
            opacity: 0.7;
            font-style: italic;
        }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .action-grid {
                gap: 12px;
            }
        }

        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 14px 8px;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.25s;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
        }

        .action-btn:hover {
            background: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px var(--primary-glow);
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        .action-btn.pop-success {
            animation: actionPop calc(0.36s * var(--animation-speed)) ease;
        }

        @keyframes actionPop {
            0% { transform: scale(1); }
            45% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .action-icon {
            font-size: 22px;
        }

        .action-icon.spark {
            animation: iconSpark calc(0.45s * var(--animation-speed)) ease;
        }

        @keyframes iconSpark {
            0% { transform: scale(1) rotate(0deg); }
            40% { transform: scale(1.22) rotate(-10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .reaction-burst {
            position: fixed;
            z-index: 9999;
            pointer-events: none;
            font-size: 14px;
            animation: burstFloat 650ms ease-out forwards;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.3));
        }

        @keyframes burstFloat {
            0% { opacity: 0; transform: translateY(6px) scale(0.9); }
            20% { opacity: 1; }
            100% { opacity: 0; transform: translateY(-34px) translateX(var(--dx, 0px)) scale(1.25); }
        }

        /* Timer */
        .timer-wrapper {
            margin-top: 20px;
        }

        .timer-bar {
            height: 4px;
            background: var(--surface);
            border-radius: 2px;
            overflow: hidden;
        }

        .timer-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 2px;
            transition: width 1s linear;
            box-shadow: 0 0 12px var(--primary-glow);
        }

        .timer-text {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: var(--text-tertiary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Recommendations */
        .gen-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px var(--primary-glow);
            transition: all 0.25s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .gen-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px var(--primary-glow);
        }

        .rec-card {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.08), rgba(191, 90, 242, 0.08));
            border: 1px solid rgba(10, 132, 255, 0.25);
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 12px;
            animation: slideIn 0.35s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-15px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Library Tab - Simplified */
        .favorites-collection {
            background: linear-gradient(135deg, rgba(255, 59, 95, 0.1), rgba(255, 159, 10, 0.1));
            border: 2px dashed var(--danger);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            min-height: 200px;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .favorites-collection.drag-over {
            background: linear-gradient(135deg, rgba(255, 59, 95, 0.2), rgba(255, 159, 10, 0.2));
            transform: scale(1.02);
            border-color: var(--success);
        }

        .favorites-header {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .favorites-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .favorites-count {
            font-size: 32px;
            font-weight: 700;
            color: var(--danger);
            margin-top: 10px;
        }

        /* Verse List */
        .verse-list {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .verse-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.2s;
            position: relative;
            user-select: none;
            touch-action: manipulation;
        }

        .verse-card:hover {
            transform: translateX(4px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .verse-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 100;
        }

        .verse-card-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            pointer-events: none;
        }

        .verse-card-ref {
            font-size: 12px;
            color: var(--primary);
            font-weight: 700;
            pointer-events: none;
        }

        .verse-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--glass-border);
        }

        .verse-card-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .verse-card-btn:hover {
            background: var(--primary);
            border-color: var(--primary);
        }

        .verse-card-btn.liked {
            background: var(--danger);
            border-color: var(--danger);
        }

        .verse-card-btn.saved {
            background: var(--warning);
            border-color: var(--warning);
        }

        /* Comments Tab */
        .comments-container {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .comment-section {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid var(--glass-border);
        }

        .comment-section-header {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .comment-pin-btn {
            margin-left: auto;
            background: rgba(255,255,255,0.08);
            border: 1px solid var(--glass-border);
            color: var(--text);
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
        }

        .comment-pin-btn:hover {
            background: rgba(255,255,255,0.14);
        }

        .dm-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 12px;
        }

        .dm-thread-list {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 10px;
            max-height: 360px;
            overflow-y: auto;
        }

        .dm-thread {
            display: flex;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            border-radius: 12px;
            cursor: pointer;
            border: 1px solid transparent;
        }

        .dm-thread:hover {
            background: rgba(255,255,255,0.06);
            border-color: var(--glass-border);
        }

        .dm-thread.active {
            background: rgba(79,70,229,0.18);
            border-color: rgba(79,70,229,0.4);
        }

        .dm-thread-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            object-fit: cover;
        }

        .dm-thread-name {
            font-size: 13px;
            font-weight: 600;
        }

        .dm-thread-last {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .dm-unread {
            margin-left: auto;
            background: rgba(255,71,87,0.2);
            color: #ff6b7a;
            border: 1px solid rgba(255,71,87,0.45);
            font-size: 11px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 999px;
        }

        .dm-messages {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 240px;
        }

        .dm-message {
            max-width: 75%;
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 13px;
            line-height: 1.4;
            background: rgba(255,255,255,0.08);
        }

        .dm-message.self {
            margin-left: auto;
            background: rgba(79,70,229,0.35);
        }

        .dm-time {
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-top: 4px;
            color: var(--text-secondary);
        }

        .dm-message:hover .dm-time {
            opacity: 0.75;
        }

        .dm-input-area {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
        }

        .dm-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .dm-typing {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 6px;
            min-height: 16px;
        }

        .dm-input {
            flex: 1;
            background: rgba(0,0,0,0.35);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            padding: 8px 10px;
            font-size: 13px;
        }

        .dm-search {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .dm-search-results {
            background: rgba(0,0,0,0.35);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 6px;
            max-height: 160px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        @media (max-width: 900px) {
            .dm-layout {
                grid-template-columns: 1fr;
            }
            .dm-time {
                opacity: 0.75;
            }
        }

        .comment-input-area {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 12px 16px;
            margin-bottom: 12px;
            display: flex;
            gap: 10px;
            align-items: flex-end;
            border: 1px solid var(--glass-border);
        }

        .restriction-banner {
            display: none;
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(239, 68, 68, 0.45);
            background: rgba(239, 68, 68, 0.12);
            color: var(--text);
            font-size: 13px;
            margin-bottom: 12px;
        }

        .comment-input-area.is-disabled {
            opacity: 0.7;
        }

        .comment-input:disabled {
            cursor: not-allowed;
        }

        .send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 15px;
            resize: none;
            outline: none;
            min-height: 22px;
            max-height: 120px;
            font-family: inherit;
            line-height: 1.5;
        }

        .comment-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s;
            font-size: 18px;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px var(--primary-glow);
        }

        .notice-card {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .notice-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .notice-title {
            font-size: 16px;
            font-weight: 700;
        }

        .notice-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 220px;
            overflow-y: auto;
        }

        .notice-item {
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
            background: var(--surface-strong);
        }

        .notice-item-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 6px;
        }

        .notice-item-meta {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        .notice-empty {
            font-size: 13px;
            opacity: 0.7;
            text-align: center;
            padding: 16px 0;
        }

        .account-lock {
            position: fixed;
            inset: 0;
            background: rgba(6, 10, 20, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 24px;
        }

        .account-lock-card {
            max-width: 420px;
            width: 100%;
            text-align: center;
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 20px;
            padding: 28px;
            color: #fff;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
        }

        .account-lock-card h2 {
            margin: 0 0 12px;
            color: #ff6b6b;
        }

        .comments-list {
            max-height: 250px;
            overflow-y: auto;
        }

        .comment-item {
            background: var(--glass-bg);
            border-radius: 14px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--glass-border);
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .comment-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--glass-border);
        }
        .avatar-wrap {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            flex: 0 0 auto;
        }
        .avatar-wrap img {
            display: block;
        }
        .avatar-wrap img:not(.avatar-decor) {
            position: relative;
            z-index: 1;
        }
        .avatar-wrap .avatar-decor {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 124%;
            height: 124%;
            object-fit: contain;
            pointer-events: none;
            filter: drop-shadow(0 8px 20px rgba(0,0,0,0.4));
            z-index: 2;
        }
        .avatar-wrap.avatar-large .avatar-decor {
            width: 136%;
            height: 136%;
        }
        .avatar-decor.hidden {
            display: none;
        }
        @keyframes decor-spin {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes decor-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.06); }
        }
        .avatar-decor.spin {
            animation: decor-spin 8s linear infinite;
        }
        .avatar-decor.pulse {
            animation: decor-pulse 2.6s ease-in-out infinite;
        }
        #headerAvatarWrap {
            width: 36px;
            height: 36px;
        }
        #headerAvatarImg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }
        .avatar-wrap.avatar-large {
            width: 90px;
            height: 90px;
        }
        .avatar-shop-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
            width: 100%;
        }
        .decor-option {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s;
        }
        .decor-option img {
            width: 56px;
            height: 56px;
            object-fit: contain;
        }
        .decor-option.active {
            border-color: rgba(79,70,229,0.6);
            box-shadow: 0 10px 26px rgba(79,70,229,0.25);
            transform: translateY(-2px);
        }
        .shop-note {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .comment-user-link {
            text-decoration: none;
            color: inherit;
        }

        .comment-user-link:hover {
            color: var(--primary);
        }

        .comment-meta {
            flex: 1;
        }

        .comment-name {
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 150px;
        }

        .comment-name-row {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
            row-gap: 4px;
            min-width: 0;
        }

        .comment-role-badge {
            font-size: 10px;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            border: 1px solid var(--glass-border);
            color: #fff;
            opacity: 0.95;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .comment-role-user { background: #666; }
        .comment-role-host { background: #30D158; color: #002b10; }
        .comment-role-mod { background: #FF9F0A; color: #2b1700; }
        .comment-role-co_owner { background: #BF5AF2; }
        .comment-role-owner { background: #FF375F; }

        .comment-time {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            margin-left: 42px;
            word-wrap: break-word;
        }

        .delete-comment-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--danger);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .delete-comment-btn.show {
            display: flex;
        }

        .delete-comment-btn:hover {
            transform: scale(1.1);
        }

        /* Community Chat Special Styling */
        .community-section {
            background: linear-gradient(135deg, rgba(10, 132, 255, 0.05), rgba(191, 90, 242, 0.05));
            border-color: rgba(10, 132, 255, 0.2);
        }

        .community-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Settings Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 24px;
            animation: zoomIn 0.25s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes zoomIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
        }

        .close-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            font-size: 16px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: var(--danger);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid var(--glass-border);
            flex-wrap: wrap;
            gap: 12px;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 16px;
            font-weight: 600;
        }

        .setting-desc {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }

        .toggle {
            width: 50px;
            height: 30px;
            background: var(--surface);
            border-radius: 30px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid var(--glass-border);
            flex-shrink: 0;
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle-thumb {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle.active .toggle-thumb {
            transform: translateX(20px);
        }

        .segment-control {
            display: flex;
            background: var(--surface);
            border-radius: 10px;
            padding: 2px;
            gap: 2px;
        }

        .segment-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .segment-btn.active {
            background: var(--glass-bg);
            color: var(--text);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .setting-select {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            padding: 8px 12px;
            color: var(--text);
            font-size: 14px;
            cursor: pointer;
            min-width: 120px;
        }

        .admin-only {
            display: none;
        }

        .admin-only.show {
            display: flex;
        }

        .role-gated {
            display: none;
        }

        .admin-panel-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--danger), #FF6B35);
            border: none;
            border-radius: 16px;
            color: white;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 16px;
            display:
        }

        .admin-panel-btn.show {
            display: block;
        }

        /* Admin Unlock Modal */
        .admin-unlock-modal .modal-content {
            max-width: 420px;
            text-align: center;
        }

        .role-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .role-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 16px 10px;
            background: var(--surface);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .role-btn:hover {
            border-color: var(--primary);
            background: rgba(10, 132, 255, 0.1);
        }

        .role-btn.selected {
            border-color: var(--primary);
            background: rgba(10, 132, 255, 0.15);
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.3);
        }

        .role-btn.selected .role-name {
            color: var(--primary);
            font-weight: 700;
        }

        .role-icon {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .role-name {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .admin-code-input {
            width: 100%;
            padding: 16px;
            background: var(--surface);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text);
            font-size: 18px;
            text-align: center;
            margin: 16px 0;
            letter-spacing: 2px;
        }

        .admin-code-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .unlock-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
        }

        .unlock-btn:disabled {
            background: var(--surface);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .unlock-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--primary-glow);
        }

        /* Mobile Tab Bar - Removed Images */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: blur(20px) saturate(180%);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: flex-start;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            scrollbar-width: none;
            padding: 10px 8px calc(10px + var(--safe-bottom));
            z-index: 100;
        }
        .tab-bar::-webkit-scrollbar {
            display: none;
        }

        @media (min-width: 1024px) {
            .tab-bar {
                display: none;
            }
        }

        .tab-btn {
            flex: 0 0 auto;
            min-width: 66px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 6px 2px;
            transition: all 0.25s;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-icon {
            font-size: 20px;
            transition: transform 0.25s;
        }

        .tab-btn.active .tab-icon {
            transform: translateY(-2px);
        }

        .tab-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        /* Fullscreen Verse */
        .fullscreen-verse {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(20px);
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 30px;
            cursor: pointer;
        }

        .fullscreen-verse.active {
            display: flex;
            animation: zoomIn 0.3s ease-out;
        }

        .fullscreen-text {
            font-size: clamp(22px, 4vw, 44px);
            line-height: 1.6;
            text-align: center;
            font-weight: 300;
            max-width: 900px;
            white-space: pre-wrap;
            margin-bottom: 40px;
        }

        .fullscreen-actions {
            display: flex;
            gap: 16px;
            margin-top: 20px;
        }

        .fullscreen-btn {
            padding: 14px 28px;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            color: var(--text);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fullscreen-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        .fullscreen-hint {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 13px;
            opacity: 0.5;
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            padding: 14px 28px;
            border-radius: 100px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10001;
            opacity: 0;
            transition: all 0.35s;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 90%;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        /* Profile Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: transform 0.25s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.7;
        }

        /* Profile Info Cards */
        .profile-info-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        @media (min-width: 640px) {
            .profile-info-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .profile-info-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .profile-info-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
        }

        .profile-info-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            opacity: 0.6;
            margin-bottom: 8px;
        }

        .profile-info-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .profile-info-sub {
            margin-top: 6px;
            font-size: 12px;
            color: var(--text-tertiary);
            letter-spacing: 0.4px;
            text-transform: uppercase;
        }

        /* Profile Add-ons */
        .streak-day {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
        }
        .streak-day.active {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }
        .streak-day.inactive {
            background: var(--surface);
            opacity: 0.4;
        }
        .streak-day.today {
            border: 2px solid #ff6b35;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .achievement-badge {
            aspect-ratio: 1;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: all 0.3s;
            position: relative;
        }
        .achievement-badge.unlocked {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border: 1px solid var(--primary);
            cursor: pointer;
        }
        .achievement-badge.locked {
            background: var(--surface);
            opacity: 0.4;
            filter: grayscale(1);
        }
        .achievement-badge:hover.unlocked {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
        }
        .achievement-icon {
            font-size: 28px;
            margin-bottom: 4px;
        }
        .achievement-name {
            font-size: 9px;
            font-weight: 700;
            text-align: center;
            text-transform: uppercase;
        }
        .achievement-tooltip {
            position: fixed;
            background: var(--surface-strong);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 10000;
            pointer-events: none;
            border: 1px solid var(--glass-border);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .achievement-tooltip .achievement-progress {
            margin-top: 6px;
            width: 120px;
            height: 4px;
            background: rgba(255,255,255,0.15);
            border-radius: 999px;
            overflow: hidden;
        }
        .achievement-tooltip .achievement-progress-fill {
            height: 100%;
            width: 0%;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary-glow);
            transition: width 220ms ease;
        }
        .achievement-tooltip .achievement-progress-label {
            margin-top: 4px;
            font-size: 10px;
            opacity: 0.75;
            text-align: right;
        }
        .achievement-tooltip.visible {
            opacity: 1;
        }

        .book-bar {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .book-name {
            font-size: 13px;
            font-weight: 600;
            min-width: 100px;
            text-transform: uppercase;
        }
        .book-progress {
            flex: 1;
            height: 24px;
            background: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        .book-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 11px;
            font-weight: 700;
        }
        .book-count {
            font-size: 12px;
            font-weight: 700;
            color: var(--primary);
            min-width: 30px;
            text-align: right;
        }

        .verse-history-item {
            background: var(--surface);
            border-radius: 12px;
            padding: 12px 16px;
            border-left: 3px solid var(--primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .verse-history-ref {
            font-weight: 700;
            font-size: 13px;
            color: var(--primary);
        }
        .verse-history-time {
            font-size: 11px;
            opacity: 0.6;
        }

        /* === NEW FEATURE STYLES === */
        
        /* Discover Tab - Daily Challenge */
        .daily-challenge {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border: 2px solid var(--primary);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
        }
        .daily-challenge::before {
            content: '';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 60px;
            opacity: 0.2;
            animation: slowSpin 18s linear infinite;
        }
        .daily-challenge::after {
            content: '';
            position: absolute;
            inset: -20px;
            border-radius: 28px;
            border: 1px dashed rgba(255,255,255,0.12);
            opacity: 0.35;
            animation: brandSpin 28s linear infinite;
            pointer-events: none;
        }
        .daily-challenge.complete .challenge-text {
            opacity: 0.75;
        }
        .daily-challenge.complete .challenge-progress,
        .daily-challenge.complete .challenge-progress-text {
            display: none;
        }
        .challenge-title {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            color: var(--primary);
        }
        .challenge-text {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }
        .challenge-progress {
            background: var(--surface);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        .challenge-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .bible-picks-card {
            margin: 14px 0 16px;
            padding: 16px;
        }

        .bible-picks-header {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }

        .bible-picks-title {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
        }

        .bible-picks-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .bible-picks-input {
            flex: 1;
            min-width: 180px;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            padding: 10px 12px;
            font-size: 13px;
        }

        .bible-picks-btn {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--primary);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
        }

        .bible-picks-btn.secondary {
            background: var(--surface);
            color: var(--text);
        }

        .bible-picks-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .bible-picks-row {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .bible-picks-select {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            padding: 10px 12px;
            font-size: 13px;
        }

        .bible-reader-card {
            margin-top: 16px;
            padding: 16px;
        }

        .bible-reader-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bible-reader-title {
            font-size: 14px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
        }

        .bible-reader-current {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .bible-reader-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }

        .bible-reader-select,
        .bible-reader-input {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            border-radius: 10px;
            color: var(--text);
            padding: 10px 12px;
            font-size: 13px;
        }

        .bible-reader-select {
            flex: 1;
            min-width: 180px;
        }

        .bible-reader-input {
            width: 90px;
        }

        .bible-reader-btn {
            padding: 9px 12px;
            border-radius: 10px;
            border: 1px solid var(--glass-border);
            background: var(--primary);
            color: white;
            font-weight: 700;
            cursor: pointer;
            font-size: 12px;
        }

        .bible-reader-btn.secondary {
            background: var(--surface);
            color: var(--text);
        }

        .bible-reader-btn.next-chapter {
            display: none;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            box-shadow: 0 6px 16px var(--primary-glow);
        }

        .bible-reader-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .bible-reader-pagination {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .bible-reader-page {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 700;
        }

        .bible-reader-content {
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            background: var(--surface);
            max-height: 320px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .reader-verse {
            margin-bottom: 8px;
        }

        .reader-verse span {
            display: inline-block;
            min-width: 28px;
            margin-right: 6px;
            color: var(--text-tertiary);
            font-weight: 700;
        }

        .reader-fullscreen {
            position: fixed;
            inset: 0;
            background: var(--fullscreen-bg);
            backdrop-filter: blur(14px);
            display: none;
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
        }

        .reader-fullscreen.active {
            display: block;
        }

        .reader-fullscreen-inner {
            max-width: 900px;
            margin: 0 auto;
        }

        .reader-fullscreen-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        body.reader-fullscreen-open {
            overflow: hidden;
        }

        .reader-fullscreen .bible-reader-content {
            max-height: none;
            height: calc(100vh - 200px);
        }

        .quick-filters {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px;
            margin-bottom: 16px;
            -webkit-overflow-scrolling: touch;
        }
        .filter-chip {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.2s;
        }
        .filter-chip:hover, .filter-chip.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Recommendations Tab */
        .rec-categories {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 4px;
            margin-bottom: 16px;
        }
        .rec-category {
            background: var(--surface);
            border: 1px solid var(--glass-border);
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .rec-category:hover, .rec-category.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        .rec-history {
            margin-top: 24px;
        }
        .rec-history-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .rec-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }
        .rec-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }
        .rec-reason {
            font-size: 12px;
            color: var(--primary);
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Library Tab */
        .library-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
        }
        .library-tab {
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
            color: var(--text-secondary);
        }
        .library-tab:hover, .library-tab.active {
            background: var(--surface);
            color: var(--text);
        }
        .collection-card {
            background: linear-gradient(135deg, var(--surface), var(--glass-bg));
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid var(--glass-border);
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }
        .collection-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .collection-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        .collection-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .collection-count {
            font-size: 13px;
            opacity: 0.7;
        }
        .library-search {
            width: 100%;
            background: var(--surface);
            border: 1px solid var(--glass-border);
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text);
            font-size: 14px;
            margin-bottom: 16px;
        }
        .library-search:focus {
            outline: none;
            border-color: var(--primary);
        }
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }
        .tag {
            background: rgba(102, 126, 234, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Comments Tab - Enhanced */
        .reaction-bar {
            display: flex;
            gap: 8px;
            padding: 8px 0;
            border-top: 1px solid var(--glass-border);
            margin-top: 8px;
        }
        .reaction-btn {
            background: var(--surface);
            border: none;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .reaction-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }
        .reaction-btn.active {
            background: var(--primary);
        }
        .reply-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 6px;
        }
        .reply-btn:hover {
            color: var(--primary);
            background: var(--surface);
        }
        .comment-replies {
            margin-left: 36px;
            margin-top: 12px;
            padding-left: 16px;
            border-left: 2px solid var(--glass-border);
        }
        .reply-input-area {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            padding: 12px;
            background: var(--surface);
            border-radius: 12px;
        }
        .emoji-picker {
            display: flex;
            gap: 6px;
            padding: 8px;
            overflow-x: auto;
            background: var(--surface);
            border-radius: 20px;
            margin-bottom: 8px;
        }
        .emoji-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            transition: transform 0.2s;
        }
        .emoji-btn:hover {
            transform: scale(1.2);
            background: var(--glass-bg);
        }
        .mention {
            color: var(--primary);
            font-weight: 600;
            background: rgba(102, 126, 234, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }
        .online-users {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: var(--surface);
            border-radius: 12px;
            margin-bottom: 16px;
        }
        .online-avatars {
            display: flex;
        }
        .online-avatar-wrap {
            width: 32px;
            height: 32px;
            margin-left: -8px;
        }
        .online-avatar-wrap:first-child {
            margin-left: 0;
        }
        .online-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--bg);
            object-fit: cover;
        }
        .online-count {
            font-size: 13px;
            font-weight: 600;
            color: var(--success);
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }
        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .trending-tag {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 15px;
        }

        /* Loading Animation */
        .skeleton {
            background: linear-gradient(90deg, var(--surface) 25%, var(--glass-bg) 50%, var(--surface) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .comment-input::-webkit-scrollbar {
            display: none;
        }
        * {
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.24) transparent;
        }
        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        *::-webkit-scrollbar-track {
            background: transparent;
        }
        *::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.24);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        *::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.35);
            border: 2px solid transparent;
            background-clip: content-box;
        }

        html[data-theme="light"] * {
            scrollbar-color: rgba(15,23,42,0.24) transparent;
        }
        html[data-theme="light"] *::-webkit-scrollbar-thumb {
            background: rgba(15,23,42,0.2);
            border: 2px solid transparent;
            background-clip: content-box;
        }
        html[data-theme="light"] *::-webkit-scrollbar-thumb:hover {
            background: rgba(15,23,42,0.3);
            border: 2px solid transparent;
            background-clip: content-box;
        }

        /* Utility */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 8px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-4 { margin-bottom: 16px; }
        
        /* ===== SHOP STYLES ===== */
        .shop-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .shop-title { font-size: 28px; font-weight: 700; margin: 0; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .shop-xp-display { display: flex; align-items: center; gap: 12px; background: var(--surface); padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border); }
        .shop-xp-icon { font-size: 20px; }
        #shopXpAmount { font-weight: 700; font-size: 18px; color: var(--primary); }
        .shop-level { font-size: 12px; color: var(--text-secondary); background: var(--glass); padding: 4px 10px; border-radius: 20px; }
        
        .shop-categories { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; overflow-x: auto; padding-bottom: 8px; }
        .shop-category-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border); background: var(--surface); color: var(--text-secondary); font-size: 13px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .shop-category-btn:hover { background: var(--glass); border-color: var(--primary); color: var(--text-primary); }
        .shop-category-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .shop-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .shop-tab-btn { padding: 12px 24px; background: transparent; border: none; color: var(--text-secondary); font-size: 15px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .shop-tab-btn:hover { color: var(--text-primary); }
        .shop-tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
        
        .shop-content { min-height: 400px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        @media (min-width: 768px) { .shop-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); } }
        
        .shop-item { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 16px; text-align: center; transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
        .shop-item:hover { transform: translateY(-4px); box-shadow: 0 12px 32px var(--shadow); border-color: var(--primary); }
        .shop-item.owned { border-color: var(--success); opacity: 0.7; }
        .shop-item.equipped { border-color: var(--primary); box-shadow: 0 0 20px var(--primary-glow); }
        .shop-item.legendary { border-color: #FFD700; background: linear-gradient(135deg, rgba(255,215,0,0.1), var(--surface)); }
        .shop-item.epic { border-color: #BF5AF2; background: linear-gradient(135deg, rgba(191,90,242,0.1), var(--surface)); }
        .shop-item.rare { border-color: #0A84FF; background: linear-gradient(135deg, rgba(10,132,255,0.1), var(--surface)); }
        .shop-item.mythic { border-color: #FF1493; background: linear-gradient(135deg, rgba(255,20,147,0.15), var(--surface)); box-shadow: 0 0 30px rgba(255,20,147,0.2); }
        
        .shop-item-icon { font-size: 48px; margin-bottom: 12px; display: block; }
        .shop-item-name { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: var(--text-primary); }
        .shop-item-desc { font-size: 11px; color: var(--text-secondary); margin-bottom: 12px; line-height: 1.4; }
        .shop-item-rarity { font-size: 10px; text-transform: uppercase; letter-spacing: 0.5px; padding: 3px 8px; border-radius: 10px; display: inline-block; margin-bottom: 10px; }
        .shop-item-rarity.legendary { background: rgba(255,215,0,0.2); color: #FFD700; }
        .shop-item-rarity.epic { background: rgba(191,90,242,0.2); color: #BF5AF2; }
        .shop-item-rarity.rare { background: rgba(10,132,255,0.2); color: #0A84FF; }
        .shop-item-rarity.common { background: rgba(142,142,147,0.2); color: var(--text-secondary); }
        .shop-item-rarity.mythic { background: linear-gradient(135deg, rgba(255,20,147,0.3), rgba(138,43,226,0.3)); color: #FF1493; font-weight: 700; animation: mythicPulse 2s infinite; }
        
        .shop-item-price { display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 700; color: var(--primary); font-size: 16px; margin-bottom: 10px; }
        .shop-item-price.owned { color: var(--success); }
        
        .shop-item-btn { width: 100%; padding: 10px; border-radius: 10px; border: none; background: var(--primary); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .shop-item-btn:hover:not(:disabled) { background: var(--secondary); transform: scale(1.02); }
        .shop-item-btn:disabled { background: var(--surface); color: var(--text-secondary); cursor: not-allowed; }
        .shop-item-btn.equip { background: var(--success); }
        .shop-item-btn.equip:hover { background: #2eb872; }
        .shop-item-btn.unequip { background: var(--warning); }
        
        .shop-empty { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .shop-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
        
        /* Inventory specific */
        .inventory-categories { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; overflow-x: auto; padding-bottom: 8px; }
        
        /* Achievements */
        .achievements-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .achievements-stats { background: var(--surface); padding: 12px 20px; border-radius: 50px; border: 1px solid var(--border); font-weight: 700; color: var(--primary); display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
        .achievement-xp-total { color: var(--success); }
        .achievement-categories { display: flex; gap: 8px; margin: 20px 0; flex-wrap: wrap; overflow-x: auto; padding-bottom: 8px; }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        @media (max-width: 768px) {
            .achievements-grid { grid-template-columns: 1fr; gap: 16px; }
            .achievement-categories { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        }
        .achievement-item { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; display: flex; align-items: flex-start; gap: 16px; transition: all 0.2s; cursor: pointer; position: relative; }
        .achievement-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
        .achievement-item.completed { background: linear-gradient(135deg, rgba(48,209,88,0.1), var(--surface)); border-color: var(--success); }
        .achievement-item.completed:hover { border-color: var(--success); box-shadow: 0 8px 24px rgba(48,209,88,0.2); }
        .achievement-icon { font-size: 40px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: var(--glass); border-radius: 12px; flex-shrink: 0; }
        .achievement-item.completed .achievement-icon { background: rgba(48,209,88,0.2); }
        .achievement-content { flex: 1; min-width: 0; }
        .achievement-name { font-weight: 700; font-size: 16px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .achievement-desc { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .achievement-reward { display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--primary); font-weight: 600; }
        .achievement-progress { margin-top: 8px; }
        .achievement-progress-bar { height: 6px; background: var(--glass); border-radius: 3px; overflow: hidden; }
        .achievement-progress-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.3s; }
        .achievement-progress-text { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .achievement-item.completed .achievement-progress-fill { background: var(--success); }
        .achievement-category-tag { font-size: 11px; padding: 2px 8px; border-radius: 10px; background: var(--glass); color: var(--text-secondary); font-weight: 500; }
        /* Mobile click-to-expand progress */
        .achievement-detail-panel { 
            position: absolute; 
            bottom: 100%; 
            left: 50%; 
            transform: translateX(-50%) scale(0.95); 
            background: var(--surface); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 16px; 
            min-width: 280px; 
            max-width: 320px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            z-index: 1000; 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.2s ease; 
            margin-bottom: 8px;
        }
        .achievement-detail-panel.visible { opacity: 1; pointer-events: auto; transform: translateX(-50%) scale(1); }
        .achievement-detail-panel::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: var(--surface);
        }
        @media (max-width: 768px) {
            .achievement-detail-panel { 
                position: fixed; 
                top: 50%; 
                left: 50%; 
                bottom: auto;
                transform: translate(-50%, -50%) scale(0.95); 
                margin: 0;
                width: 90%;
                max-width: 350px;
            }
            .achievement-detail-panel.visible { transform: translate(-50%, -50%) scale(1); }
            .achievement-detail-panel::after { display: none; }
            .achievement-detail-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s;
            }
            .achievement-detail-overlay.visible { opacity: 1; pointer-events: auto; }
        }
        
        /* XP Guide */
        .xp-guide-container { padding: 20px; max-width: 1200px; margin: 0 auto; }
        .xp-guide-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
        .xp-guide-category { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 20px; }
        .xp-guide-category-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
        .xp-guide-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--glass); }
        .xp-guide-item:last-child { border-bottom: none; }
        .xp-guide-action { display: flex; align-items: center; gap: 10px; }
        .xp-guide-icon { font-size: 20px; }
        .xp-guide-text { font-size: 14px; }
        .xp-guide-amount { font-weight: 700; color: var(--primary); font-size: 14px; }
        .xp-guide-bonus { font-size: 11px; color: var(--text-secondary); }
        .xp-guide-daily { background: linear-gradient(135deg, rgba(255,159,10,0.1), var(--surface)); border-color: rgba(255,159,10,0.3); }
        .xp-guide-social { background: linear-gradient(135deg, rgba(10,132,255,0.1), var(--surface)); border-color: rgba(10,132,255,0.3); }
        .xp-guide-study { background: linear-gradient(135deg, rgba(48,209,88,0.1), var(--surface)); border-color: rgba(48,209,88,0.3); }
        .xp-guide-special { background: linear-gradient(135deg, rgba(191,90,242,0.1), var(--surface)); border-color: rgba(191,90,242,0.3); }
        
        /* Profile customization display */
        .profile-frame { position: absolute; inset: -8px; border-radius: 50%; pointer-events: none; }
        .profile-frame.gold { border: 3px solid #FFD700; box-shadow: 0 0 20px rgba(255,215,0,0.5); animation: goldPulse 2s ease-in-out infinite; }
        .profile-frame.silver { border: 3px solid #C0C0C0; box-shadow: 0 0 15px rgba(192,192,192,0.4); }
        .profile-frame.bronze { border: 3px solid #CD7F32; box-shadow: 0 0 12px rgba(205,127,50,0.4); }
        .profile-frame.angel { border: 2px solid transparent; }
        .profile-frame.angel::before { content: ''; position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 28px; animation: angelFloat 3s ease-in-out infinite; filter: drop-shadow(0 0 8px rgba(255,255,255,0.6)); }
        .profile-frame.angel::after { content: ''; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%) scaleY(-1); font-size: 28px; animation: angelFloat 3s ease-in-out infinite 0.5s; filter: drop-shadow(0 0 8px rgba(255,255,255,0.6)); }
        .profile-frame.cross { border: 3px solid #8B4513; box-shadow: 0 0 15px rgba(139,69,19,0.4); }
        .profile-frame.cross::before { content: ''; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); font-size: 20px; filter: drop-shadow(0 0 5px rgba(255,215,0,0.8)); }
        .profile-frame.heart { border: 3px solid #FF69B4; box-shadow: 0 0 15px rgba(255,105,180,0.5); animation: heartBeat 1.5s ease-in-out infinite; }
        .profile-frame.fire { border: 3px solid transparent; background: linear-gradient(135deg, #FF4500, #FFD700) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: fireFlicker 0.5s ease-in-out infinite alternate; }
        .profile-frame.ice { border: 3px solid #00CED1; box-shadow: 0 0 15px rgba(0,206,209,0.5), inset 0 0 10px rgba(0,206,209,0.2); animation: iceGlow 2s ease-in-out infinite alternate; }
        .profile-frame.nature { border: 3px solid #228B22; box-shadow: 0 0 15px rgba(34,139,34,0.4); }
        .profile-frame.nature::before { content: ''; position: absolute; top: -10px; left: -10px; font-size: 18px; animation: leafSway 2s ease-in-out infinite; }
        .profile-frame.nature::after { content: ''; position: absolute; bottom: -10px; right: -10px; font-size: 18px; animation: leafSway 2s ease-in-out infinite 1s; }
        .profile-frame.stars { border: 3px solid transparent; background: linear-gradient(135deg, #FFD700, #FF69B4, #00CED1) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: starTwinkle 1s ease-in-out infinite; }
        
        /* Name Colors */
        .user-name.gold { color: #FFD700 !important; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        .user-name.rainbow { background: linear-gradient(90deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s linear infinite; }
        .user-name.blue { color: #0A84FF !important; text-shadow: 0 0 8px rgba(10,132,255,0.4); }
        .user-name.red { color: #FF375F !important; text-shadow: 0 0 8px rgba(255,55,95,0.4); }
        .user-name.purple { color: #BF5AF2 !important; text-shadow: 0 0 8px rgba(191,90,242,0.4); }
        .user-name.green { color: #30D158 !important; text-shadow: 0 0 8px rgba(48,209,88,0.4); }
        .user-name.neon { color: #39FF14 !important; text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14; animation: neonPulse 1s ease-in-out infinite alternate; }
        .user-name.pink { color: #FF69B4 !important; }
        
        /* Titles */
        .user-title { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; padding: 2px 8px; border-radius: 10px; margin-right: 6px; display: inline-flex; align-items: center; gap: 3px; flex-shrink: 0; white-space: nowrap; }
        .user-title.legendary { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; }
        .user-title.epic { background: linear-gradient(135deg, #BF5AF2, #9F5AF2); color: #fff; }
        .user-title.rare { background: linear-gradient(135deg, #0A84FF, #0077FF); color: #fff; }
        .user-title.common { background: rgba(142,142,147,0.3); color: var(--text-secondary); }
        
        /* Badges */
        .user-badges { display: inline-flex; gap: 3px; margin-left: 4px; vertical-align: middle; }
        .user-badge-small { width: 18px; height: 18px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* Chat Effects */
        .chat-message.sparkle { position: relative; }
        .chat-message.sparkle::before { content: ''; position: absolute; left: -20px; animation: sparkle 1s ease-in-out infinite; }
        .chat-message.rainbow-text { background: linear-gradient(90deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: rainbow 3s linear infinite; }
        .chat-message.glow { text-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; }
        .chat-message.fire-text { color: #FF4500; text-shadow: 0 0 10px #FF4500; animation: fireText 0.5s ease-in-out infinite alternate; }
        
        /* Profile Backgrounds */
        .profile-bg-golden { background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.2)) !important; }
        .profile-bg-night { background: linear-gradient(135deg, rgba(25,25,112,0.4), rgba(75,0,130,0.3)) !important; position: relative; overflow: hidden; }
        .profile-bg-night::before { content: ''; position: absolute; top: 10%; left: 10%; animation: starTwinkle 2s infinite; }
        .profile-bg-night::after { content: ''; position: absolute; bottom: 20%; right: 15%; animation: starTwinkle 3s infinite 1s; }
        .profile-bg-clouds { background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(200,220,255,0.2)) !important; }
        .profile-bg-nature { background: linear-gradient(135deg, rgba(34,139,34,0.3), rgba(144,238,144,0.2)) !important; }
        .profile-bg-ocean { background: linear-gradient(135deg, rgba(0,119,190,0.3), rgba(0,206,209,0.2)) !important; }
        .profile-bg-fire { background: linear-gradient(135deg, rgba(255,69,0,0.3), rgba(255,215,0,0.2)) !important; }
        
        /* Comment Avatar Frames */
        .comment-avatar-frame { position: absolute; inset: -4px; border-radius: 50%; pointer-events: none; }
        .comment-avatar-frame.gold { border: 2px solid #FFD700; box-shadow: 0 0 10px rgba(255,215,0,0.4); }
        .comment-avatar-frame.silver { border: 2px solid #C0C0C0; box-shadow: 0 0 8px rgba(192,192,192,0.3); }
        .comment-avatar-frame.bronze { border: 2px solid #CD7F32; box-shadow: 0 0 6px rgba(205,127,50,0.3); }
        .comment-avatar-frame.angel::before { content: ''; position: absolute; top: -12px; left: 50%; transform: translateX(-50%); font-size: 14px; }
        .comment-avatar-frame.cross::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 10px; }
        .comment-avatar-frame.heart { border: 2px solid #FF69B4; box-shadow: 0 0 8px rgba(255,105,180,0.4); }
        .comment-avatar-frame.fire { border: 2px solid #FF4500; box-shadow: 0 0 8px rgba(255,69,0,0.4); }
        .comment-avatar-frame.ice { border: 2px solid #00CED1; box-shadow: 0 0 8px rgba(0,206,209,0.4); }
        .comment-avatar-frame.nature { border: 2px solid #228B22; box-shadow: 0 0 8px rgba(34,139,34,0.3); }
        .comment-avatar-frame.stars { border: 2px solid transparent; background: linear-gradient(135deg, #FFD700, #FF69B4) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; }
        
        /* Animations */
        @keyframes rainbow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }
        @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes goldPulse { 0%, 100% { box-shadow: 0 0 20px rgba(255,215,0,0.5); } 50% { box-shadow: 0 0 30px rgba(255,215,0,0.8); } }
        @keyframes angelFloat { 0%, 100% { transform: translateX(-50%) translateY(0) rotate(0deg); } 50% { transform: translateX(-50%) translateY(-8px) rotate(5deg); } }
        @keyframes heartBeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes fireFlicker { 0% { opacity: 0.8; } 100% { opacity: 1; } }
        @keyframes iceGlow { 0% { box-shadow: 0 0 15px rgba(0,206,209,0.5); } 100% { box-shadow: 0 0 25px rgba(0,206,209,0.8); } }
        @keyframes leafSway { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
        @keyframes starTwinkle { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes neonPulse { 0% { text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14; } 100% { text-shadow: 0 0 20px #39FF14, 0 0 40px #39FF14; } }
        @keyframes sparkle { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
        @keyframes fireText { 0% { text-shadow: 0 0 10px #FF4500; } 100% { text-shadow: 0 0 20px #FF4500, 0 0 30px #FF4500; } }
        @keyframes mythicPulse { 0%, 100% { box-shadow: 0 0 10px rgba(255,20,147,0.4); } 50% { box-shadow: 0 0 25px rgba(255,20,147,0.7); } }
        @keyframes mythicShine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        /* Shop Item Effects - Profile Frames */
        .profile-frame { position: relative; }
        .profile-frame-frame_gold { border: 3px solid #FFD700 !important; box-shadow: 0 0 20px rgba(255,215,0,0.5), inset 0 0 10px rgba(255,215,0,0.2) !important; animation: goldPulse 2s infinite; }
        .profile-frame-frame_silver { border: 3px solid #C0C0C0 !important; box-shadow: 0 0 15px rgba(192,192,192,0.4) !important; }
        .profile-frame-frame_bronze { border: 3px solid #CD7F32 !important; box-shadow: 0 0 12px rgba(205,127,50,0.4) !important; }
        .profile-frame-frame_angel { border: 3px solid transparent !important; }
        .profile-frame-frame_angel::after { content: ''; position: absolute; top: -8px; right: -8px; font-size: 18px; animation: angelFloat 2s ease-in-out infinite; }
        .profile-frame-frame_cross { border: 3px solid #8B4513 !important; box-shadow: 0 0 15px rgba(139,69,19,0.4) !important; }
        .profile-frame-frame_cross::after { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); font-size: 16px; }
        .profile-frame-frame_heart { border: 3px solid #FF69B4 !important; }
        .profile-frame-frame_heart::after { content: ''; position: absolute; bottom: -6px; right: -6px; font-size: 16px; animation: heartBeat 1.5s infinite; }
        .profile-frame-frame_fire { border: 3px solid #FF4500 !important; box-shadow: 0 0 20px rgba(255,69,0,0.5) !important; animation: fireFlicker 1s infinite alternate; }
        .profile-frame-frame_ice { border: 3px solid #00CED1 !important; box-shadow: 0 0 20px rgba(0,206,209,0.5) !important; animation: iceGlow 2s infinite alternate; }
        .profile-frame-frame_nature { border: 3px solid #228B22 !important; box-shadow: 0 0 15px rgba(34,139,34,0.4) !important; }
        .profile-frame-frame_nature::after { content: ''; position: absolute; top: -6px; left: -6px; font-size: 16px; animation: leafSway 2s ease-in-out infinite; }
        .profile-frame-frame_stars { border: 2px solid transparent !important; background: linear-gradient(135deg, #FFD700, #FF69B4, #00CED1) border-box !important; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: starTwinkle 2s infinite; }
        .profile-frame-frame_wood { border: 3px solid #8B4513 !important; }
        .profile-frame-frame_stone { border: 3px solid #808080 !important; box-shadow: inset 0 0 10px rgba(128,128,128,0.3) !important; }
        /* Mythic Frames */
        .profile-frame-frame_divine { border: 3px solid transparent !important; background: linear-gradient(135deg, #FFD700, #FF1493, #00CED1) border-box !important; animation: mythicPulse 2s infinite; }
        .profile-frame-frame_divine::after { content: ''; position: absolute; top: -10px; right: -10px; font-size: 22px; animation: angelFloat 2s ease-in-out infinite; }
        .profile-frame-frame_cosmic { border: 3px solid #9400D3 !important; box-shadow: 0 0 30px rgba(148,0,211,0.6), inset 0 0 20px rgba(148,0,211,0.3) !important; animation: mythicPulse 1.5s infinite; }
        .profile-frame-frame_cosmic::after { content: ''; position: absolute; top: -8px; left: -8px; font-size: 20px; animation: starTwinkle 1s infinite; }
        .profile-frame-frame_infinity { border: 3px solid transparent !important; background: linear-gradient(135deg, #FF1493, #00FF87, #00CED1) border-box !important; animation: rainbow 3s linear infinite; box-shadow: 0 0 25px rgba(255,20,147,0.5) !important; }
        .profile-frame-frame_infinity::after { content: ''; position: absolute; bottom: -8px; right: -8px; font-size: 22px; }
        
        /* Shop Item Effects - Name Colors */
        .profile-name-color_rainbow { background: linear-gradient(90deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #4B0082, #9400D3) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: rainbow 3s linear infinite; font-weight: 700 !important; }
        .profile-name-color_gold { color: #FFD700 !important; text-shadow: 0 0 10px rgba(255,215,0,0.5) !important; font-weight: 700 !important; }
        .profile-name-color_silver { color: #C0C0C0 !important; text-shadow: 0 0 8px rgba(192,192,192,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_blue { color: #0A84FF !important; text-shadow: 0 0 10px rgba(10,132,255,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_red { color: #FF375F !important; text-shadow: 0 0 10px rgba(255,55,95,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_purple { color: #BF5AF2 !important; text-shadow: 0 0 10px rgba(191,90,242,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_green { color: #30D158 !important; text-shadow: 0 0 10px rgba(48,209,88,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_neon { color: #39FF14 !important; text-shadow: 0 0 10px #39FF14, 0 0 20px #39FF14 !important; animation: neonPulse 1.5s infinite alternate; font-weight: 700 !important; }
        .profile-name-color_pink { color: #FF69B4 !important; font-weight: 700 !important; }
        .profile-name-color_orange { color: #FF9500 !important; font-weight: 700 !important; }
        .profile-name-color_teal { color: #00CED1 !important; font-weight: 700 !important; }
        .profile-name-color_cyan { color: #00FFFF !important; text-shadow: 0 0 10px rgba(0,255,255,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_plasma { color: #FF00FF !important; text-shadow: 0 0 10px #FF00FF, 0 0 20px #FF00FF !important; animation: neonPulse 1.5s infinite alternate; font-weight: 700 !important; }
        .profile-name-color_aurora { background: linear-gradient(90deg, #00FF87, #60EFFF, #0061FF) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: rainbow 4s linear infinite; font-weight: 700 !important; }
        /* Mythic Name Colors */
        .profile-name-color_phoenix { background: linear-gradient(90deg, #FF0000, #FF6600, #FFCC00) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: fireText 1s infinite alternate; font-weight: 700 !important; }
        .profile-name-color_void { color: #1a0033 !important; text-shadow: 0 0 20px rgba(147,0,211,0.8), 0 0 40px rgba(147,0,211,0.4) !important; font-weight: 700 !important; }
        .profile-name-color_godly { background: linear-gradient(90deg, #FFD700, #FFFFFF, #FFD700, #FFFFFF) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: rainbow 2s linear infinite; font-weight: 700 !important; text-shadow: 0 0 30px rgba(255,215,0,0.5) !important; }
        
        /* Shop Item Effects - Titles */
        .user-title { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; padding: 2px 8px; border-radius: 12px; margin-left: 6px; font-weight: 600; vertical-align: middle; flex-shrink: 0; white-space: nowrap; }
        .user-title-legendary { background: linear-gradient(135deg, #FFD700, #FFA500); color: #000; box-shadow: 0 0 10px rgba(255,215,0,0.4); }
        .user-title-epic { background: linear-gradient(135deg, #9400D3, #FF00FF); color: #fff; }
        .user-title-rare { background: linear-gradient(135deg, #00BFFF, #1E90FF); color: #fff; }
        .user-title-common { background: linear-gradient(135deg, #808080, #A9A9A9); color: #fff; }
        .user-title-mythic { background: linear-gradient(135deg, #FF1493, #9400D3, #00CED1); color: #fff; box-shadow: 0 0 20px rgba(255,20,147,0.5); animation: mythicShine 3s linear infinite; }
        
        /* Shop Item Effects - Badges */
        .user-badge-icon { display: inline-flex; align-items: center; justify-content: center; margin-left: 4px; font-size: 14px; cursor: help; vertical-align: middle; flex-shrink: 0; min-width: 18px; min-height: 18px; }
        .user-title:empty, .user-badge-icon:empty { display: none !important; }
        
        /* Shop Item Effects - Chat Effects */
        .chat-effect-chat_sparkle { position: relative; }
        .chat-effect-chat_sparkle::before { content: ''; position: absolute; left: -20px; animation: sparkle 1.5s infinite; }
        .chat-effect-chat_rainbow { background: linear-gradient(90deg, #FF0000, #FF7F00, #FFFF00, #00FF00, #0000FF, #9400D3) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: rainbow 5s linear infinite; }
        .chat-effect-chat_glow { box-shadow: 0 0 20px rgba(255,215,0,0.3); border-radius: 8px; padding: 8px; background: rgba(255,215,0,0.05); }
        .chat-effect-chat_fire { color: #FF4500 !important; text-shadow: 0 0 15px #FF4500, 0 0 25px #FF6347 !important; animation: fireText 0.8s infinite alternate; }
        .chat-effect-chat_shadow { color: #666 !important; text-shadow: 2px 2px 4px rgba(0,0,0,0.8) !important; }
        .chat-effect-chat_ice { color: #00CED1 !important; text-shadow: 0 0 15px #00CED1, 0 0 25px #00FFFF !important; animation: iceGlow 1s infinite alternate; }
        .chat-effect-chat_gold { color: #FFD700 !important; text-shadow: 0 0 15px #FFD700 !important; animation: goldPulse 2s infinite; }
        /* Mythic Chat Effects */
        .chat-effect-chat_universe { background: linear-gradient(90deg, #9400D3, #00CED1, #FF1493) !important; -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important; animation: rainbow 3s linear infinite; font-weight: 700 !important; }
        .chat-effect-chat_godly { color: #FFD700 !important; text-shadow: 0 0 20px #FFD700, 0 0 40px #FF1493 !important; animation: mythicPulse 1s infinite; font-weight: 700 !important; }
    </style>
</head>
<body>
    <div class="ambient-bg">
        <div class="ambient-orb orb-1"></div>
        <div class="ambient-orb orb-2"></div>
        <div class="ambient-orb orb-3"></div>
    </div>
    
    <div class="particles"></div>

    <div class="app">
        <header class="header">
            <div class="brand" onclick="handleBrandClick()">
                <div class="brand-icon">
                    &#10010;
                    <span class="admin-badge" id="adminBadge">ADMIN</span>
                    <span class="role-badge" id="roleBadge"></span>
                </div>
                <div class="brand-copy">
                    <div class="brand-text">Bible AI</div>
                    <a class="mobile-donate-btn" href="https://buy.stripe.com/7sY00j7sh4Do6Plaap4ko0b" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()">
                        <span>&#128176;</span>
                        <span>Donate</span>
                    </a>
                </div>
            </div>
            
            <nav class="desktop-nav">
                <button class="nav-item active" onclick="switchTab('discover')" data-tab="discover">
                    <span class="nav-icon">&#10024;</span>
                    <span>Discover</span>
                </button>
                <button class="nav-item" onclick="switchTab('recommendations')" data-tab="recommendations">
                    <span class="nav-icon">&#127919;</span>
                    <span>For You</span>
                </button>
                <button class="nav-item" onclick="switchTab('library')" data-tab="library">
                    <span class="nav-icon">&#128218;</span>
                    <span>Library</span>
                </button>
                <button class="nav-item" onclick="switchTab('comments')" data-tab="comments">
                    <span class="nav-icon">&#128172;</span>
                    <span>Comments</span>
                </button>
                <button class="nav-item" onclick="switchTab('shop')" data-tab="shop">
                    <span class="nav-icon">&#128722;</span>
                    <span>Shop</span>
                </button>
                <button class="nav-item" onclick="switchTab('inventory')" data-tab="inventory">
                    <span class="nav-icon">&#127890;</span>
                    <span>My Items</span>
                </button>
                <button class="nav-item" onclick="switchTab('achievements')" data-tab="achievements">
                    <span class="nav-icon">&#127941;</span>
                    <span>Achievements</span>
                </button>
                <button class="nav-item" onclick="switchTab('xp-guide')" data-tab="xp-guide">
                    <span class="nav-icon">&#128161;</span>
                    <span>XP Guide</span>
                </button>
                <button class="nav-item" onclick="switchTab('profile')" data-tab="profile">
                    <span class="nav-icon">&#128100;</span>
                    <span>Profile</span>
                </button>
                <button class="nav-item" onclick="switchTab('about')" data-tab="about">
                    <span class="nav-icon">&#127909;</span>
                    <span>About Us</span>
                </button>
            </nav>

            <!-- Lovewell Church Credit -->
            <div class="lovewell-credit">
                <a href="https://www.crossforall.com" target="_blank" rel="noopener noreferrer" title="Visit Cross For All">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAD0AAAA/CAYAAABTqsDiAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAA3pSURBVGhD7Zt7lFXVfcc/v33OvfMCZoQqIVUYUHysRJhqDKbRAg1LwUeRlbSNhlho2q6smDqgoEGNw9RXXG2W8JextkGMia80SKqibXXEIFZWV5i0Vl086iBVYESYYR5wH2f/+sd53HPuY+bOMKbpqt+1Dnefvc/d+3z297d/55x7BvhE/z8kxRUftxpb25rzLs1r39zG5/L9zH/pjVeKj/m49bFBN7be2mxx5qnIXEGbETMPBEQ4r3s/Z/d2syTTy0T1UFWs0oXSpaJbPdXOhS/veKa4z7HSmEI3tt7arEqrqrlGjDSrBN2L+EOJcNbh9zm99zB11mOCl+fKfD9NAbgCqqAEZcszVti86OU3Hike62Q0JtCNN9w6zxppEyFysxzwaX1HmPHRAWq9PHXWo87zmGRzLPIGSQWoVknCK1joQe36Eza7bsnWX/UUjz9SnRS0D6ttgsyLw5UDrs8c5+xD+6j1POpsntoAutZ6nG6z/J5mfFgo67o/GdqD6knDjwq6sbW1Sb10G2JWQBKuHLBRy5kH3qUhnysLXWfzfFazzBQvAC0PHrZZtV1izfJFW0eXBE1xxXBq/NaqFptP76wWGGBi70cYa4MeNOwqoT3WIYNgxD8pI35ZBEQEQfwyYMQ0Y7TjuXkXPVDcTzUakdON3161TDEbClAMC5zOZZhy+P3AYY86z3e52Olaz2OKelzg2mgtDxXu/lpXVOnM2Mz8kYR71U433rB67UiBVYSGfv9cimc33JfAeQF6FI5p4GzoMqHT4X6hbBCMSEuNSe98du5FLYkBhlBV0BNuWL1BRdqqBg7qnXyOdPZEoq+GhgYunjMHgEsXLEi0AezPayG8RxDujpGOasGHhW68YdUKRJaNCDioqxnsS/Q1rqGev77rr5gxfToA31h5E19YcFlimR/zIKuhw4GzoeO+s8EkhE4HZZEmx5GOTXNnNxV6K68hoRu/vWqZinlgNMCiSipz3D9EfeD1a9s4s7k5PgTX37yKOZddnqg7lLPJkK4+3JtqndqOjmHAK0I3fmtVi9UqgGNbCAyCyWUR9TP2+IZ6fnDnd5kZB465+9VVt3DhZQv9IYDevI2FeCy8y4S7H/KFcDfQkjE1Q2b1itDWmA1ipGlY4LA+rAv2ncDlCfX1/P13b+fs5mmx3ksvW1++5TvMvnwRAFlVcqrBEFLqbOg4fltJuBtZ9sLvf/6a4jFClYUef8PqtSLSEgGHTlYJjIDkc0yor+ex27/DudOmFo1QXn9w622cv/AKAAbyGkH4p5AMdxOGfHFbFO6yoVKYl0A3tt7ajJjWBDAhcAg1NDAIjWmXp267hfOqBA61cM0dnLfoKo5bG0EkQjo4aYk7WybcDdKUd2vbivunHLRabRORpvLAScBSYL8suQwAb+17r7j7SFJcEdP0S+dywrNJ96Ihqg93QVZ0zJ2TzJzF0IHLy0YP7N+QgHBscJCbHv4hS+/5XnyIYfXoN67n+dtWQ9zZ0NWYs9WGe96VErcT0Kq0wskDi5eL+tzx9jv0DQ5G+wWVJrNd235B957dAAzkvAJA4pIVZemqwt0RlnXMnZtY28XQ0U1IOWCNA8c2jQEjAtHDha939u1L7FfSoQA4VAQXQETOjjDcvVRmWbzfCHpc65prxJimoYAhBlzR9XDfL5YxtGr5IVuAGG24G/iTRL9RQXXxmAAjqEkEUImC3ioqbI8g4u6NItwdkZaOywsJLTo7xcyrDByOkARurK/joT+8OgksgqZqwm7LW12mqlgT0k7CWUGomTyFSQsWJQATkyKxSSlqMyrRzYohzNpGmisDF+riwFv+Yilfu3AWSy+cVTg+PG4MFDkbgE9csIipK9YwccGiqK1SuCdygH/dnh32awA8Ui2RWyMAnjVlMgD3X7WA+69awKUzpnLp9Klccs5ZfPHcs/nCuefw+bNn8ulJvxVDgWwuR9/AQKIOYPzkyWTyHp5VxrlO4DDUzZjJ5GuXM/laPx9NXbGGSTHwcuHuT1Qh3EHmheMIwPiVt6+FwvPySIBHo8cefZQnH9nAP77cUdw0Iu1fdx9H/mWLf/XA/4XF+lehkt/VVJUvvrhdKKxpM/vXBTyWOiMM9eh0hw73bVf8bguxRFbxUvWbChzqjBVrmPilJHilcHc8aSKRvf8PAoeKg4druDjzixSOF4BxN93ZgZh5JcDBkY11dcz69OTCpKjiHu1G1H8SckQxwRYv5/qyyPE8abWkrCWlHmmrHDnwAT0HPuCCWeeTtkpKPVJWSVuPlFpmnlZHnSMYC47if1owqhjrn0LKGNImuBsE8v19HH93T+LNSLiWw7WN1fkXvfjaKz70qrUdQMW3FNNOaeJrF86K9p3+XlCLoMFM+pAi+J9Bvc1Z7GAeVy2OavT51s6dvNO5k69ffz2uKo5a3KA9LfCpU9IYBbFg1N9EA+igLIBrBEcEVch2H+ToS0FSKwYP4UXnX/RcBN3ewTDvoX7wlStZesH5fv1Jaqyydyg70M++21cETpdm7RDcw86/6LnXXgkuYcE/FYABvvnUz3l82+uxoX4zlB/oZ9eaG8l07QlWZ/ymJNgPVqUbfMcAqNA1FDCqpI8cpHXDD3lq+/ZwvJNS0PNJKT/Qz69u/0s++q9dZK2/pEwEXnorimoPUfZWs68SsIqQ7jtM2p4gZZRVG/+Of3h9W2zopH659y127n2Lzr3/Wdw0psoN9LNj7Y0cfW8PWVfoweIFwEaCa3XRdft3nt/eSei4RTtNBJoEdjMD1JzoxTF+ZnaNsuZHD2NEWXLxpQA8u+NVHn7xp3T3dOOI4hgbfPrfeeHenyVOuNITx/Z/2sjbb7zAwOGDOFZxPairHcepv30Wn/nSV5jacgkAucF+tt1zI/379+C6grWK9eCoWk7FCRiCRS0CfhLrDMcxANakOhPAQaiLKg19B0kZG22usbhGafvJQ/x8x6scOPIh6zZv5MOeQ0GbJWU08Z1q9e67nRw+dpCcCzlXyLrCQLaf/Xs7+ecH7+Dgrk6yg/289L1WDv/3XnIuZF3IOkLOFQYd5ZjYwh1Z7G7MEUlCZ+5f0wX+uib2nFx7/Cgp8riOBjBJ+Lsef5C7n3iQE5l+Uk4A6oQTE05A9dD54OSzjpBzCKAK5X977hG2fH8F3R/s8WFdIedIBJ9zhaOOn60Lazl6tNwajhO7IzPPxIFFLQ0nPoqBKm4AFO6njOXf332zBDLe7paBNi5ImEpjyjskYV1/3y8L7+3t5OCBPeSCfb/Nh805kHUg48JRp+g3cwQM0Qv8CBpxNmpsXddneklLrjxI5GYyjFPGjwg3OCZllJRTCj1xhsPMK8cXV5OPAeZiYRuFcdDmh3QAmyj7bR+mLDa4XAVJrfO8zVu7wnEi6MF7b+lE6ArX9YTMhwm3Sp0MQ7l8BBS+V5q0Jk6eQPP5pxZXkzexUI2HrVMUxkUhHcL6kSGccOGYq9F1W1XXx8cpOO3n1I2IkPZOUEPGBwnXagRSur6LIyAOPuNT/mvZhFRRWzoZ06fPToRtwtl4GEdlCVwOEl8wGTlXOJIK3oVBTxoSf5OWgE676XWq2tOQ7y1xyw9X391EGJdMQAivTKiv50+vvjk+BIS3iFoKPeezl5OqGxe5l4vWePkwjmDdAnw2aOuuUax/nV4/ffPWxJ9mJKB721f2YJz147xjJZedOGjc3cTExI7/3DkXs37lzzjjtDPjQwDBw0AZpyc1Tuaubz7Gokuuj2Ajl8PMHiS3nOPDhsmuXNsRV3uwdl3xOAlogLQx6846pa+nLl3OydgaD9z0nS+0j2twmHL6eAZSe3jr/Qp3bgq2jNMAxhiOsJsp0ybRMKkeL+0EEEln/bKf7Mq1ZSamebs5XeIy/t1Iqf5my9JlRs2G3j7LkV6PfF7p7csFz8mF52dHlNoaobbGMG58mro6F8dJzuNls/6Mz5zu37mFen33Jl7fvYmbrng0UZ/JDfL0G/fRfSz5RiR7PEf2eA6b9cgdy8Ses/3na8eCU+PgpF1kXIp0Q5pMveladdVjZRJKBWiA7z/79U1AxRfb5X0qr4Wz/zwB/vquTWzfvYmbryxAZ3KDPPmv9/LhsTJvOitExVBSdP7qq39c9o/rSsI7lMmZ5Z7aHqtKyWb9NVnttmXn3/Lm/l9EfRev6UxukCe330N3z76S76oNfgwYyWa1vRIwQ0GvXLKxB9H5JSdg1X8wH+G2ZedDvPneq1CUvTO5QZ547R4O9e4r+Y5qmbGH3ewzqxf/eG0RTkIVoQFuueonnVhdXnIiI92CE3r+lw/xH++9Cr4bZHKDPL7tbg71dJU5eT+iSqJsiM2ztjOlqeXFHMWquKbjum/TdctEdUNxfbUqXpGTG6dxqHdf9FlWxV8aTqqdJ5ya+e1LNpZk62JVBQ1w30+vW6ZiRw4+0pMflbQz49RWBcxIoAHufuq6FsHrQCj7Vzv/O9JHsm5mZfuSzVUBM1JogLZNi5tS2ZpNSOGFWEWN4lJTtZQeoP2Orz5Vcsc1nEYMHeruJ/5ohSptY+26/xPA0FJ4xapZ3n7tk9Hj4kg0amiAtg2Lm0xN6gERSfxNB4xuLQ8LrNolatrvXPr0Sf1HlpOCDtX2+B83i823CXIN0DTMqY9C2qlq1refJGyoMYEO1bZhcRMp5xpVWSxD3MJWI4UulGfEmI3tS5+OftQbC40pdLHafvTledbaeQLTFJoRaRFKc4BCZ/BD/FYV6XI875X25ZtHtV4/0Scq6H8A/u+ySgZWwz4AAAAASUVORK5CYII=" 
                         alt="Lovewell Church" 
                         class="lovewell-logo"
                         id="lovewellLogo">
                </a>
                <div class="lovewell-credit-text">Credit To Cross Community Lovewell for more info check out the About us Or Click the logo thanks for your support!</div>
                <a class="lovewell-donate-btn" href="https://buy.stripe.com/7sY00j7sh4Do6Plaap4ko0b" target="_blank" rel="noopener noreferrer">
                    <span>&#128176;</span>
                    <span>Donate Securely</span>
                </a>
            </div>

            <div class="header-actions">
                <button class="icon-btn" onclick="openSettings()" title="Settings">&#9881;</button>
                <button class="icon-btn" onclick="toggleFullscreen()" title="Fullscreen">&#9974;</button>
                <button class="icon-btn" onclick="showUser()" title="Profile">
                    <span class="avatar-wrap" id="headerAvatarWrap">
                        <img id="headerAvatarImg" src="{{ user.picture }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.src='https://ui-avatars.com/api/?name={{ user.name }}&background=0a84ff&color=fff'">
                        <img id="headerAvatarDecor" class="avatar-decor hidden" alt="">
                    </span>
                </button>
            </div>
        </header>

        <main class="content">
            <!-- DISCOVER TAB -->
            <div id="discover" class="tab-view active desktop-active">
                <!-- Daily Challenge -->
                <div class="daily-challenge" id="dailyChallenge" style="display: none;">
                    <div class="challenge-title"> Daily Challenge</div>
                    <div class="challenge-text" id="challengeText">Save 2 verses to your library</div>
                    <div class="challenge-progress" id="challengeProgressBar">
                        <div class="challenge-fill" id="challengeFill" style="width: 0%"></div>
                    </div>
                    <div class="challenge-progress-text" id="challengeProgressText" style="text-align: right; font-size: 12px; margin-top: 6px; opacity: 0.8;">
                        <span id="challengeProgress">0</span>/<span id="challengeGoal">2</span>
                    </div>
                    <div class="challenge-cooldown" id="challengeCooldown" style="display: none; font-size: 12px; margin-top: 8px; opacity: 0.75;">
                        Next challenge in 60m
                    </div>
                </div>

                <div class="glass-card notice-card" id="announcementCard">
                    <div class="notice-header">
                        <div class="notice-title"> Announcements</div>
                        <button class="bible-picks-btn secondary" type="button" onclick="markNotificationsRead()">Mark read</button>
                    </div>
                    <div class="notice-list" id="announcementList">
                        <div class="notice-empty">No announcements yet.</div>
                    </div>
                </div>

                <div class="glass-card bible-picks-card">
                    <div class="bible-picks-header">
                        <div class="bible-picks-title"> Popular Bible Selections</div>
                        <div class="bible-picks-controls">
                            <button class="bible-picks-btn secondary" type="button" onclick="loadBiblePicks(true)">Refresh</button>
                        </div>
                    </div>
                    <div class="bible-picks-meta" id="biblePickMeta">OpenAI suggests popular Bible chapters and short ranges.</div>
                    <div class="bible-picks-row">
                        <select class="bible-picks-select" id="biblePickSelect" onchange="onBiblePickSelect()">
                            <option value="">Select a popular reading...</option>
                        </select>
                    </div>
                    <div class="bible-reader-card">
                        <div class="bible-reader-header">
                            <div class="bible-reader-title"> Ebook Reader</div>
                            <div class="bible-reader-current" id="readerCurrentChapter">Chapter: </div>
                        </div>
                        <div class="bible-reader-controls">
                            <select class="bible-reader-select" id="readerBookSelect"></select>
                            <input class="bible-reader-input" id="readerChapterInput" type="number" min="1" value="1">
                            <button class="bible-reader-btn" type="button" onclick="loadBibleChapter()">Load</button>
                            <button class="bible-reader-btn secondary" type="button" onclick="prevBibleChapter()">Prev</button>
                            <button class="bible-reader-btn secondary" type="button" onclick="nextBibleChapter()">Next</button>
                        </div>
                    <div class="bible-reader-meta" id="readerMeta">Select a book and chapter to begin reading.</div>
                    <div class="bible-reader-pagination">
                        <button class="bible-reader-btn secondary" type="button" onclick="prevReaderPage()">Prev Page</button>
                        <div class="bible-reader-page" id="readerPageIndicator">Page 0/0</div>
                        <button class="bible-reader-btn secondary" type="button" onclick="nextReaderPage()">Next Page</button>
                        <button class="bible-reader-btn" type="button" onclick="toggleReaderFullscreen()">Full Screen</button>
                    </div>
                    <div class="bible-reader-content" id="readerContent">Waiting for selection.</div>
                </div>
                </div>

                <!-- Quick Filters -->
                <div class="quick-filters">
                    <div class="filter-chip active" onclick="filterDiscover('all')"> All</div>
                    <div class="filter-chip" onclick="filterDiscover('liked')"> Liked</div>
                    <div class="filter-chip" onclick="filterDiscover('saved')"> Saved</div>
                    <div class="filter-chip" onclick="filterDiscover('popular')"> Popular</div>
                    <div class="filter-chip" onclick="filterDiscover('recent')"> Recent</div>
                </div>

                <div class="glass-card verse-container" onclick="toggleFullscreen()">
                    <div class="verse-text" id="verseText">
                        <div class="skeleton" style="height: 32px; margin-bottom: 12px; width: 100%;"></div>
                        <div class="skeleton" style="height: 32px; margin-bottom: 12px; width: 90%;"></div>
                        <div class="skeleton" style="height: 32px; width: 70%;"></div>
                    </div>
                    <div class="verse-meta">
                        <div class="verse-ref" id="verseRef">Loading...</div>
                        <div class="verse-source-wrapper">
                            <span class="signed-by">-Signed By George-</span>
                            <span class="verse-badge" id="verseSource">...</span>
                        </div>
                    </div>
                </div>

                <div class="glass-card">
                    <div class="action-grid">
                        <button class="action-btn" onclick="toggleLike()">
                            <span class="action-icon" id="likeIcon">&#9825;</span>
                            <span>Like</span>
                        </button>
                        <button class="action-btn" onclick="toggleSave()">
                            <span class="action-icon" id="saveIcon">&#128278;</span>
                            <span>Save</span>
                        </button>
                        <button class="action-btn" onclick="copyVerse()">
                            <span class="action-icon">&#128203;</span>
                            <span>Copy</span>
                        </button>
                        <button class="action-btn" onclick="shareVerse()">
                            <span class="action-icon">&#128228;</span>
                            <span>Share</span>
                        </button>
                    </div>

                    <div class="timer-wrapper">
                        <div class="timer-bar">
                            <div class="timer-progress" id="timerBar" style="width: 100%"></div>
                        </div>
                        <div class="timer-text">
                            <span>Next Verse</span>
                            <span id="timerText">01:00</span>
                        </div>
                    </div>
                </div>

                <!-- Verse of the Day -->
                <div class="glass-card" id="verseOfDayCard" style="margin-top: 16px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="font-size: 14px; font-weight: 700; color: var(--primary);"> Verse of the Day</div>
                        <div style="font-size: 12px; opacity: 0.6;" id="vodDate">Today</div>
                    </div>
                    <div id="verseOfDayContent" style="font-style: italic; opacity: 0.9;">Loading...</div>
                    <div id="verseOfDayRef" style="margin-top: 8px; font-size: 13px; font-weight: 600; color: var(--primary);"></div>
                </div>

            </div>

            <!-- RECOMMENDATIONS TAB -->
            <div id="recommendations" class="tab-view">
                <!-- Smart Categories -->
                <div class="rec-categories">
                    <div class="rec-category active" onclick="filterRecs('all')"> All</div>
                    <div class="rec-category" onclick="filterRecs('favorites')"> Favorites</div>
                    <div class="rec-category" onclick="filterRecs('trending')"> Trending</div>
                    <div class="rec-category" onclick="filterRecs('similar')"> Similar</div>
                    <div class="rec-category" onclick="filterRecs('random')"> Surprise</div>
                </div>

                <!-- Mood Selector -->
                <div class="glass-card" style="margin-bottom: 16px;">
                    <div style="font-size: 14px; font-weight: 700; margin-bottom: 12px;"> How are you feeling?</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <button class="filter-chip" onclick="getMoodVerse('peace')"> Peaceful</button>
                        <button class="filter-chip" onclick="getMoodVerse('strength')"> Need Strength</button>
                        <button class="filter-chip" onclick="getMoodVerse('hope')"> Hopeful</button>
                        <button class="filter-chip" onclick="getMoodVerse('love')"> Loved</button>
                        <button class="filter-chip" onclick="getMoodVerse('gratitude')"> Grateful</button>
                        <button class="filter-chip" onclick="getMoodVerse('guidance')"> Need Guidance</button>
                    </div>
                </div>

                <div class="glass-card">
                    <button class="gen-btn" onclick="generateRec()">
                        <span>&#128276;</span>
                        <span>Generate Smart Recommendation</span>
                    </button>
                    
                    <div id="recList"></div>
                </div>

                <!-- Recommendation History -->
                <div class="rec-history">
                    <div class="rec-history-title">
                         Your Journey
                        <span style="font-size: 12px; opacity: 0.6; font-weight: 400;">Recent recommendations</span>
                    </div>
                    <div id="recHistoryList"></div>
                </div>
            </div>

            <!-- LIBRARY TAB - Enhanced -->
            <div id="library" class="tab-view">
                <!-- Library Tabs -->
                <div class="library-tabs">
                    <button class="library-tab active" onclick="switchLibraryTab('all')"> All</button>
                    <button class="library-tab" onclick="switchLibraryTab('collections')"> Collections</button>
                    <button class="library-tab" onclick="switchLibraryTab('favorites')"> Favorites</button>
                </div>

                <!-- Search & Filter -->
                <input type="text" class="library-search" id="librarySearch" placeholder=" Search your verses..." onkeyup="searchLibrary()">

                <!-- Collections View -->
                <div id="collectionsView" style="display: none;">
                    <div class="collection-card" onclick="showCollection('favorites')">
                        <div class="collection-icon"></div>
                        <div class="collection-name">Favorites</div>
                        <div class="collection-count" id="favoritesCount">0 verses</div>
                    </div>
                    <div class="collection-card" onclick="showCollection('liked')">
                        <div class="collection-icon"></div>
                        <div class="collection-name">Liked Verses</div>
                        <div class="collection-count" id="likedCount">0 verses</div>
                    </div>
                    <div class="collection-card" onclick="showCollection('saved')">
                        <div class="collection-icon"></div>
                        <div class="collection-name">Saved</div>
                        <div class="collection-count" id="savedCount">0 verses</div>
                    </div>
                    <div class="collection-card" onclick="createNewCollection()">
                        <div class="collection-icon"></div>
                        <div class="collection-name">Create Collection</div>
                        <div class="collection-count">New folder</div>
                    </div>
                </div>

                <!-- Favorites Drop Zone (shown in favorites tab) -->
                <div class="favorites-collection" id="favoritesDropZone" style="display: none;"
                     ondragover="handleDragOver(event)" 
                     ondrop="handleDrop(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="favorites-header">&#128150; Quick Add</div>
                    <div class="favorites-text">Drag verses here to add to favorites</div>
                    <div class="favorites-count" id="favoritesCountDrop">0</div>
                    <div style="font-size: 12px; color: var(--text-tertiary); margin-top: 5px;">verses</div>
                </div>

                <!-- Sort Options -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                    <select class="library-search" style="flex: 1; min-width: 120px;" id="sortSelect" onchange="sortLibrary()">
                        <option value="newest"> Newest First</option>
                        <option value="oldest"> Oldest First</option>
                        <option value="az"> A-Z (Reference)</option>
                        <option value="book"> By Book</option>
                    </select>
                </div>

                <!-- All Verses List -->
                <div class="glass-card" id="versesListCard">
                    <div class="library-header" style="margin-bottom: 12px;">
                        <span>&#128218;</span>
                        <span id="libraryListTitle">My Verses</span>
                    </div>
                    
                    <div class="verse-list" id="libraryVersesList">
                        <div class="empty-state">
                            <div class="empty-state-icon">&#9825;</div>
                            <div class="empty-state-text">No verses yet. Start liking and saving!</div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- COMMENTS TAB - Enhanced -->
            <div id="comments" class="tab-view">
                <!-- Online Users -->
                <div class="online-users">
                    <div class="online-avatars" id="onlineAvatars">
                        <span class="avatar-wrap online-avatar-wrap" id="onlineAvatarWrap">
                            <img id="onlineAvatarImg" src="{{ user.picture }}" class="online-avatar" title="You" onerror="this.src='https://ui-avatars.com/api/?name={{ user.name }}&background=random'">
                            <img id="onlineAvatarDecor" class="avatar-decor hidden" alt="">
                        </span>
                    </div>
                    <div class="online-dot"></div>
                    <div class="online-count"><span id="onlineCount">1</span> online</div>
                </div>

                <div class="comments-container">
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button class="segment-btn active" id="commentsViewVerseBtn" onclick="switchCommentsView('verse')">Verse</button>
                        <button class="segment-btn" id="commentsViewCommunityBtn" onclick="switchCommentsView('community')">Community</button>
                        <button class="segment-btn" id="commentsViewDmBtn" onclick="switchCommentsView('dm')">DMs</button>
                    </div>
                    <!-- Current Verse Comments -->
                    <div class="comment-section" id="verseCommentsSection">
                        <div class="comment-section-header">
                            <span>&#128172;</span>
                            <span>Comments on <span id="commentVerseRef" style="color: var(--primary);">Current Verse</span></span>
                            <button class="comment-pin-btn" id="commentVerseSyncBtn" onclick="syncCommentVerse()">Use current verse</button>
                        </div>
                        
                        <!-- Emoji Picker -->
                        <div class="emoji-picker">
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                            <button class="emoji-btn" onclick="addEmoji('')"></button>
                        </div>

                        <div class="restriction-banner" id="commentRestrictionBanner"></div>

                        <div class="comment-input-area" id="commentInputArea">
                            <textarea class="comment-input" id="commentInput" name="comment_text" autocomplete="off" data-form-type="other" placeholder="Share your thoughts on this verse... Use @ to mention" rows="1" onkeydown="handleCommentKey(event)"></textarea>
                            <button class="send-btn" id="commentSendBtn" onclick="postComment()">&#8593;</button>
                        </div>

                        <div class="comments-list" id="commentsList"></div>
                    </div>

                    <!-- Community Chat -->
                    <div class="comment-section community-section" id="communityCommentsSection" style="display:none;">
                        <div class="comment-section-header">
                            <span>&#127757;</span>
                            <span>Community Chat</span>
                            <span class="community-badge">Life & Support</span>
                            <span class="trending-tag" id="trendingBadge" style="display: none;"> Trending</span>
                        </div>
                        
                        <!-- Topic Tags -->
                        <div style="display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; margin-bottom: 8px;">
                            <span class="tag" style="cursor: pointer;" onclick="filterCommunity('all')">#all</span>
                            <span class="tag" style="cursor: pointer;" onclick="filterCommunity('prayer')">#prayer</span>
                            <span class="tag" style="cursor: pointer;" onclick="filterCommunity('testimony')">#testimony</span>
                            <span class="tag" style="cursor: pointer;" onclick="filterCommunity('help')">#need-help</span>
                            <span class="tag" style="cursor: pointer;" onclick="filterCommunity('gratitude')">#gratitude</span>
                        </div>

                        <div class="restriction-banner" id="communityRestrictionBanner"></div>

                        <div class="comment-input-area" id="communityInputArea">
                            <textarea class="comment-input" id="communityInput" name="community_text" autocomplete="off" data-form-type="other" placeholder="Share about life, ask for help, or offer guidance... #topic" rows="1" onkeydown="handleCommunityKey(event)"></textarea>
                            <button class="send-btn" id="communitySendBtn" onclick="postCommunityMessage()">&#8593;</button>
                        </div>

                        <div class="comments-list" id="communityList"></div>
                    </div>

                    <!-- Direct Messages -->
                    <div class="comment-section dm-section" id="dmCommentsSection" style="display:none;">
                        <div class="comment-section-header">
                            <span></span>
                            <span>Direct Messages</span>
                        </div>

                        <div class="dm-search">
                            <input type="text" id="dmSearchInput" class="dm-input" placeholder="Search by name, email, or ID...">
                            <button class="btn btn-primary" onclick="searchDmUsers()">Find</button>
                        </div>
                        <div class="dm-search-results" id="dmSearchResults" style="display:none;"></div>

                        <div class="dm-layout">
                            <div>
                                <div class="dm-thread-list" id="dmThreadList"></div>
                                <div class="dm-thread-list" id="dmSuggestedList" style="margin-top:8px;"></div>
                            </div>
                            <div>
                                <div class="dm-actions">
                                    <div style="font-size:12px;color:var(--text-secondary);" id="dmHeaderLabel">No conversation selected</div>
                                    <button class="btn btn-secondary" onclick="deleteDmThread()">Delete Thread</button>
                                </div>
                                <div class="dm-messages" id="dmMessages">
                                    <div class="empty-state"><div class="empty-state-text">Select a conversation to start chatting.</div></div>
                                </div>
                                <div class="dm-typing" id="dmTypingIndicator"></div>
                                <div class="dm-input-area">
                                    <input type="text" id="dmInput" class="dm-input" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendDm()" oninput="scheduleTypingPing()">
                                    <button class="send-btn" onclick="sendDm()">Send</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SHOP TAB -->
            <div id="shop" class="tab-view">
                <div class="shop-container">
                    <div class="shop-header">
                        <h2 class="shop-title"> Item Shop</h2>
                        <div class="shop-xp-display">
                            <span class="shop-xp-icon"></span>
                            <span id="shopXpAmount">0 XP</span>
                            <span class="shop-level" id="shopLevel">Level 1</span>
                        </div>
                    </div>
                    
                    <div class="shop-categories">
                        <button class="shop-category-btn active" data-category="all" onclick="filterShop('all')">All</button>
                        <button class="shop-category-btn" data-category="frame" onclick="filterShop('frame')"> Frames</button>
                        <button class="shop-category-btn" data-category="name_color" onclick="filterShop('name_color')"> Colors</button>
                        <button class="shop-category-btn" data-category="title" onclick="filterShop('title')"> Titles</button>
                        <button class="shop-category-btn" data-category="badge" onclick="filterShop('badge')"> Badges</button>
                        <button class="shop-category-btn" data-category="chat_effect" onclick="filterShop('chat_effect')"> Chat</button>
                        <button class="shop-category-btn" data-category="profile_bg" onclick="filterShop('profile_bg')"> Backgrounds</button>
                        <button class="shop-category-btn" data-category="consumable" onclick="filterShop('consumable')"> Boosts</button>
                    </div>
                    
                    <div id="shopItems" class="shop-grid"></div>
                </div>
            </div>

            <!-- INVENTORY TAB -->
            <div id="inventory" class="tab-view">
                <div class="shop-container">
                    <div class="shop-header">
                        <h2 class="shop-title"> My Inventory</h2>
                        <div class="shop-xp-display">
                            <span class="shop-xp-icon"></span>
                            <span id="inventoryXpAmount">0 XP</span>
                            <span class="shop-level" id="inventoryLevel">Level 1</span>
                        </div>
                    </div>
                    
                    <div class="inventory-categories">
                        <button class="shop-category-btn active" data-category="all" onclick="filterInventory('all')">All</button>
                        <button class="shop-category-btn" data-category="frame" onclick="filterInventory('frame')"> Frames</button>
                        <button class="shop-category-btn" data-category="name_color" onclick="filterInventory('name_color')"> Colors</button>
                        <button class="shop-category-btn" data-category="title" onclick="filterInventory('title')"> Titles</button>
                        <button class="shop-category-btn" data-category="badge" onclick="filterInventory('badge')"> Badges</button>
                        <button class="shop-category-btn" data-category="chat_effect" onclick="filterInventory('chat_effect')"> Chat</button>
                        <button class="shop-category-btn" data-category="profile_bg" onclick="filterInventory('profile_bg')"> Backgrounds</button>
                        <button class="shop-category-btn" data-category="consumable" onclick="filterInventory('consumable')"> Boosts</button>
                    </div>
                    
                    <div id="inventoryItems" class="shop-grid"></div>
                </div>
            </div>

            <!-- ACHIEVEMENTS TAB -->
            <div id="achievements" class="tab-view">
                <div class="achievements-container">
                    <div class="shop-header">
                        <h2 class="shop-title"> Achievements</h2>
                        <div class="achievements-stats">
                            <span id="achievementsCompleted">0/0 Completed</span>
                            <span id="achievementsXP" class="achievement-xp-total">0 XP Earned</span>
                        </div>
                    </div>
                    <div class="achievement-categories">
                        <button class="shop-category-btn active" onclick="filterAchievements('all')"> All</button>
                        <button class="shop-category-btn" onclick="filterAchievements('likes')"> Likes</button>
                        <button class="shop-category-btn" onclick="filterAchievements('saves')"> Saves</button>
                        <button class="shop-category-btn" onclick="filterAchievements('comments')"> Comments</button>
                        <button class="shop-category-btn" onclick="filterAchievements('replies')"> Replies</button>
                        <button class="shop-category-btn" onclick="filterAchievements('streak')"> Streaks</button>
                        <button class="shop-category-btn" onclick="filterAchievements('shares')"> Shares</button>
                        <button class="shop-category-btn" onclick="filterAchievements('special')"> Special</button>
                    </div>
                    <div id="achievementsList" class="achievements-grid"></div>
                </div>
            </div>

            <!-- XP GUIDE TAB -->
            <div id="xp-guide" class="tab-view">
                <div class="xp-guide-container">
                    <div class="shop-header">
                        <h2 class="shop-title"> How to Earn XP</h2>
                        <div class="shop-xp-display">
                            <span class="shop-xp-icon"></span>
                            <span id="guideXpAmount">0 XP</span>
                            <span class="shop-level" id="guideLevel">Level 1</span>
                        </div>
                    </div>
                    <div id="xpGuideContent" class="xp-guide-content"></div>
                </div>
            </div>

            <!-- PROFILE TAB -->
            <div id="profile" class="tab-view" data-created-at="{{ user.created_at or '' }}" data-user-name="{{ user.name }}" data-user-email="{{ user.email }}" data-user-picture="{{ user.picture }}" data-user-decor="{{ user.avatar_decoration or '' }}" data-user-id="{{ user.id }}">
                <div class="glass-card" style="text-align: center; padding: 32px; position: relative;" id="profileCard">
                    <div class="avatar-wrap avatar-large" id="profileAvatarWrap" style="margin-bottom: 16px; position: relative;">
                        <div id="profileFrame" class="profile-frame"></div>
                        <img id="profileAvatar" src="{{ user.picture }}" style="width: 90px; height: 90px; border-radius: 50%; border: 3px solid var(--primary); box-shadow: 0 8px 24px var(--primary-glow); object-fit: cover;">
                        <img id="profileAvatarDecor" class="avatar-decor hidden" alt="">
                    </div>
                    <div id="profileBadges" style="margin-bottom: 8px;"></div>
                    <div id="profileUserName" style="font-size: 24px; font-weight: 700; margin-bottom: 4px;">{{ user.name }}</div>
                    <div id="profileTitle" class="profile-title"></div>
                    <div id="profileEmail" style="font-size: 14px; opacity: 0.6;">{{ user.email }}</div>
                    <div id="profileUserId" style="font-size: 12px; opacity: 0.5; margin-top: 4px;">ID: {{ user.id }}</div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="switchTab('comments'); switchCommentsView('dm');">Open DMs</button>
                    </div>
                    <div id="roleTag" style="display: none; margin-top: 8px; font-weight: 700; font-size: 14px; text-transform: uppercase;"></div>
                </div>

                <!-- Usage Stats -->
                <div class="profile-info-grid">
                    <div class="profile-info-card">
                        <div class="profile-info-label">Member Since</div>
                        <div class="profile-info-value" id="memberSince">Loading...</div>
                    </div>
                    <div class="profile-info-card">
                        <div class="profile-info-label">Time on Site</div>
                        <div class="profile-info-value" id="timeOnSite" style="color: var(--success);">0m 0s</div>
                    </div>
                    <div class="profile-info-card">
                        <div class="profile-info-label">XP</div>
                        <div class="profile-info-value" id="profileXp">0 XP</div>
                        <div class="profile-info-sub" id="profileLevel">Level 1</div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="statVerses" style="color: var(--primary);">0</div>
                        <div class="stat-label">Verses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statLiked" style="color: var(--danger);">0</div>
                        <div class="stat-label">Liked</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSaved" style="color: var(--warning);">0</div>
                        <div class="stat-label">Saved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statComments" style="color: var(--success);">0</div>
                        <div class="stat-label">Comments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statReplies" style="color: var(--secondary);">0</div>
                        <div class="stat-label">Replies</div>
                    </div>
                </div>

                <div class="glass-card notice-card" id="inboxCard" style="margin: 20px 0; padding: 24px;">
                    <div class="notice-header">
                        <div class="notice-title"> Messages</div>
                        <button class="bible-picks-btn secondary" type="button" onclick="markNotificationsRead()">Mark read</button>
                    </div>
                    <div class="notice-list" id="inboxList">
                        <div class="notice-empty">No messages yet.</div>
                    </div>
                </div>

                <!-- 1. READING STREAK -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                        <div style="font-size: 18px; font-weight: 700;"> Reading Streak</div>
                        <div id="streakBadge" style="background: linear-gradient(135deg, #ff6b35, #f7931e); padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 700;">0 DAYS</div>
                    </div>
                    <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;" id="streakCalendar">
                        <!-- Generated by JS -->
                    </div>
                    <div style="text-align: center; margin-top: 12px; font-size: 13px; opacity: 0.7;" id="streakMessage">
                        Start your streak today!
                    </div>
                </div>

                <!-- 2. FAVORITE BOOKS CHART -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;"> Favorite Books</div>
                    <div id="favoriteBooksChart" style="display: flex; flex-direction: column; gap: 10px;">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- 4. TODAY'S VERSE HISTORY -->
                <div class="glass-card" style="margin: 20px 0; padding: 24px;">
                    <div style="font-size: 18px; font-weight: 700; margin-bottom: 16px;"> Today's Verses</div>
                    <div id="verseHistory" style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <button class="gen-btn" style="background: var(--danger);" onclick="logout()">
                    Log Out
                </button>
            </div>

            <!-- ABOUT TAB -->
            <div id="about" class="tab-view">
                <div class="about-shell">
                    <div class="about-video-column">
                        <div class="about-slider-wrap">
                            <button class="about-nav-btn prev" onclick="aboutPrev()" aria-label="Previous video">&#8249;</button>
                            <button class="about-nav-btn next" onclick="aboutNext()" aria-label="Next video">&#8250;</button>
                            <div class="about-progress" id="aboutProgress">
                                <div class="about-progress-item"><div class="about-progress-fill" id="aboutProgressFill0"></div></div>
                                <div class="about-progress-item"><div class="about-progress-fill" id="aboutProgressFill1"></div></div>
                            </div>
                            <div class="about-now-playing" id="aboutNowPlaying">Slide 1/2  Playing  Vol 100%</div>
                            <div class="about-volume-wrap" onclick="event.stopPropagation()">
                                <input id="aboutVolumeSlider" class="about-volume-slider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Video volume" oninput="setAboutVolume(this.value)" onchange="setAboutVolume(this.value)">
                            </div>
                            <div class="about-slider-track" id="aboutSliderTrack">
                                <div class="about-slide">
                                    <div class="about-video-frame" id="aboutFrame0" onclick="toggleAboutPlayback()">
                                        <video class="about-video" id="aboutVideo0" loop playsinline muted preload="none">
                                            <source src="/media/videos/1.mp4?v=20260216-1100" type="video/mp4">
                                        </video>
                                        <div class="about-paused-indicator">&#9654; Paused</div>
                                    </div>
                                </div>
                                <div class="about-slide">
                                    <div class="about-video-frame" id="aboutFrame1" onclick="toggleAboutPlayback()">
                                        <video class="about-video" id="aboutVideo1" loop playsinline muted preload="none">
                                            <source src="/media/videos/2.mp4?v=20260216-1100" type="video/mp4">
                                        </video>
                                        <div class="about-paused-indicator">&#9654; Paused</div>
                                    </div>
                                </div>
                            </div>
                            <div class="about-dots" id="aboutDots">
                                <button class="about-dot active" onclick="setAboutSlide(0)" aria-label="Slide 1"></button>
                                <button class="about-dot" onclick="setAboutSlide(1)" aria-label="Slide 2"></button>
                            </div>
                        </div>
                    </div>

                    <div class="about-side">
                        <div class="about-hero">
                            <div style="font-size: 20px; font-weight: 700; margin-bottom: 6px;">About Us</div>
                            <div style="font-size: 14px; color: var(--text-secondary);">
                                Cross For All overview: mission, beliefs, leadership, and community impact.
                            </div>
                        </div>

                        <div class="about-info-grid">
                            <div class="about-info-card">
                                <div class="about-info-title">Mission</div>
                                <div class="about-info-text">Cross For All describes its direction with three pillars: Cross Centered, Community Focused, and Church Sent.</div>
                            </div>
                            <div class="about-info-card">
                                <div class="about-info-title">Vision & Beliefs</div>
                                <div class="about-info-text">The ministry highlights a city where all can find hope in Jesus and emphasizes scripture-centered teaching, worship, prayer, and compassionate service.</div>
                            </div>
                            <div class="about-info-card">
                                <div class="about-info-title">Leadership</div>
                                <div class="about-info-text">Senior Pastor: Joshua Lee. Executive Pastor: Linda Lee. The site also notes support ministries including youth, outreach, and worship teams.</div>
                            </div>
                            <div class="about-info-card">
                                <div class="about-info-title">Location & Times</div>
                                <div class="about-info-text">Address listed: 1136 N. Tustin Ave, Anaheim, CA 92807. Sunday gatherings shown: 9 AM and 11 AM.</div>
                            </div>
                            <div class="about-info-card">
                                <div class="about-info-title">Learn More</div>
                                <div class="about-info-text">Official page: <a class="about-link-inline" href="https://www.crossforall.com/about" target="_blank" rel="noopener noreferrer">crossforall.com/about</a></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Tab Bar - No Images -->
        <nav class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('discover', this)">
                <span class="tab-icon">&#10024;</span>
                <span class="tab-label">Discover</span>
            </button>
            <button class="tab-btn" onclick="switchTab('recommendations', this)">
                <span class="tab-icon">&#127919;</span>
                <span class="tab-label">For You</span>
            </button>
            <button class="tab-btn" onclick="switchTab('library', this)">
                <span class="tab-icon">&#128218;</span>
                <span class="tab-label">Library</span>
            </button>
            <button class="tab-btn" onclick="switchTab('comments', this)">
                <span class="tab-icon">&#128172;</span>
                <span class="tab-label">Chat</span>
            </button>
            <button class="tab-btn" onclick="switchTab('achievements', this)">
                <span class="tab-icon">&#127942;</span>
                <span class="tab-label">Awards</span>
            </button>
            <button class="tab-btn" onclick="switchTab('xp-guide', this)">
                <span class="tab-icon">&#9889;</span>
                <span class="tab-label">XP</span>
            </button>
            <button class="tab-btn" onclick="switchTab('shop', this)">
                <span class="tab-icon">&#128722;</span>
                <span class="tab-label">Shop</span>
            </button>
            <button class="tab-btn" onclick="switchTab('profile', this)">
                <span class="tab-icon">&#128100;</span>
                <span class="tab-label">Profile</span>
            </button>
            <button class="tab-btn" onclick="switchTab('about', this)">
                <span class="tab-icon">&#127909;</span>
                <span class="tab-label">About</span>
            </button>
        </nav>
    </div>

    <!-- Fullscreen Verse -->
    <div class="fullscreen-verse" id="fullscreen" onclick="closeFullscreenOverlay(event)">
        <div class="fullscreen-text" id="fullscreenText"></div>
        <div class="fullscreen-actions">
            <button class="fullscreen-btn" onclick="event.stopPropagation(); toggleLike(); updateFullscreenButtons();">
                <span id="fsLikeIcon">&#9825;</span>
                <span>Like</span>
            </button>
            <button class="fullscreen-btn" onclick="event.stopPropagation(); toggleSave(); updateFullscreenButtons();">
                <span id="fsSaveIcon">&#128278;</span>
                <span>Save</span>
            </button>
            <button class="fullscreen-btn" onclick="event.stopPropagation(); copyVerse();">
                <span>&#128203;</span>
                <span>Copy</span>
            </button>
        </div>
        <div class="fullscreen-hint">Click background to close</div>
    </div>

    <div class="reader-fullscreen" id="readerFullscreen" onclick="closeReaderFullscreen(event)">
        <div class="reader-fullscreen-inner">
            <div class="reader-fullscreen-header">
                <div class="bible-reader-title"> Ebook Reader</div>
                <div class="bible-reader-current" id="readerFullscreenChapter">Chapter: </div>
                <button class="bible-reader-btn secondary" type="button" onclick="toggleReaderFullscreen()">Close</button>
            </div>
            <div class="bible-reader-pagination">
                <button class="bible-reader-btn secondary" type="button" onclick="prevReaderPage()">Prev Page</button>
                <div class="bible-reader-page" id="readerFullscreenPageIndicator">Page 0/0</div>
                <button class="bible-reader-btn secondary" id="readerFullscreenNextPageBtn" type="button" onclick="nextReaderPage()">Next Page</button>
                <button class="bible-reader-btn next-chapter" id="readerFullscreenNextChapterBtn" type="button" onclick="nextBibleChapter()">Next Chapter</button>
            </div>
            <div class="bible-reader-content" id="readerFullscreenContent">Waiting for selection.</div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal" onclick="closeSettings(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <button class="close-btn" onclick="closeSettings()">&#10005;</button>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Dark Mode</div>
                    <div class="setting-desc">Use dark color scheme</div>
                </div>
                <div class="toggle active" id="darkToggle" onclick="toggleTheme()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Font Size</div>
                </div>
                <div class="segment-control" id="fontSizeSegment">
                    <button class="segment-btn" onclick="setFontSize('small', this)">Small</button>
                    <button class="segment-btn active" onclick="setFontSize('medium', this)">Med</button>
                    <button class="segment-btn" onclick="setFontSize('large', this)">Large</button>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Change Username</div>
                    <div class="setting-desc">Update how your name appears in chat and profile</div>
                </div>
                <div style="display:flex; gap:8px; align-items:center; width: 100%; max-width: 320px;">
                    <input class="setting-select" id="usernameInput" maxlength="40" placeholder="New username" style="flex:1;">
                    <button class="btn btn-primary" onclick="changeUsername()" style="padding: 8px 12px; font-size: 12px;">Save</button>
                </div>
            </div>

            <div class="setting-item role-gated" data-min-role="host" data-display="block" style="flex-direction: column; align-items: flex-start; gap: 12px;">
                <div>
                    <div class="setting-label">Avatar Shop (Host+)</div>
                    <div class="setting-desc">Beta profile customizations for staff testing</div>
                </div>
                <div style="width: 100%; display: flex; flex-direction: column; gap: 10px;">
                    <div style="display:flex; gap:8px; align-items:center; width: 100%; max-width: 520px;">
                        <input class="setting-select" id="avatarUrlInput" placeholder="Profile picture URL (https://...)" style="flex:1;">
                        <button class="btn btn-primary" onclick="saveProfilePictureUrl()" style="padding: 8px 12px; font-size: 12px;">Update</button>
                        <button class="btn btn-secondary" onclick="resetProfilePicture()" style="padding: 8px 12px; font-size: 12px;">Reset</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center; width: 100%; flex-wrap: wrap;">
                        <input type="file" id="avatarUploadInput" accept="image/*" style="flex:1; min-width: 180px;">
                        <label style="display:flex; align-items:center; gap:6px; font-size:12px;">
                            <input type="checkbox" id="avatarRemoveBgToggle">
                            Remove background
                        </label>
                        <button class="btn btn-primary" onclick="uploadAvatar('picture')" style="padding: 8px 12px; font-size: 12px;">Upload</button>
                    </div>
                    <div class="shop-note">Tip: Upload your Discord test image here and enable Remove background to make it transparent.</div>
                    <div style="margin-top: 6px; font-weight: 700;">Avatar Decorations</div>
                    <div class="avatar-shop-grid" id="avatarDecorPresets"></div>
                    <div style="display:flex; gap:8px; align-items:center; width: 100%; max-width: 520px;">
                        <input class="setting-select" id="decorUrlInput" placeholder="Decoration GIF URL (https://...)" style="flex:1;">
                        <button class="btn btn-primary" onclick="saveAvatarDecorationUrl()" style="padding: 8px 12px; font-size: 12px;">Apply</button>
                        <button class="btn btn-secondary" onclick="clearAvatarDecoration()" style="padding: 8px 12px; font-size: 12px;">Clear</button>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center; width: 100%; flex-wrap: wrap;">
                        <input type="file" id="decorUploadInput" accept="image/*" style="flex:1; min-width: 180px;">
                        <button class="btn btn-secondary" onclick="uploadAvatar('decoration')" style="padding: 8px 12px; font-size: 12px;">Upload Decoration</button>
                    </div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Animations</div>
                    <div class="setting-desc">Enable transition effects</div>
                </div>
                <div class="toggle active" id="animToggle" onclick="toggleAnimations()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Sound Effects</div>
                    <div class="setting-desc">Professional interface sounds</div>
                </div>
                <div class="toggle active" id="soundToggle" onclick="toggleSound()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Auto-Recommendations</div>
                    <div class="setting-desc">Generate recommendations automatically</div>
                </div>
                <div class="toggle active" id="autoRecToggle" onclick="toggleAutoRec()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Compact Mode</div>
                    <div class="setting-desc">Reduce padding for more content</div>
                </div>
                <div class="toggle" id="compactToggle" onclick="toggleCompact()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Notification Bell</div>
                    <div class="setting-desc">Show toast notifications</div>
                </div>
                <div class="toggle active" id="notificationToggle" onclick="toggleNotifications()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <!-- Extra Settings -->
            <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 12px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;"> Extra Features</div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Cross Particles</div>
                    <div class="setting-desc">Floating Jesus crosses in the background</div>
                </div>
                <div class="toggle" id="particlesToggle" onclick="toggleParticles()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">High Contrast</div>
                    <div class="setting-desc">Stronger colors for accessibility</div>
                </div>
                <div class="toggle" id="contrastToggle" onclick="toggleHighContrast()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Focus Reading Mode</div>
                    <div class="setting-desc">Highlight verses and reduce distractions</div>
                </div>
                <div class="toggle" id="focusModeToggle" onclick="toggleFocusMode()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Auto-Copy New Verse</div>
                    <div class="setting-desc">Copy each newly generated verse to clipboard</div>
                </div>
                <div class="toggle" id="autoCopyToggle" onclick="toggleAutoCopy()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Keep Screen Awake</div>
                    <div class="setting-desc">Prevent screen sleep while reading</div>
                </div>
                <div class="toggle" id="wakeLockToggle" onclick="toggleWakeLock()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <!-- Text to Speech Settings -->
            <div style="margin: 20px 0 10px; padding-top: 15px; border-top: 1px solid var(--glass-border);">
                <div style="font-size: 12px; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px;"> Text to Speech</div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Auto-Speak Verses</div>
                    <div class="setting-desc">Automatically read verses aloud</div>
                </div>
                <div class="toggle" id="ttsToggle" onclick="toggleTTS()">
                    <div class="toggle-thumb"></div>
                </div>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Speech Speed</div>
                    <div class="setting-desc">How fast verses are read</div>
                </div>
                <select class="setting-select" id="ttsSpeedSelect" onchange="changeTTSSpeed(this.value)">
                    <option value="1">1x (Normal)</option>
                    <option value="1.25">1.25x</option>
                    <option value="1.5">1.5x</option>
                    <option value="1.75">1.75x</option>
                    <option value="2">2x (Fast)</option>
                </select>
            </div>

            <div class="setting-item">
                <div>
                    <div class="setting-label">Test Speech</div>
                    <div class="setting-desc">Click to test TTS</div>
                </div>
                <button class="btn btn-primary" onclick="testTTS()" style="padding: 8px 16px; font-size: 13px;"> Test</button>
            </div>

            <!-- Admin Only Setting -->
            <div class="setting-item admin-only" id="adminIntervalSetting">
                <div>
                    <div class="setting-label" style="color: var(--danger);">Verse Refresh Interval (Admin)</div>
                    <div class="setting-desc">How often to fetch new verses</div>
                </div>
                <select class="setting-select" id="intervalSelect" onchange="changeInterval(this.value)">
                    <option value="30">30 seconds</option>
                    <option value="60" selected>1 minute</option>
                    <option value="120">2 minutes</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                </select>
            </div>

            <!-- Admin Dashboard Link -->
            <div class="setting-item admin-only" id="adminDashboardLink">
                <div>
                    <div class="setting-label" style="color: var(--primary);"> Admin Dashboard</div>
                    <div class="setting-desc">Manage users, view stats, and more</div>
                </div>
                <a href="/admin/dashboard" class="btn btn-primary" style="text-decoration: none; padding: 8px 16px; font-size: 13px;">Open</a>
            </div>

            <!-- Database Status Link -->
            <div class="setting-item admin-only" id="dbStatusLink">
                <div>
                    <div class="setting-label" style="color: var(--primary);"> Database Status</div>
                    <div class="setting-desc">Check which DB is active and what is saving</div>
                </div>
                <a href="/db-status" class="btn btn-primary" style="text-decoration: none; padding: 8px 16px; font-size: 13px;">Open</a>
            </div>

            <button class="admin-panel-btn" id="adminPanelBtn" onclick="openAdminUnlock()">
                 Staff Access
            </button>
        </div>
    </div>

    <!-- Admin Unlock Modal -->
    <div class="modal admin-unlock-modal" id="adminUnlockModal" onclick="closeAdminUnlock(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title"> Staff Access</div>
                <button class="close-btn" onclick="closeAdminUnlock()">&#10005;</button>
            </div>
            
            <p style="color: var(--text-secondary); margin-bottom: 16px;">Select your role and enter the access code</p>
            
            <!-- Role Selection -->
            <div class="role-selector">
                <div class="role-btn" data-role="host" onclick="selectRole('host')">
                    <span class="role-icon"></span>
                    <span class="role-name">Host</span>
                </div>
                <div class="role-btn" data-role="mod" onclick="selectRole('mod')">
                    <span class="role-icon"></span>
                    <span class="role-name">Mod</span>
                </div>
                <div class="role-btn" data-role="co_owner" onclick="selectRole('co_owner')">
                    <span class="role-icon"></span>
                    <span class="role-name">Co-Owner</span>
                </div>
                <div class="role-btn" data-role="owner" onclick="selectRole('owner')">
                    <span class="role-icon"></span>
                    <span class="role-name">Owner</span>
                </div>
            </div>
            
            <input type="password" class="admin-code-input" id="adminCodeInput" name="admin_code" autocomplete="one-time-code" data-form-type="other" placeholder="Enter code for selected role..." maxlength="20">
            
            <button class="unlock-btn" id="unlockBtn" onclick="verifyRoleCode()" disabled>Access Panel</button>
            
            <div style="margin-top: 16px; padding: 12px; background: rgba(255,55,95,0.1); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                <strong style="color: var(--danger);">Need help?</strong> Contact administration for your access code.
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // State
        let currentVerse = null;
        let currentTab = 'discover';
        let libraryData = { liked: [], saved: [], collections: [] };
        let settings = {
            darkMode: false,
            fontSize: 'medium',
            animations: true,
            sound: true,
            autoRec: true,
            compact: false,
            notifications: true,
            interval: 60,
            particles: false,
            highContrast: false,
            focusMode: false,
            autoCopyVerse: false,
            keepAwake: false,
            ttsEnabled: false,
            ttsSpeed: 1
        };
        let commentRestriction = { restricted: false, reason: '', expires_at: null };
        let notificationsCache = [];
        let themeAuto = false;
        let lastCommentsSignature = '';
        let lastCommunitySignature = '';
        let activeCommentVerseId = null;
        let activeCommentVerseRef = null;
        let commentVerseLocked = false;
        let wakeLockHandle = null;
        
        // Text to Speech
        const TTS = {
            synth: window.speechSynthesis,
            currentUtterance: null,
            
            speak(text, speed = 1) {
                if (!this.synth) {
                    console.error('TTS not supported');
                    return;
                }
                
                // Cancel any current speech
                this.synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = speed;
                utterance.pitch = 1;
                utterance.volume = 1;
                utterance.lang = 'en-US';
                
                // Try to find a good voice
                const voices = this.synth.getVoices();
                const preferredVoice = voices.find(v => v.name.includes('Google US English')) ||
                                      voices.find(v => v.name.includes('Samantha')) ||
                                      voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) ||
                                      voices[0];
                if (preferredVoice) {
                    utterance.voice = preferredVoice;
                }
                
                this.currentUtterance = utterance;
                this.synth.speak(utterance);
            },
            
            stop() {
                if (this.synth) {
                    this.synth.cancel();
                }
            },
            
            isSpeaking() {
                return this.synth ? this.synth.speaking : false;
            }
        };
        
        // Load voices when available
        if (window.speechSynthesis) {
            window.speechSynthesis.onvoiceschanged = () => {
                TTS.synth.getVoices();
            };
        }
        let autoRecInterval = null;
        let verseCheckInterval = null;
        let presencePingInterval = null;
        let commentsRefreshInterval = null;
        let challengeRefreshInterval = null;
        let challengeCountdownInterval = null;
        let notificationPollInterval = null;
        const VERSE_POLL_INTERVAL_MS = 5000;
        const STATUS_REFRESH_INTERVAL_MS = 15000;
        let verseFetchInFlight = false;
        let lastStatusRefreshAt = 0;
        let lastStatusVerseId = null;
        let initDone = false;
        let latestNotificationId = null;
        let isAdmin = false;
        let favoritesCollection = null;
        let currentCommentsView = 'verse';
        let openReplyKey = null;
        let replyActiveKey = null;
        const replyDrafts = {};
        let aboutSlideIndex = 0;
        let aboutTouchStartX = null;
        let aboutTouchMoved = false;
        let dmSelectedUserId = null;
        let dmSelectedUserName = '';
        let dmSelectedUserDecor = '';
        let dmThreadsSignature = '';
        let dmMessagesSignature = '';
        let dmTypingCooldown = null;
        let currentAvatarDecoration = '';
        const dmThreadsCache = {};
        let aboutIsSliding = false;
        let aboutSyncTimer = null;
        let aboutVideoErrorCount = 0;
        let aboutVolume = 1;
        let aboutProgressTimer = null;
        let countdownTicker = null;
        let countdownBase = 0;
        let countdownTotal = 0;
        let countdownSyncedAt = 0;
        let biblePickState = { picks: [] };
        let bibleReaderState = { books: [], translation: 'web' };
        let readerPages = [];
        let readerPageIndex = 0;
        // Permanent Timer State
        let sessionStartTime = null;
        let timerInterval = null;

        // Drag and Drop State
        let dragState = {
            isDragging: false,
            draggedVerse: null,
            dragTimer: null,
            startX: 0,
            startY: 0,
            hasMoved: false
        };

        // Initialize
        function startVersePolling() {
            if (verseCheckInterval) return;
            fetchVerse();
            verseCheckInterval = setInterval(() => {
                if (document.hidden) return;
                fetchVerse();
            }, VERSE_POLL_INTERVAL_MS);
        }

        function stopVersePolling() {
            if (!verseCheckInterval) return;
            clearInterval(verseCheckInterval);
            verseCheckInterval = null;
        }

        async function init() {
            if (initDone) return;
            initDone = true;
            loadSettings();
            initGlobalFontScaling();
            initPermanentTimer();
            stopVersePolling();
            startVersePolling();
            checkAdminStatus();
            renderAvatarDecorations();
            const profileEl = document.getElementById('profile');
            applyAvatarDecoration(profileEl?.dataset?.userDecor || '');
            
            // Setup textarea auto-resize
            setupTextarea('commentInput');
            setupTextarea('communityInput');
            
            // Initialize new features
            initDailyChallenge();
            await loadBibleBooks();
            await loadBiblePicks(true);
            loadVerseOfDay();
            renderRecHistory();
            await updateXpDisplay();
            updateOnlineUsers();
            updateTabThemeClass(currentTab);
            switchCommentsView('verse');
            updateRestrictionUI();
            setInterval(updateRestrictionUI, 60000);
            setupAboutSliderGestures();
            initAboutVideoEvents();
            initAboutVolumeControl();
            setAboutSlide(aboutSlideIndex);
            setupGlobalShortcuts();
            pingPresence();
            if (presencePingInterval) clearInterval(presencePingInterval);
            presencePingInterval = setInterval(pingPresence, 45000);
            pollNotifications();
            if (notificationPollInterval) clearInterval(notificationPollInterval);
            notificationPollInterval = setInterval(pollNotifications, 30000);
            handleDeepLinkParams();
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) stopVersePolling();
                else startVersePolling();
            });
            const verseContainer = document.querySelector('.verse-container');
            if (verseContainer) {
                verseContainer.addEventListener('dblclick', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    toggleLike();
                });
            }
        }

        function setupTextarea(id) {
            const el = document.getElementById(id);
            if (!el) return;
            
            el.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
            
            el.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (id === 'commentInput') postComment();
                    else if (id === 'communityInput') postCommunityMessage();
                }
            });
        }

        function getFontScaleValue(size) {
            if (size === 'small') return 0.9;
            if (size === 'large') return 1.14;
            return 1;
        }

        function applyFontScaleToNode(node) {
            if (!node || node.nodeType !== 1) return;
            const scale = getFontScaleValue(settings.fontSize || 'medium');
            const targets = [node, ...node.querySelectorAll('*')];
            targets.forEach(el => {
                const computed = window.getComputedStyle(el);
                const currentPx = parseFloat(computed.fontSize);
                if (!Number.isFinite(currentPx) || currentPx <= 0) return;
                if (!el.dataset.baseFontPx) {
                    el.dataset.baseFontPx = (currentPx / scale).toString();
                }
                const base = parseFloat(el.dataset.baseFontPx);
                if (Number.isFinite(base) && base > 0) {
                    el.style.fontSize = `${(base * scale).toFixed(2)}px`;
                }
            });
        }

        function applyGlobalFontScale() {
            applyFontScaleToNode(document.body);
        }

        function initGlobalFontScaling() {
            applyGlobalFontScale();
            const observer = new MutationObserver((mutations) => {
                mutations.forEach(m => {
                    m.addedNodes.forEach(n => applyFontScaleToNode(n));
                });
            });
            observer.observe(document.body, { childList: true, subtree: true });
        }

        // Permanent Timer Functions
        function initPermanentTimer() {
            // Check if we have a stored start time
            const storedStart = localStorage.getItem('bibleAppStartTime');
            const storedIsAdmin = localStorage.getItem('bibleAppIsAdmin');
            
            if (storedStart) {
                sessionStartTime = parseInt(storedStart);
            } else {
                sessionStartTime = Date.now();
                localStorage.setItem('bibleAppStartTime', sessionStartTime);
            }
            
            if (storedIsAdmin === 'true') {
                isAdmin = true;
                updateAdminUI();
            }
            
            // Update every second
            updateTimeOnSite();
            timerInterval = setInterval(updateTimeOnSite, 1000);
        }

        function updateTimeOnSite() {
            const now = Date.now();
            const elapsed = Math.floor((now - sessionStartTime) / 1000); // in seconds
            
            const hours = Math.floor(elapsed / 3600);
            const mins = Math.floor((elapsed % 3600) / 60);
            const secs = elapsed % 60;
            
            let timeText = '';
            if (hours > 0) {
                timeText = `${hours}h ${mins}m ${secs}s`;
            } else if (mins > 0) {
                timeText = `${mins}m ${secs}s`;
            } else {
                timeText = `${secs}s`;
            }
            
            const el = document.getElementById('timeOnSite');
            if (el) el.textContent = timeText;
        }

        // Admin Functions
        let userRole = 'user';
        
        function rolePriority(role) {
            const map = { user: 0, host: 1, mod: 2, co_owner: 3, owner: 4 };
            return map[String(role || 'user')] ?? 0;
        }

        function pickHigherRole(a, b) {
            return rolePriority(b) > rolePriority(a) ? b : a;
        }

        function applyRoleGatedUI() {
            const role = userRole || 'user';
            document.querySelectorAll('.role-gated').forEach(el => {
                const minRole = el.dataset.minRole || 'user';
                const show = rolePriority(role) >= rolePriority(minRole);
                const display = el.dataset.display || (el.classList.contains('setting-item') ? 'flex' : 'block');
                el.style.display = show ? display : 'none';
            });
        }

        async function checkAdminStatus() {
            try {
                const res = await fetch('/api/user_info');
                const data = await res.json();
                const userInfoRole = data.role || 'user';
                let effectiveRole = userInfoRole;
                let adminSessionRole = null;
                try {
                    const adminRes = await fetch('/admin/api/check-session');
                    if (adminRes.ok) {
                        const adminData = await adminRes.json();
                        if (adminData && adminData.role) adminSessionRole = adminData.role;
                    }
                } catch (_) {}
                if (adminSessionRole) {
                    effectiveRole = pickHigherRole(effectiveRole, adminSessionRole);
                }
                userRole = effectiveRole;
                
                if (data.is_admin || data.session_admin || adminSessionRole) {
                    isAdmin = true;
                    localStorage.setItem('bibleAppIsAdmin', 'true');
                    localStorage.setItem('bibleAppRole', effectiveRole);
                    updateAdminUI(effectiveRole);
                }
                
                // Always update role badge
                updateRoleBadge(effectiveRole);
                applyRoleGatedUI();
            } catch (e) {
                console.error('Admin check failed:', e);
            }
        }
        
        function updateRoleBadge(role) {
            const badge = document.getElementById('roleBadge');
            const adminBadge = document.getElementById('adminBadge');
            const roleTag = document.getElementById('roleTag');
            
            if (!badge) return;
            
            // Hide admin badge, show role badge instead
            adminBadge.style.display = 'none';
            
            const roleDisplay = role.replace('_', ' ').toUpperCase();
            badge.textContent = roleDisplay;
            badge.className = 'role-badge role-' + role + ' show';
            
            // Update profile tag
            if (roleTag) {
                roleTag.textContent = roleDisplay;
                roleTag.style.color = getRoleColor(role);
                roleTag.style.display = 'block';
            }
        }
        
        function getRoleColor(role) {
            const colors = {
                'user': '#666',
                'host': '#30D158',
                'mod': '#FF9F0A',
                'co_owner': '#BF5AF2',
                'owner': '#FF375F'
            };
            return colors[role] || '#666';
        }

        function updateAdminUI(roleOverride = null) {
            // Show role badge
            const storedRole = roleOverride || localStorage.getItem('bibleAppRole') || 'user';
            updateRoleBadge(storedRole);
            
            // Show admin-only settings
            document.getElementById('adminIntervalSetting').classList.add('show');
            document.getElementById('adminDashboardLink').classList.add('show');
            
            // Hide unlock button
            const unlockBtn = document.getElementById('adminPanelBtn');
            if (unlockBtn) unlockBtn.style.display = 'none';
            
            // Show delete buttons on existing comments
            document.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.classList.add('show');
            });
        }

        let brandClickCount = 0;
        let brandClickTimer = null;
        let selectedRole = null;

        function handleBrandClick() {
            brandClickCount++;
            
            if (brandClickCount === 1) {
                brandClickTimer = setTimeout(() => {
                    brandClickCount = 0;
                }, 1000);
            }
            
            if (brandClickCount >= 3) {
                clearTimeout(brandClickTimer);
                brandClickCount = 0;
                openAdminUnlock();
            }
        }

        function selectRole(role) {
            selectedRole = role;
            
            // Update UI
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`.role-btn[data-role="${role}"]`).classList.add('selected');
            
            // Enable unlock button
            document.getElementById('unlockBtn').disabled = false;
            
            // Update placeholder
            const roleNames = {
                'host': 'Host',
                'mod': 'Moderator',
                'co_owner': 'Co-Owner',
                'owner': 'Owner'
            };
            document.getElementById('adminCodeInput').placeholder = `Enter ${roleNames[role]} code...`;
            document.getElementById('adminCodeInput').focus();
        }

        function openAdminUnlock() {
            if (isAdmin) return;
            selectedRole = null;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('unlockBtn').disabled = true;
            document.getElementById('adminCodeInput').placeholder = 'Enter code for selected role...';
            document.getElementById('adminCodeInput').value = '';
            document.getElementById('adminUnlockModal').classList.add('active');
        }

        function closeAdminUnlock(e) {
            if (!e || e.target.id === 'adminUnlockModal') {
                document.getElementById('adminUnlockModal').classList.remove('active');
                document.getElementById('adminCodeInput').value = '';
                selectedRole = null;
                document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('unlockBtn').disabled = true;
            }
        }

        async function verifyRoleCode() {
            const code = document.getElementById('adminCodeInput').value.trim();
            
            if (!selectedRole) {
                showToast('Please select a role first', 'error');
                return;
            }
            
            if (!code) {
                showToast('Please enter a code', 'error');
                return;
            }
            
            try {
                const res = await fetch('/api/verify_role_code', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code: code, role: selectedRole})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    isAdmin = true;
                    userRole = data.role;
                    localStorage.setItem('bibleAppIsAdmin', 'true');
                    localStorage.setItem('bibleAppRole', data.role);
                    updateAdminUI();
                    closeAdminUnlock();
                    showToast(`Role unlocked: ${data.role_display}! `, 3000);
                    console.log('Role assigned:', data.role, data.role_display);
                } else {
                    showToast(data.error || 'Invalid code for selected role.', 'error', 5000);
                    document.getElementById('adminCodeInput').value = '';
                    document.getElementById('adminCodeInput').focus();
                }
            } catch (e) {
                showToast('Error verifying code', 'error');
            }
        }

        // Tab Switching
        function switchTab(tab, btn = null) {
            AudioSys.playSwitch();
            const prevTab = currentTab;
            currentTab = tab;
            updateTabThemeClass(tab);
            
            document.querySelectorAll('.tab-view').forEach(v => {
                v.classList.remove('active');
                v.classList.remove('desktop-active');
            });
            document.getElementById(tab).classList.add('active');
            
            if (window.innerWidth >= 1024) {
                document.getElementById(tab).classList.add('desktop-active');
            }
            
            if (btn) {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.tab === tab) n.classList.add('active');
            });
            
            if (tab === 'library') loadLibrary();
            if (tab === 'comments') {
                if (currentCommentsView === 'verse') {
                    if (!activeCommentVerseId && currentVerse) {
                        setActiveCommentVerse(currentVerse);
                    }
                }
                if (currentCommentsView === 'community') loadCommunityMessages();
                else if (currentCommentsView === 'dm') {
                    loadDmThreads(true);
                    loadDmMessages(true);
                } else loadComments();
                startCommentsPolling();
                updateOnlineUsers();
                updateRestrictionUI();
            } else if (prevTab === 'comments') {
                stopCommentsPolling();
            }
            if (tab === 'profile') loadProfileStats();
            if (tab === 'recommendations') loadRecommendations();
            if (tab === 'shop') { renderShopItems(); updateShopXPDisplay(); }
            if (tab === 'inventory') { renderInventory(); updateInventoryXPDisplay(); }
            if (tab === 'achievements') { loadAchievements(); }
            if (tab === 'xp-guide') { renderXPGuide(); }
            if (prevTab === 'about' && tab !== 'about') {
                pauseAboutPlayback();
                stopAboutProgressTicker();
            }
            if (tab === 'about') {
                setAboutSlide(aboutSlideIndex);
                startAboutProgressTicker();
            }
        }

        async function pingPresence() {
            try {
                await fetch('/api/presence/ping', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: window.location.pathname + '#' + currentTab })
                });
            } catch (_) {}
        }

        async function pollNotifications() {
            try {
                const res = await fetch('/api/notifications');
                if (!res.ok) return;
                const rows = await res.json();
                if (!Array.isArray(rows)) return;
                notificationsCache = rows;
                renderNotificationPanels(rows);
                if (!rows.length) return;
                const unread = rows.filter(n => !n.is_read);
                const newest = unread[0] || rows[0];
                if (!newest) return;
                if (latestNotificationId === null) {
                    latestNotificationId = newest.id;
                    return;
                }
                if (newest.id !== latestNotificationId && unread.length && settings.notifications) {
                    showToast(`${newest.title || 'Notification'}: ${newest.message || ''}`);
                    latestNotificationId = newest.id;
                }
            } catch (_) {}
        }

        function formatNotificationTime(value) {
            if (!value) return '';
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) return '';
            return dt.toLocaleString();
        }

        function renderNotificationPanels(rows) {
            const announcementList = document.getElementById('announcementList');
            const inboxList = document.getElementById('inboxList');
            if (!announcementList && !inboxList) return;
            const announcements = rows.filter(r => (r.type || '') === 'announcement' || (r.type || '') === 'push');
            const messages = rows.filter(r => (r.type || '') === 'direct_message');

            if (announcementList) {
                if (!announcements.length) {
                    announcementList.innerHTML = '<div class="notice-empty">No announcements yet.</div>';
                } else {
                    announcementList.innerHTML = announcements.map(a => `
                        <div class="notice-item">
                            <div class="notice-item-title">${escapeHtml(a.title || 'Announcement')}</div>
                            <div>${escapeHtml(a.message || '')}</div>
                            <div class="notice-item-meta">${formatNotificationTime(a.created_at)}</div>
                        </div>
                    `).join('');
                }
            }

            if (inboxList) {
                if (!messages.length) {
                    inboxList.innerHTML = '<div class="notice-empty">No messages yet.</div>';
                } else {
                    inboxList.innerHTML = messages.map(m => `
                        <div class="notice-item">
                            <div class="notice-item-title">${escapeHtml(m.title || 'Message')}</div>
                            <div>${escapeHtml(m.message || '')}</div>
                            <div class="notice-item-meta">${formatNotificationTime(m.created_at)}</div>
                        </div>
                    `).join('');
                }
            }
        }

        async function markNotificationsRead() {
            try {
                await fetch('/api/notifications/read', { method: 'POST' });
                pollNotifications();
            } catch (_) {}
        }

        // Verse Handling
        function syncCountdown(remainingSeconds, totalSeconds) {
            const remain = Math.max(0, parseInt(remainingSeconds || 0, 10));
            const total = Math.max(1, parseInt(totalSeconds || 0, 10));
            countdownBase = remain;
            countdownTotal = total;
            countdownSyncedAt = Date.now();
            updateCountdownUi();
            if (!countdownTicker) {
                countdownTicker = setInterval(updateCountdownUi, 1000);
            }
        }

        function syncIntervalSetting(intervalValue) {
            const nextInterval = parseInt(intervalValue || 0, 10);
            if (!Number.isFinite(nextInterval) || nextInterval <= 0) return;
            if (settings.interval === nextInterval) return;
            settings.interval = nextInterval;
            saveSettings();
            const select = document.getElementById('intervalSelect');
            if (select && String(select.value) !== String(nextInterval)) {
                select.value = String(nextInterval);
            }
            if (isAdmin && settings.notifications) {
                showToast(`Interval synced: ${nextInterval}s`);
            }
        }

        function updateCountdownUi() {
            if (!countdownSyncedAt) return;
            const elapsed = Math.floor((Date.now() - countdownSyncedAt) / 1000);
            const remaining = Math.max(0, countdownBase - elapsed);
            const pct = countdownTotal ? (remaining / countdownTotal) * 100 : 0;
            const bar = document.getElementById('timerBar');
            const text = document.getElementById('timerText');
            if (bar) bar.style.width = `${pct}%`;
            if (text) text.textContent = formatCountdown(remaining);
        }

        async function fetchVerse() {
            if (verseFetchInFlight) return;
            verseFetchInFlight = true;
            try {
                const res = await fetch('/api/current');
                const data = await res.json().catch(() => ({}));
                if (!res.ok || data.error) {
                    if (data.error === 'banned') {
                        showAccountLock('Account Banned', data.message || 'Your account has been banned.', data.reason || '');
                        stopVersePolling();
                    } else if (data.error === 'maintenance') {
                        showAccountLock('Maintenance', data.message || 'Site is under maintenance.');
                    }
                    return;
                }
                
                if (data.verse) {
                    const nextVerseKey = String(data.verse.id || `${data.verse.ref || ''}|${data.verse.text || ''}`);
                    const currentVerseKey = currentVerse ? String(currentVerse.id || `${currentVerse.ref || ''}|${currentVerse.text || ''}`) : null;
                    const isNew = !!currentVerse && nextVerseKey !== currentVerseKey;
                    currentVerse = data.verse;
                    
                    document.getElementById('verseText').textContent = data.verse.text;
                    document.getElementById('verseRef').textContent = data.verse.ref;
                    document.getElementById('verseSource').textContent = data.verse.source;
                    document.getElementById('fullscreenText').textContent = `"${data.verse.text}"\n\n ${data.verse.ref}`;
                    if (!commentVerseLocked) {
                        setActiveCommentVerse(data.verse);
                    }
                    
                    syncCountdown(data.countdown, data.interval);
                    syncIntervalSetting(data.interval);
                    
                    if (isNew) {
                        animateVerseReveal();
                        // Speak the new verse if TTS is enabled
                        speakVerse(data.verse.text, data.verse.ref);

                        if (settings.autoCopyVerse && navigator.clipboard) {
                            const verseLine = `"${data.verse.text}"  ${data.verse.ref}`;
                            navigator.clipboard.writeText(verseLine).catch(() => {});
                        }
                        
                        // Add to history
                        addToVerseHistory(data.verse);
                        
                        // Track daily challenge - view
                        trackDailyAction('view', nextVerseKey);
                        
                        // Award XP and track stat for viewing
                        awardXP(5, 'view');
                        trackStat('total_verses');
                        
                        if (settings.notifications) {
                            showToast('New verse discovered! +5 XP');
                        }
                        if (currentTab === 'comments') loadComments();
                    }
                    
                    const now = Date.now();
                    const verseId = data.verse.id;
                    const shouldRefreshStatus = (
                        isNew ||
                        verseId !== lastStatusVerseId ||
                        (now - lastStatusRefreshAt) >= STATUS_REFRESH_INTERVAL_MS
                    );
                    if (shouldRefreshStatus) {
                        await checkStatus(verseId);
                        lastStatusRefreshAt = now;
                        lastStatusVerseId = verseId;
                    }
                }
            } catch (e) {
                console.error('Fetch error:', e);
            } finally {
                verseFetchInFlight = false;
            }
        }

        function formatCountdown(totalSeconds) {
            const safe = Math.max(0, parseInt(totalSeconds || 0, 10));
            const mins = Math.floor(safe / 60);
            const secs = safe % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function setActiveCommentVerse(verse) {
            if (!verse) return;
            activeCommentVerseId = verse.id;
            activeCommentVerseRef = verse.ref || 'Current Verse';
            const refEl = document.getElementById('commentVerseRef');
            if (refEl) refEl.textContent = activeCommentVerseRef;
        }

        function syncCommentVerse() {
            if (!currentVerse) return;
            commentVerseLocked = false;
            setActiveCommentVerse(currentVerse);
            loadComments(true);
        }

        async function checkStatus(verseId) {
            const [likeRes, saveRes] = await Promise.all([
                fetch(`/api/check_like/${verseId}`),
                fetch(`/api/check_save/${verseId}`)
            ]);
            const likeData = await likeRes.json();
            const saveData = await saveRes.json();
            
            updateLikeUI(likeData.liked);
            updateSaveUI(saveData.saved);
        }

        function updateLikeUI(liked) {
            const icon = document.getElementById('likeIcon');
            icon.innerHTML = liked ? '&#9829;' : '&#9825;';
            icon.style.color = liked ? 'var(--danger)' : '';
        }

        function updateSaveUI(saved) {
            const icon = document.getElementById('saveIcon');
            icon.innerHTML = saved ? '&#128209;' : '&#128278;';
            icon.style.color = saved ? 'var(--warning)' : '';
        }

        async function toggleLike() {
            if (!currentVerse) return;
            const res = await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    verse_id: currentVerse.id,
                    verse: {
                        reference: currentVerse.ref,
                        text: currentVerse.text,
                        translation: currentVerse.trans,
                        source: currentVerse.source,
                        book: currentVerse.book
                    }
                })
            });
            const data = await res.json();
            updateLikeUI(data.liked);
            animateActionFeedback('likeIcon', data.liked ? '' : '');
            if (settings.notifications) showToast(data.liked ? 'Added to likes' : 'Removed from likes');
            
            if (data.recommendation && settings.autoRec) {
                showRecommendation(data.recommendation);
            }
            if (currentTab === 'library') loadLibrary();
            
            // Track daily challenge and achievements
            if (data.liked) {
                trackDailyAction('like');
                awardXP(50, 'like');
                trackStat('likes');
            }
        }

        async function toggleSave() {
            if (!currentVerse) return;
            const res = await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    verse_id: currentVerse.id,
                    verse: {
                        reference: currentVerse.ref,
                        text: currentVerse.text,
                        translation: currentVerse.trans,
                        source: currentVerse.source,
                        book: currentVerse.book
                    }
                })
            });
            const data = await res.json();
            updateSaveUI(data.saved);
            animateActionFeedback('saveIcon', data.saved ? '' : '');
            
            // Track daily challenge and achievements
            if (data.saved) {
                trackDailyAction('save');
                awardXP(50, 'save');
                trackStat('saves');
            }
            if (settings.notifications) showToast(data.saved ? 'Verse saved' : 'Removed from saved');
            if (currentTab === 'library') loadLibrary();
        }

        // Copy & Share
        async function copyVerse() {
            if (!currentVerse) return;
            const text = `"${currentVerse.text}"  ${currentVerse.ref}`;
            await navigator.clipboard.writeText(text);
            if (settings.notifications) showToast('Copied to clipboard!');
        }

        async function shareVerse() {
            if (!currentVerse) return;
            const text = `"${currentVerse.text}"  ${currentVerse.ref}`;
            
            try {
                if (navigator.share) {
                    await navigator.share({ title: 'Bible AI Verse', text: text, url: window.location.href });
                    trackShare();
                } else {
                    await navigator.clipboard.writeText(text);
                    trackShare();
                    if (settings.notifications) showToast('Verse copied for sharing!');
                }
            } catch (e) {
                console.log('Share cancelled');
            }
        }

        // Fullscreen
        function toggleFullscreen(verse = null) {
            const fs = document.getElementById('fullscreen');
            const v = verse || currentVerse;
            
            if (v) {
                document.getElementById('fullscreenText').textContent = `"${v.text}"\n\n ${v.ref}`;
                updateFullscreenButtons(v.id);
                fs.classList.add('active');
                AudioSys.playModal();
            }
        }

        function closeFullscreenOverlay(e) {
            if (e.target.id === 'fullscreen') {
                document.getElementById('fullscreen').classList.remove('active');
                AudioSys.playModal();
            }
        }

        async function updateFullscreenButtons(verseId = null) {
            const id = verseId || (currentVerse ? currentVerse.id : null);
            if (!id) return;
            
            const [likeRes, saveRes] = await Promise.all([
                fetch(`/api/check_like/${id}`),
                fetch(`/api/check_save/${id}`)
            ]);
            const likeData = await likeRes.json();
            const saveData = await saveRes.json();
            
            document.getElementById('fsLikeIcon').innerHTML = likeData.liked ? '&#9829;' : '&#9825;';
            document.getElementById('fsSaveIcon').innerHTML = saveData.saved ? '&#128209;' : '&#128278;';
        }

        // Recommendations
        function setupAutoRecommendations() {
            if (autoRecInterval) clearInterval(autoRecInterval);
            autoRecInterval = setInterval(async () => {
                if (settings.autoRec && currentTab === 'recommendations') {
                    await generateRec(true);
                }
            }, 60000);
        }

        function toggleAutoRec() {
            settings.autoRec = !settings.autoRec;
            document.getElementById('autoRecToggle').classList.toggle('active');
            saveSettings();
            if (settings.notifications) showToast(settings.autoRec ? 'Auto-recommendations ON' : 'Auto-recommendations OFF');
        }

        async function loadRecommendations() {
            const res = await fetch('/api/recommendations');
            const data = await res.json();
            
            if (data.recommendations.length > 0) {
                displayRecommendations(data.recommendations);
            }
        }

        async function generateRec(silent = false) {
            const btn = document.querySelector('.gen-btn');
            btn.style.transform = 'scale(0.97)';
            setTimeout(() => btn.style.transform = '', 100);
            
            const excludeIds = getRecentRecIds(20);
            const res = await fetch('/api/generate-recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ exclude_ids: excludeIds })
            });
            const data = await res.json();
            
            if (data.success) {
                let recommendation = data.recommendation;
                if (isDuplicateRec(recommendation)) {
                    excludeIds.push(recommendation.id);
                    const retry = await fetch('/api/generate-recommendation', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ exclude_ids: excludeIds })
                    });
                    const retryData = await retry.json();
                    if (retryData.success) recommendation = retryData.recommendation;
                }
                showRecommendation(recommendation);
                addToRecHistory(recommendation);
                if (!silent && settings.notifications) showToast('New recommendation!');
            }
        }

        function isDuplicateRec(rec) {
            const history = JSON.parse(localStorage.getItem('recHistory') || '[]');
            return !!history.find(item => item && rec && item.id === rec.id);
        }

        function showRecommendation(rec) {
            const list = document.getElementById('recList');
            const card = createRecCard(rec);
            list.innerHTML = '';
            list.appendChild(card);
        }

        function displayRecommendations(recs) {
            const list = document.getElementById('recList');
            list.innerHTML = '';
            if (recs && recs.length > 0) {
                list.appendChild(createRecCard(recs[0]));
            }
        }

        function createRecCard(rec) {
            const div = document.createElement('div');
            div.className = 'rec-card';
            div.dataset.rec = JSON.stringify(rec || {});
            div.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 11px; font-weight: 700; text-transform: uppercase; color: var(--primary);">
                    <span>&#10024;</span>
                    <span>${rec.reason}</span>
                </div>
                <div style="font-size: 15px; line-height: 1.5; margin-bottom: 10px;">${rec.text}</div>
                <div style="font-size: 13px; opacity: 0.7; font-weight: 600; margin-bottom: 12px;">${rec.ref}</div>
                <div style="display: flex; gap: 8px;">
                    <button class="verse-card-btn" style="flex: 1;" onclick="recLike(${rec.id}, this)">&#9825; Like</button>
                    <button class="verse-card-btn" style="flex: 1;" onclick="recSave(${rec.id}, this)">&#128278; Save</button>
                </div>
            `;
            return div;
        }

        async function recLike(id, btn) {
            let payload = { verse_id: id };
            try {
                const raw = btn?.closest('.rec-card')?.dataset?.rec;
                if (raw) {
                    const rec = JSON.parse(raw);
                    payload.verse = {
                        reference: rec.ref || rec.reference,
                        text: rec.text,
                        translation: rec.translation || rec.trans,
                        source: rec.source,
                        book: rec.book
                    };
                }
            } catch (_) {}
            await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            btn.innerHTML = '&#9829; Liked';
            btn.classList.add('liked');
            btn.classList.add('pop-success');
            setTimeout(() => btn.classList.remove('pop-success'), 420);
            trackDailyAction('like');
        }

        async function recSave(id, btn) {
            let payload = { verse_id: id };
            try {
                const raw = btn?.closest('.rec-card')?.dataset?.rec;
                if (raw) {
                    const rec = JSON.parse(raw);
                    payload.verse = {
                        reference: rec.ref || rec.reference,
                        text: rec.text,
                        translation: rec.translation || rec.trans,
                        source: rec.source,
                        book: rec.book
                    };
                }
            } catch (_) {}
            await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            btn.innerHTML = '&#128209; Saved';
            btn.classList.add('saved');
            btn.classList.add('pop-success');
            setTimeout(() => btn.classList.remove('pop-success'), 420);
            trackDailyAction('save');
        }

        // Library - Simplified with Favorites
        async function loadLibrary() {
            const res = await fetch('/api/library');
            libraryData = await res.json();
            
            // Find or create favorites collection
            favoritesCollection = libraryData.collections.find(c => c.name === 'Favorites');
            
            // Update favorites drop zone count
            const favCount = favoritesCollection ? favoritesCollection.verses.length : 0;
            const likedCount = Array.isArray(libraryData.liked) ? libraryData.liked.length : 0;
            const savedCount = Array.isArray(libraryData.saved) ? libraryData.saved.length : 0;
            document.getElementById('favoritesCount').textContent = `${favCount} verses`;
            document.getElementById('favoritesCountDrop').textContent = String(favCount);
            document.getElementById('likedCount').textContent = `${likedCount} verses`;
            document.getElementById('savedCount').textContent = `${savedCount} verses`;
            
            // Render combined liked and saved verses
            renderLibraryVerses();
        }

        function renderLibraryVerses() {
            const list = document.getElementById('libraryVersesList');
            
            // Combine liked and saved, remove duplicates
            const allVerses = [...libraryData.liked, ...libraryData.saved];
            const seen = new Set();
            const uniqueVerses = allVerses.filter(v => {
                if (seen.has(v.id)) return false;
                seen.add(v.id);
                return true;
            });
            
            if (uniqueVerses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#9825;</div>
                        <div class="empty-state-text">No verses yet. Start liking and saving!</div>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = uniqueVerses.map(v => `
                <div class="verse-card" 
                     draggable="true"
                     data-verse-id="${v.id}"
                     data-verse='${JSON.stringify(v).replace(/'/g, "&#39;")}'
                     onmousedown="handleMouseDown(event, this)"
                     onmouseup="handleMouseUp(event, this)"
                     onmouseleave="handleMouseLeave(event, this)"
                     ontouchstart="handleTouchStart(event, this)"
                     ontouchend="handleTouchEnd(event, this)"
                     ondragstart="handleDragStart(event, this)">
                    <div class="verse-card-text">${v.text}</div>
                    <div class="verse-card-ref">${v.ref}</div>
                    <div class="verse-card-actions">
                        <button class="verse-card-btn ${v.liked_at ? 'liked' : ''}" onclick="event.stopPropagation(); libraryLike(${v.id})">
                            ${v.liked_at ? '&#9829; Liked' : '&#9825; Like'}
                        </button>
                        <button class="verse-card-btn ${v.saved_at ? 'saved' : ''}" onclick="event.stopPropagation(); librarySave(${v.id})">
                            ${v.saved_at ? '&#128209; Saved' : '&#128278; Save'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Drag and Drop Handlers
        function handleMouseDown(e, el) {
            dragState.startX = e.clientX;
            dragState.startY = e.clientY;
            dragState.hasMoved = false;
            dragState.draggedVerse = JSON.parse(el.dataset.verse);
            
            dragState.dragTimer = setTimeout(() => {
                dragState.isDragging = true;
                el.classList.add('dragging');
            }, 300);
        }

        function handleMouseUp(e, el) {
            clearTimeout(dragState.dragTimer);
            
            const dx = Math.abs(e.clientX - dragState.startX);
            const dy = Math.abs(e.clientY - dragState.startY);
            
            if (!dragState.isDragging && dx < 5 && dy < 5) {
                const verse = JSON.parse(el.dataset.verse);
                toggleFullscreen(verse);
            }
            
            setTimeout(() => {
                dragState.isDragging = false;
                dragState.draggedVerse = null;
                el.classList.remove('dragging');
            }, 50);
        }

        function handleMouseLeave(e, el) {
            clearTimeout(dragState.dragTimer);
            if (!dragState.isDragging) {
                dragState.draggedVerse = null;
            }
        }

        function handleTouchStart(e, el) {
            const touch = e.touches[0];
            dragState.startX = touch.clientX;
            dragState.startY = touch.clientY;
            dragState.hasMoved = false;
            dragState.draggedVerse = JSON.parse(el.dataset.verse);
            
            dragState.dragTimer = setTimeout(() => {
                dragState.isDragging = true;
                el.classList.add('dragging');
            }, 400);
        }

        function handleTouchEnd(e, el) {
            clearTimeout(dragState.dragTimer);
            
            const touch = e.changedTouches[0];
            const dx = Math.abs(touch.clientX - dragState.startX);
            const dy = Math.abs(touch.clientY - dragState.startY);
            
            if (!dragState.isDragging && dx < 10 && dy < 10) {
                const verse = JSON.parse(el.dataset.verse);
                toggleFullscreen(verse);
            }
            
            setTimeout(() => {
                dragState.isDragging = false;
                dragState.draggedVerse = null;
                el.classList.remove('dragging');
            }, 50);
        }

        function handleDragStart(e, el) {
            if (!dragState.isDragging && dragState.draggedVerse) {
                dragState.isDragging = true;
                dragState.draggedVerse = JSON.parse(el.dataset.verse);
            }
            e.dataTransfer.effectAllowed = 'copy';
            e.dataTransfer.setData('text/plain', el.dataset.verseId);
        }

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('favoritesDropZone').classList.add('drag-over');
        }

        function handleDragLeave(e) {
            document.getElementById('favoritesDropZone').classList.remove('drag-over');
        }

        async function handleDrop(e) {
            e.preventDefault();
            document.getElementById('favoritesDropZone').classList.remove('drag-over');
            
            const verseId = dragState.draggedVerse ? dragState.draggedVerse.id : parseInt(e.dataTransfer.getData('text/plain'));
            if (!verseId) return;
            
            // Create favorites collection if doesn't exist, then add verse
            try {
                let collectionId = favoritesCollection ? favoritesCollection.id : null;
                
                if (!collectionId) {
                    // Create favorites collection
                    const createRes = await fetch('/api/collections/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({name: 'Favorites', color: '#FF375F'})
                    });
                    const createData = await createRes.json();
                    collectionId = createData.id;
                    favoritesCollection = createData;
                }
                
                const res = await fetch('/api/collections/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({collection_id: collectionId, verse_id: verseId})
                });
                
                const data = await res.json();
                if (data.success) {
                    if (settings.notifications) showToast('Added to Favorites!');
                    loadLibrary();
                } else {
                    if (settings.notifications) showToast('Already in Favorites');
                }
            } catch (e) {
                console.error('Drop error:', e);
            }
            
            dragState.isDragging = false;
            dragState.draggedVerse = null;
            document.querySelectorAll('.verse-card.dragging').forEach(el => el.classList.remove('dragging'));
        }

        async function libraryLike(id) {
            await fetch('/api/like', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            loadLibrary();
            if (currentVerse && currentVerse.id === id) checkStatus(id);
        }

        async function librarySave(id) {
            await fetch('/api/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: id})
            });
            loadLibrary();
            if (currentVerse && currentVerse.id === id) checkStatus(id);
        }

        // Comments
        async function loadComments(force = false) {
            const verseForComments = activeCommentVerseId || (currentVerse ? currentVerse.id : null);
            if (!verseForComments) return;
            if (!force && isCommentsInputActive()) return;
            captureActiveReplyDraft();
            const res = await fetch(`/api/comments/${verseForComments}`, { cache: 'no-store' });
            const data = await res.json().catch(() => ([]));
            if (!res.ok || data.error) {
                if (data.error === 'banned') {
                    showAccountLock('Account Banned', data.message || 'Your account has been banned.', data.reason || '');
                    stopVersePolling();
                }
                return;
            }
            const comments = data;
            const signature = buildCommentSignature(comments);
            if (!force && signature && signature === lastCommentsSignature) {
                return;
            }
            lastCommentsSignature = signature;
            
            const list = document.getElementById('commentsList');
            if (comments.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">No comments yet. Share your thoughts!</div></div>';
            } else {
                list.innerHTML = comments.map(c => renderCommentItem(c, 'comment')).join('');
            }
            if (openReplyKey) {
                restoreActiveReplyDraft();
            }
            
            // Show delete buttons if admin
            if (isAdmin) {
                document.querySelectorAll('.delete-comment-btn').forEach(btn => btn.classList.add('show'));
            }
            applyRestrictionState();
            
            // Apply shop effects to comments
            setTimeout(() => applyShopEffectsToComments(), 100);
            
            // Setup DM button handlers
            setupDmButtonHandlers();
        }

        function setupDmButtonHandlers() {
            // Remove existing handlers to prevent duplicates
            document.querySelectorAll('.dm-btn').forEach(btn => {
                btn.removeEventListener('click', handleDmButtonClick);
                btn.addEventListener('click', handleDmButtonClick);
            });
        }
        
        function handleDmButtonClick(e) {
            e.preventDefault();
            e.stopPropagation();
            const btn = e.currentTarget;
            const userId = parseInt(btn.dataset.userId);
            const userName = btn.dataset.userName || 'User';
            const userPicture = btn.dataset.userPicture || '';
            const userDecor = btn.dataset.userDecor || '';
            openDmFromComment(userId, userName, userPicture, userDecor);
        }

        async function postComment() {
            const input = document.getElementById('commentInput');
            const text = input.value.trim();
            if (!text) return;
            const verseId = activeCommentVerseId || (currentVerse ? currentVerse.id : null);
            if (!verseId) return;
            commentVerseLocked = true;
            if (commentRestriction.restricted) {
                showToast(commentRestriction.reason ? `Chat disabled: ${commentRestriction.reason}` : 'Chat disabled');
                return;
            }
            
            const res = await fetch('/api/comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({verse_id: verseId, text: text})
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.message || data.error || 'Comment failed');
                if (data.error === 'restricted') updateRestrictionUI();
                return;
            }
            input.value = '';
            input.style.height = 'auto';
            loadComments(true);
            loadProfileStats();
            if (settings.notifications) showToast('Comment posted!');
            trackDailyAction('comment');
            awardXP(100, 'comment');
            trackStat('comments');
        }

        // Community Chat
        async function loadCommunityMessages(force = false) {
            if (!force && isCommentsInputActive()) return;
            captureActiveReplyDraft();
            const res = await fetch('/api/community', { cache: 'no-store' });
            const data = await res.json().catch(() => ([]));
            if (!res.ok || data.error) {
                if (data.error === 'banned') {
                    showAccountLock('Account Banned', data.message || 'Your account has been banned.', data.reason || '');
                    stopVersePolling();
                }
                return;
            }
            const messages = data;
            const filtered = currentCommunityFilter === 'all'
                ? messages
                : messages.filter(m => String(m.text || '').toLowerCase().includes('#' + currentCommunityFilter.toLowerCase()));
            const signature = buildCommentSignature(filtered);
            if (!force && signature && signature === lastCommunitySignature) {
                return;
            }
            lastCommunitySignature = signature;
            
            const list = document.getElementById('communityList');
            if (filtered.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">Start a conversation about life, faith, or support!</div></div>';
            } else {
                list.innerHTML = filtered.map(m => renderCommentItem(m, 'community')).join('');
            }
            if (openReplyKey) {
                restoreActiveReplyDraft();
            }
            
            if (isAdmin) {
                document.querySelectorAll('.delete-comment-btn').forEach(btn => btn.classList.add('show'));
            }
            applyRestrictionState();
            
            // Apply shop effects to community messages
            setTimeout(() => applyShopEffectsToComments(), 100);
            
            // Setup DM button handlers
            setupDmButtonHandlers();
        }

        async function postCommunityMessage() {
            const input = document.getElementById('communityInput');
            const text = input.value.trim();
            if (!text) return;
            if (commentRestriction.restricted) {
                showToast(commentRestriction.reason ? `Chat disabled: ${commentRestriction.reason}` : 'Chat disabled');
                return;
            }
            
            const res = await fetch('/api/community', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({text: text})
            });

            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.message || data.error || 'Message failed');
                if (data.error === 'restricted') updateRestrictionUI();
                return;
            }
            input.value = '';
            input.style.height = 'auto';
            loadCommunityMessages(true);
            if (settings.notifications) showToast('Message posted!');
        }

        // ===== Direct Messages =====
        function buildDmThreadsSignature(threads) {
            if (!Array.isArray(threads)) return '';
            return threads.map(t => [
                t.user_id,
                (t.last_message || '').length,
                t.last_at || '',
                t.unread || 0,
                t.picture || '',
                t.avatar_decoration || ''
            ].join(':')).join('|');
        }

        function buildDmMessagesSignature(messages) {
            if (!Array.isArray(messages)) return '';
            return messages.map(m => `${m.id}:${m.sender_id}:${(m.message || '').length}`).join('|');
        }

        function renderDmThreads(threads) {
            const list = document.getElementById('dmThreadList');
            if (!list) return;
            if (!threads.length) {
                list.innerHTML = '<div class="empty-state"><div class="empty-state-text">No conversations yet.</div></div>';
                const suggested = document.getElementById('dmSuggestedList');
                if (suggested) {
                    suggested.innerHTML = '<div class="empty-state"><div class="empty-state-text">Suggestions loading</div></div>';
                }
                loadDmSuggestions();
                return;
            }
            threads.forEach(t => { dmThreadsCache[t.user_id] = t; });
            list.innerHTML = threads.map(t => {
                const active = dmSelectedUserId === t.user_id ? 'active' : '';
                const unread = t.unread ? `  ${t.unread} new` : '';
                const avatarHtml = renderAvatarMarkup(t.picture || '', t.name || 'User', t.avatar_decoration || '', 'dm-thread-avatar');
                return `
                    <div class="dm-thread ${active}" onclick="openDmThread(${t.user_id})">
                        ${avatarHtml}
                        <div>
                            <div class="dm-thread-name">${escapeHtml(t.name || 'User')}</div>
                            <div class="dm-thread-last">${escapeHtml(t.last_message || 'No messages yet')}</div>
                        </div>
                        ${t.unread ? `<span class="dm-unread">${t.unread}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        async function loadDmSuggestions() {
            const suggested = document.getElementById('dmSuggestedList');
            if (!suggested) return;
            try {
                const res = await fetch('/api/users/recent?limit=6', { cache: 'no-store' });
                const data = await res.json().catch(() => ([]));
                if (!res.ok || data.error || !data.length) {
                    suggested.innerHTML = '';
                    return;
                }
                suggested.innerHTML = data.map(u => {
                    const avatarHtml = renderAvatarMarkup(u.picture || '', u.name || 'User', u.avatar_decoration || '', 'dm-thread-avatar');
                    return `
                    <div class="dm-thread" onclick="openDmThread(${u.id}, ${JSON.stringify(u.name || 'User')}, ${JSON.stringify(u.picture || '')}, ${JSON.stringify(u.avatar_decoration || '')})">
                        ${avatarHtml}
                        <div>
                            <div class="dm-thread-name">${escapeHtml(u.name || 'User')}</div>
                            <div class="dm-thread-last">Suggested  ${escapeHtml(u.role || 'user')}</div>
                        </div>
                    </div>
                    `;
                }).join('');
            } catch (_) {
                suggested.innerHTML = '';
            }
        }

        function renderDmMessages(messages) {
            const box = document.getElementById('dmMessages');
            if (!box) return;
            if (!messages.length) {
                box.innerHTML = '<div class="empty-state"><div class="empty-state-text">No messages yet.</div></div>';
                return;
            }
            box.innerHTML = messages.map(m => {
                const self = m.sender_id === {{ user.id }};
                return `
                    <div class="dm-message ${self ? 'self' : ''}">
                        ${escapeHtml(m.message || '')}
                        <div class="dm-time">${formatLocalTimestamp(m.created_at)}</div>
                    </div>
                `;
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        async function loadDmThreads(force = false) {
            if (!force && isCommentsInputActive()) return;
            try {
                const res = await fetch('/api/dm/threads', { cache: 'no-store' });
                const data = await res.json();
                if (!res.ok || data.error) return;
                let list = Array.isArray(data) ? data : [];
                if (dmSelectedUserId && !list.some(t => t.user_id === dmSelectedUserId)) {
                    const fallback = dmThreadsCache[dmSelectedUserId] || {
                        user_id: dmSelectedUserId,
                        name: dmSelectedUserName || `User #${dmSelectedUserId}`,
                        picture: '',
                        avatar_decoration: dmSelectedUserDecor || '',
                        last_message: 'Start a conversation',
                        unread: 0
                    };
                    list = [fallback, ...list];
                }
                const signature = buildDmThreadsSignature(data);
                if (!force && signature === dmThreadsSignature) return;
                dmThreadsSignature = signature;
                renderDmThreads(list);
            } catch (_) {}
        }

        async function loadDmMessages(force = false) {
            if (!dmSelectedUserId) return;
            if (!force && isCommentsInputActive()) return;
            try {
                const res = await fetch(`/api/dm/messages/${dmSelectedUserId}`, { cache: 'no-store' });
                const data = await res.json();
                if (!res.ok || data.error) return;
                const signature = buildDmMessagesSignature(data);
                if (!force && signature === dmMessagesSignature) return;
                dmMessagesSignature = signature;
                renderDmMessages(data);
                updateDmTyping();
            } catch (_) {}
        }

        function openDmThread(userId, userName = '', userPicture = '', userDecor = '') {
            if (!userId) return;
            if (currentTab !== 'comments') switchTab('comments');
            if (currentCommentsView !== 'dm') switchCommentsView('dm');
            dmSelectedUserId = userId;
            if (userName) dmSelectedUserName = userName;
            if (userDecor) dmSelectedUserDecor = userDecor;
            dmMessagesSignature = '';
            if (!dmThreadsCache[userId]) {
                dmThreadsCache[userId] = {
                    user_id: userId,
                    name: userName || dmSelectedUserName || `User #${userId}`,
                    picture: userPicture || '',
                    avatar_decoration: userDecor || '',
                    last_message: 'Start a conversation',
                    unread: 0
                };
            }
            const label = document.getElementById('dmHeaderLabel');
            if (label) {
                const thread = dmThreadsCache[userId];
                const name = thread && thread.name ? thread.name : `#${userId}`;
                label.textContent = `Conversation with ${name}`;
            }
            const results = document.getElementById('dmSearchResults');
            if (results) {
                results.style.display = 'none';
                results.innerHTML = '';
            }
            renderDmThreads(Object.values(dmThreadsCache));
            loadDmThreads(true);
            loadDmMessages(true);
        }

        async function sendDm() {
            if (!dmSelectedUserId) {
                showToast('Pick a user first');
                return;
            }
            const input = document.getElementById('dmInput');
            const message = (input.value || '').trim();
            if (!message) return;
            const res = await fetch('/api/dm/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ recipient_id: dmSelectedUserId, message })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.message || data.error || 'Message failed');
                return;
            }
            input.value = '';
            loadDmMessages(true);
            loadDmThreads(true);
        }

        async function deleteDmThread() {
            if (!dmSelectedUserId) {
                showToast('Pick a conversation first');
                return;
            }
            if (!confirm('Delete this conversation?')) return;
            const res = await fetch(`/api/dm/thread/${dmSelectedUserId}/delete`, { method: 'POST' });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Delete failed');
                return;
            }
            dmSelectedUserId = null;
            dmMessagesSignature = '';
            const label = document.getElementById('dmHeaderLabel');
            if (label) label.textContent = 'No conversation selected';
            const box = document.getElementById('dmMessages');
            if (box) box.innerHTML = '<div class="empty-state"><div class="empty-state-text">Select a conversation to start chatting.</div></div>';
            loadDmThreads(true);
        }

        function scheduleTypingPing() {
            if (!dmSelectedUserId) return;
            if (dmTypingCooldown) return;
            dmTypingCooldown = setTimeout(async () => {
                dmTypingCooldown = null;
                try {
                    await fetch('/api/dm/typing', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ other_id: dmSelectedUserId })
                    });
                } catch (_) {}
            }, 600);
        }

        async function updateDmTyping() {
            if (!dmSelectedUserId) return;
            const indicator = document.getElementById('dmTypingIndicator');
            if (!indicator) return;
            try {
                const res = await fetch(`/api/dm/typing/${dmSelectedUserId}`);
                const data = await res.json().catch(() => ({}));
                indicator.textContent = data.typing ? 'Typing' : '';
            } catch (_) {
                indicator.textContent = '';
            }
        }

        async function searchDmUsers() {
            const input = document.getElementById('dmSearchInput');
            const q = (input.value || '').trim();
            const isIdSearch = /^\d+$/.test(q);
            if (q.length < 2 && !isIdSearch) {
                showToast('Type at least 2 characters');
                return;
            }
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(q)}`);
            const data = await res.json().catch(() => ([]));
            const results = document.getElementById('dmSearchResults');
            if (!res.ok || data.error) {
                results.style.display = 'block';
                results.innerHTML = '<div class="empty-state"><div class="empty-state-text">Search failed.</div></div>';
                return;
            }
            if (!data.length) {
                results.style.display = 'block';
                results.innerHTML = '<div class="empty-state"><div class="empty-state-text">No users found.</div></div>';
                return;
            }
            results.style.display = 'block';
            results.innerHTML = data.map(u => {
                const meta = [];
                if (u.role) meta.push(u.role);
                meta.push(`ID:${u.id}`);
                if (u.email) meta.push(u.email);
                const avatarHtml = renderAvatarMarkup(u.picture || '', u.name || 'User', u.avatar_decoration || '', 'dm-thread-avatar');
                return `
                <div class="dm-thread" onclick="openDmThread(${u.id}, ${JSON.stringify(u.name || 'User')}, ${JSON.stringify(u.picture || '')}, ${JSON.stringify(u.avatar_decoration || '')})">
                    ${avatarHtml}
                    <div>
                        <div class="dm-thread-name">${escapeHtml(u.name || 'User')}</div>
                        <div class="dm-thread-last">${escapeHtml(meta.join('  '))}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function openDmFromComment(userId, userName = '', userPicture = '', userDecor = '') {
            if (!userId) return;
            switchTab('comments');
            switchCommentsView('dm');
            openDmThread(userId, userName, userPicture, userDecor);
        }

        function formatLocalTimestamp(ts, options) {
            if (!ts) return '';
            const raw = String(ts).trim();
            if (!raw) return '';
            const hasZone = /Z|[+-]\d{2}:?\d{2}$/.test(raw);
            const normalized = hasZone ? raw : `${raw}Z`;
            const date = new Date(normalized);
            if (Number.isNaN(date.getTime())) return raw;
            return date.toLocaleString([], options || {});
        }

        function buildReactionsSignature(reactions) {
            if (!reactions || typeof reactions !== 'object') return '';
            const keys = Object.keys(reactions).sort();
            return keys.map(k => `${k}:${reactions[k] || 0}`).join(',');
        }

        function buildCommentSignature(items) {
            if (!Array.isArray(items)) return '';
            return items.map(c => {
                const replies = Array.isArray(c.replies) ? c.replies : [];
                const replyIds = replies.map(r => `${r.id}:${r.avatar_decoration || ''}:${r.user_picture || ''}`).join(',');
                return [
                    c.id,
                    (c.text || '').length,
                    c.reply_count || replies.length || 0,
                    buildReactionsSignature(c.reactions),
                    replyIds,
                    c.user_picture || '',
                    c.avatar_decoration || ''
                ].join('|');
            }).join('||');
        }

        function trackReplyDraft(key, value) {
            if (!key) return;
            replyDrafts[key] = value || '';
            replyActiveKey = key;
        }

        function setReplyEditing(key, isEditing) {
            if (!key) return;
            if (isEditing) {
                replyActiveKey = key;
                return;
            }
            if (replyActiveKey === key) replyActiveKey = null;
        }

        function captureActiveReplyDraft() {
            const active = document.activeElement;
            if (!active || !active.id || !active.id.startsWith('reply-input-')) return;
            const key = active.id.replace('reply-input-', '');
            replyDrafts[key] = active.value || '';
            replyActiveKey = key;
        }

        function restoreActiveReplyDraft() {
            if (!replyActiveKey) return;
            const input = document.getElementById(`reply-input-${replyActiveKey}`);
            if (!input) return;
            input.value = replyDrafts[replyActiveKey] || '';
            input.focus();
            const len = input.value.length;
            try { input.setSelectionRange(len, len); } catch (_) {}
        }

        // Cache for user customizations to avoid repeated API calls
        const userCustomizationCache = new Map();
        
        async function fetchUserCustomization(userId) {
            if (!userId) return null;
            if (userCustomizationCache.has(userId)) {
                return userCustomizationCache.get(userId);
            }
            const customization = await getUserCustomization(userId);
            if (customization) {
                userCustomizationCache.set(userId, customization);
            }
            return customization;
        }
        
        function renderCommentItem(c, type) {
            const isOwner = c.user_id === parseInt('{{ user.id }}');
            const reactions = c.reactions || { 'heart': 0, 'pray': 0, 'cross': 0 };
            const replies = Array.isArray(c.replies) ? c.replies : [];
            const role = (c.user_role || 'user').toLowerCase();
            const roleDisplay = role.replace('_', ' ');
            const replyDisabled = commentRestriction.restricted ? 'disabled' : '';
            const replyKey = `${type}-${c.id}`;
            const replyOpen = openReplyKey === replyKey;
            const replyDraft = replyDrafts[replyKey] || '';
            const canDm = c.user_id && !isOwner;
            
            // Extract equipped items from comment data
            const frameClass = c.equipped_frame ? `profile-frame profile-frame-${c.equipped_frame.item_id}` : '';
            const nameColorClass = c.equipped_name_color ? `profile-name-${c.equipped_name_color.item_id}` : '';
            
            // Build title HTML with fallback
            let titleHtml = '';
            if (c.equipped_title && c.equipped_title.name) {
                const titleIcon = c.equipped_title.icon || '';
                titleHtml = `<span class="user-title user-title-${c.equipped_title.rarity}">${titleIcon} ${c.equipped_title.name}</span>`;
            }
            
            // Build badges HTML with fallback
            const badgesHtml = (c.equipped_badges || []).filter(b => b && b.name).map(b => {
                const badgeIcon = b.icon || '';
                return `<span class="user-badge-icon" title="${b.name}">${badgeIcon}</span>`;
            }).join('');
            
            const chatEffectClass = c.equipped_chat_effect ? `chat-effect-${c.equipped_chat_effect.item_id}` : '';
            
            const avatarHtml = renderAvatarMarkup(c.user_picture, c.user_name, c.avatar_decoration, 'comment-avatar ' + frameClass);
            
            return `
                <div class="comment-item ${chatEffectClass}" id="${type}-${c.id}" data-user-id="${c.user_id || ''}">
                    <button class="delete-comment-btn" onclick="deleteComment(${c.id}, '${type}')" title="Delete (Admin only)">&#10005;</button>
                    <div class="comment-header">
                        ${c.user_id ? `
                            <a class="comment-user-link" href="/u/${c.user_id}">
                                ${avatarHtml}
                            </a>
                        ` : avatarHtml}
                        <div class="comment-meta">
                            <div class="comment-name-row">
                                ${c.user_id ? `
                                    <a class="comment-user-link comment-name ${nameColorClass}" href="/u/${c.user_id}" data-user-id="${c.user_id}">${c.user_name}</a>
                                ` : `
                                    <div class="comment-name ${nameColorClass}">${c.user_name}</div>
                                `}
                                <span class="comment-role-badge comment-role-${role}">${escapeHtml(roleDisplay)}</span>
                                ${badgesHtml}
                                ${titleHtml}
                            </div>
                            <div class="comment-time">${formatLocalTimestamp(c.timestamp)}</div>
                        </div>
                    </div>

                    <div class="comment-text ${chatEffectClass}" data-user-id="${c.user_id || ''}">${escapeHtml(c.text)}</div>
                    <div class="reaction-bar">
                        <button class="reaction-btn" onclick="addReaction(${c.id}, '${type}', 'heart', this)"> ${reactions['heart'] || 0}</button>
                        <button class="reaction-btn" onclick="addReaction(${c.id}, '${type}', 'pray', this)"> ${reactions['pray'] || 0}</button>
                        <button class="reaction-btn" onclick="addReaction(${c.id}, '${type}', 'cross', this)"> ${reactions['cross'] || 0}</button>
                        <button class="reply-btn" ${replyDisabled} onclick="showReplyBox(${c.id}, '${type}')">Reply (${c.reply_count || replies.length || 0})</button>
                        ${canDm ? `<button class="reply-btn dm-btn" data-user-id="${c.user_id}" data-user-name="${escapeHtml(c.user_name || 'User')}" data-user-picture="${escapeHtml(c.user_picture || '')}" data-user-decor="${escapeHtml(c.avatar_decoration || '')}">DM</button>` : ''}
                    </div>
                    <div class="comment-replies" id="replies-${type}-${c.id}">${renderReplies(replies)}</div>
                    <div class="reply-input-area" id="reply-box-${type}-${c.id}" style="display: ${replyOpen ? 'flex' : 'none'};">
                        <input type="text" class="comment-input" name="reply_text" autocomplete="off" data-form-type="other" placeholder="Write a reply..." id="reply-input-${type}-${c.id}" value="${escapeHtml(replyDraft)}" ${replyDisabled} oninput="trackReplyDraft('${replyKey}', this.value)" onfocus="setReplyEditing('${replyKey}', true)" onblur="setReplyEditing('${replyKey}', false)" onkeydown="if(event.key==='Enter')postReply(${c.id}, '${type}')">
                        <button class="send-btn" ${replyDisabled} onclick="postReply(${c.id}, '${type}')">Send</button>
                    </div>
                </div>
            `;
        }
        
        // Function to apply shop effects to all visible comments
        async function applyShopEffectsToComments() {
            const comments = document.querySelectorAll('.comment-item[data-user-id]');
            const userIds = new Set();
            
            comments.forEach(comment => {
                const userId = comment.dataset.userId;
                if (userId) userIds.add(userId);
            });
            
            // Fetch all customizations in parallel
            await Promise.all(Array.from(userIds).map(async (userId) => {
                await fetchUserCustomization(userId);
            }));
            
            // Apply effects
            comments.forEach(comment => {
                const userId = comment.dataset.userId;
                if (userId && userCustomizationCache.has(userId)) {
                    applyShopEffectsToElement(comment, userCustomizationCache.get(userId));
                }
            });
        }

        function renderReplies(replies) {
            if (!Array.isArray(replies) || !replies.length) return '';
            return replies.map(r => {
                const role = String(r.user_role || 'user').toLowerCase();
                const roleDisplay = role.replace('_', ' ');
                
                // Extract equipped items from reply data
                const frameClass = r.equipped_frame ? `profile-frame profile-frame-${r.equipped_frame.item_id}` : '';
                const nameColorClass = r.equipped_name_color ? `profile-name-${r.equipped_name_color.item_id}` : '';
                
                // Build title HTML with fallback
                let titleHtml = '';
                if (r.equipped_title && r.equipped_title.name) {
                    const titleIcon = r.equipped_title.icon || '';
                    titleHtml = `<span class="user-title user-title-${r.equipped_title.rarity}">${titleIcon} ${r.equipped_title.name}</span>`;
                }
                
                // Build badges HTML with fallback
                const badgesHtml = (r.equipped_badges || []).filter(b => b && b.name).map(b => {
                    const badgeIcon = b.icon || '';
                    return `<span class="user-badge-icon" title="${b.name}">${badgeIcon}</span>`;
                }).join('');
                
                const chatEffectClass = r.equipped_chat_effect ? `chat-effect-${r.equipped_chat_effect.item_id}` : '';
                
                const avatarHtml = renderAvatarMarkup(r.user_picture || '', r.user_name || 'User', r.avatar_decoration || '', 'comment-avatar ' + frameClass);
                return `
                    <div class="comment-item reply-item ${chatEffectClass}" style="margin-left: 26px; margin-top: 8px; border-left: 2px solid rgba(255,255,255,0.12);" data-user-id="${r.user_id || ''}">
                        <div class="comment-header">
                            ${r.user_id ? `
                                <a class="comment-user-link" href="/u/${r.user_id}">
                                    ${avatarHtml}
                                </a>
                            ` : avatarHtml}
                            <div class="comment-meta">
                                <div class="comment-name-row">
                                    ${r.user_id ? `
                                        <a class="comment-user-link comment-name ${nameColorClass}" href="/u/${r.user_id}" data-user-id="${r.user_id}">${escapeHtml(r.user_name || 'Anonymous')}</a>
                                    ` : `
                                        <div class="comment-name ${nameColorClass}">${escapeHtml(r.user_name || 'Anonymous')}</div>
                                    `}
                                    <span class="comment-role-badge comment-role-${role}">${escapeHtml(roleDisplay)}</span>
                                    ${badgesHtml}
                                    ${titleHtml}
                                </div>
                                <div class="comment-time">${r.timestamp ? formatLocalTimestamp(r.timestamp) : ''}</div>
                            </div>
                        </div>
                        <div class="comment-text ${chatEffectClass}" data-user-id="${r.user_id || ''}">${escapeHtml(r.text || '')}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteComment(id, type) {
            if (!isAdmin) return;
            
            if (!confirm('Delete this ' + (type === 'comment' ? 'comment' : 'message') + '?')) return;
            
            try {
                const endpoint = type === 'comment' ? `/api/admin/delete_comment/${id}` : `/api/admin/delete_community/${id}`;
                const res = await fetch(endpoint, {method: 'DELETE'});
                
                if (res.ok) {
                    const row = document.getElementById(`${type}-${id}`);
                    if (row) row.remove();
                    showToast('Deleted successfully');
                    if (type === 'community') {
                        loadCommunityMessages();
                    } else {
                        loadComments();
                    }
                    loadProfileStats();
                }
            } catch (e) {
                showToast('Failed to delete');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderAvatarMarkup(url, name, decor, imgClass) {
            const safeName = name || 'User';
            const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(safeName)}&background=random`;
            const avatarUrl = url || '';
            const decorAnim = (typeof DECOR_ANIMATIONS === 'object' && DECOR_ANIMATIONS[decor]) ? ` ${DECOR_ANIMATIONS[decor]}` : '';
            const decorImg = decor ? `<img class="avatar-decor${decorAnim}" src="${decor}" alt="">` : '';
            return `
                <span class="avatar-wrap">
                    <img src="${avatarUrl}" class="${imgClass}" onerror="this.src='${fallback}'">
                    ${decorImg}
                </span>
            `;
        }

        // Profile Stats
        function parseCreatedAt(value) {
            if (!value) return null;
            if (typeof value === 'number') {
                const ms = value > 1e12 ? value : value * 1000;
                const d = new Date(ms);
                return Number.isNaN(d.getTime()) ? null : d;
            }
            const str = String(value).trim();
            if (!str) return null;
            const lowered = str.toLowerCase();
            if (lowered === 'none' || lowered === 'null' || lowered === 'undefined') return null;
            if (/^\d+$/.test(str)) {
                const num = Number(str);
                const ms = num > 1e12 ? num : num * 1000;
                const d = new Date(ms);
                return Number.isNaN(d.getTime()) ? null : d;
            }
            let d = new Date(str);
            if (Number.isNaN(d.getTime())) {
                let candidate = str.replace(' ', 'T');
                candidate = candidate.replace(' UTC', 'Z');
                d = new Date(candidate);
            }
            if (Number.isNaN(d.getTime())) return null;
            return d;
        }

        async function loadProfileStats() {
            let stats = null;
            try {
                const res = await fetch('/api/stats');
                if (res.ok) {
                    stats = await res.json();
                }
            } catch (_) {}

            const safeStats = stats || { total_verses: 0, liked: 0, saved: 0, comments: 0, replies: 0 };
            document.getElementById('statVerses').textContent = safeStats.total_verses ?? 0;
            document.getElementById('statLiked').textContent = safeStats.liked ?? 0;
            document.getElementById('statSaved').textContent = safeStats.saved ?? 0;
            document.getElementById('statComments').textContent = safeStats.comments ?? 0;
            if (document.getElementById('statReplies')) {
                document.getElementById('statReplies').textContent = safeStats.replies || 0;
            }
            
            let userData = {};
            try {
                const userRes = await fetch('/api/user_info');
                if (userRes.ok) {
                    userData = await userRes.json();
                }
            } catch (_) {}
            const profileEl = document.getElementById('profile');
            const fallbackCreated = profileEl?.dataset?.createdAt || '';
            const fallbackName = profileEl?.dataset?.userName || '';
            const fallbackEmail = profileEl?.dataset?.userEmail || '';
            const fallbackPicture = profileEl?.dataset?.userPicture || '';
            const fallbackUserId = profileEl?.dataset?.userId || '';
            const effectiveName = userData.name || fallbackName || 'User';
            const effectiveEmail = userData.email || fallbackEmail || '';
            const effectivePicture = userData.picture || fallbackPicture || '';
            const effectiveDecor = userData.avatar_decoration || profileEl?.dataset?.userDecor || '';
            if (profileEl) profileEl.dataset.userDecor = effectiveDecor || '';
            const nameEl = document.getElementById('profileUserName');
            if (nameEl) nameEl.textContent = effectiveName;
            const emailEl = document.getElementById('profileEmail');
            if (emailEl) emailEl.textContent = effectiveEmail;
            const avatarEl = document.getElementById('profileAvatar');
            if (avatarEl && effectivePicture) avatarEl.src = effectivePicture;
            updateHeaderAvatar(effectivePicture);
            applyAvatarDecoration(effectiveDecor);
            renderAvatarDecorations();
            const idEl = document.getElementById('profileUserId');
            if (idEl) {
                const idVal = userData.id || fallbackUserId;
                idEl.textContent = idVal ? `ID: ${idVal}` : 'ID: ';
            }
            
            const memberEl = document.getElementById('memberSince');
            if (memberEl) {
                const rawCreated = userData.created_at || fallbackCreated || '';
                const date = parseCreatedAt(rawCreated);
                if (date) {
                    memberEl.textContent = date.toLocaleDateString();
                } else {
                    const match = String(rawCreated).match(/\d{4}-\d{2}-\d{2}/);
                    memberEl.textContent = match ? match[0] : '';
                }
            }

            const roleTag = document.getElementById('roleTag');
            if (roleTag) {
                const baseRole = String(userData.role || 'user');
                const effectiveRole = pickHigherRole(baseRole, userRole || baseRole);
                if (effectiveRole && effectiveRole !== 'user') {
                    roleTag.style.display = 'inline-block';
                    roleTag.textContent = effectiveRole.replace('_', ' ').toUpperCase();
                } else {
                    roleTag.style.display = 'none';
                }
            }
            
            // Load new profile features
            loadStreak();
            loadAchievements(safeStats);
            loadFavoriteBooks();
            loadVerseHistory();
            updateXpDisplay();
            
            // Load profile customizations from shop
            loadProfileCustomization();
        }
        
        // Global variable to store current user's shop customization
        let currentUserCustomization = null;
        
        async function loadProfileCustomization() {
            try {
                const userId = document.getElementById('profile')?.dataset?.userId;
                if (!userId) return;
                
                const res = await fetch(`/api/shop/profile/${userId}`);
                if (!res.ok) return;
                
                const data = await res.json();
                currentUserCustomization = data;
                
                // Apply frame - check both equipped_frame (from API) and frame
                const frameEl = document.getElementById('profileFrame');
                const equippedFrame = data.equipped_frame || data.frame;
                if (frameEl && equippedFrame) {
                    const effects = equippedFrame.effects || {};
                    const itemId = equippedFrame.item_id || '';
                    frameEl.className = 'profile-frame';
                    
                    // Apply frame based on item_id for more specific styling
                    if (itemId.includes('gold') || effects.frame_color === '#FFD700') frameEl.classList.add('gold');
                    else if (itemId.includes('silver') || effects.frame_color === '#C0C0C0') frameEl.classList.add('silver');
                    else if (itemId.includes('bronze') || effects.frame_color === '#CD7F32') frameEl.classList.add('bronze');
                    else if (itemId.includes('angel') || effects.frame_style === 'wings') frameEl.classList.add('angel');
                    else if (itemId.includes('cross') || effects.frame_style === 'cross') frameEl.classList.add('cross');
                    else if (itemId.includes('heart') || effects.frame_style === 'heart') frameEl.classList.add('heart');
                    else if (itemId.includes('fire') || effects.frame_style === 'fire') frameEl.classList.add('fire');
                    else if (itemId.includes('ice') || effects.frame_color === '#00CED1') frameEl.classList.add('ice');
                    else if (itemId.includes('nature') || effects.frame_style === 'nature') frameEl.classList.add('nature');
                    else if (itemId.includes('stars') || effects.frame_style === 'stars') frameEl.classList.add('stars');
                    else if (itemId.includes('wood')) frameEl.classList.add('wood');
                    else if (itemId.includes('stone')) frameEl.classList.add('stone');
                    else if (itemId.includes('divine')) frameEl.classList.add('divine');
                    else if (itemId.includes('cosmic')) frameEl.classList.add('cosmic');
                    else if (itemId.includes('infinity')) frameEl.classList.add('infinity');
                } else if (frameEl) {
                    frameEl.className = 'profile-frame';
                }
                
                // Apply name color - check both equipped_name_color and name_color
                const nameEl = document.getElementById('profileUserName');
                const equippedNameColor = data.equipped_name_color || data.name_color;
                if (nameEl && equippedNameColor) {
                    const effects = equippedNameColor.effects || {};
                    const itemId = equippedNameColor.item_id || '';
                    nameEl.className = 'user-name';
                    
                    if (effects.gradient || itemId.includes('rainbow')) nameEl.classList.add('rainbow');
                    else if (itemId.includes('gold') || effects.color === '#FFD700') nameEl.classList.add('gold');
                    else if (itemId.includes('neon') || effects.color === '#39FF14') nameEl.classList.add('neon');
                    else if (itemId.includes('blue') || effects.color === '#0A84FF') nameEl.classList.add('blue');
                    else if (itemId.includes('red') || effects.color === '#FF375F') nameEl.classList.add('red');
                    else if (itemId.includes('purple') || effects.color === '#BF5AF2') nameEl.classList.add('purple');
                    else if (itemId.includes('green') || effects.color === '#30D158') nameEl.classList.add('green');
                    else if (itemId.includes('pink') || effects.color === '#FF69B4') nameEl.classList.add('pink');
                    else if (effects.color) nameEl.style.color = effects.color;
                }
                
                // Apply title - check both equipped_title and title
                const titleEl = document.getElementById('profileTitle');
                const equippedTitle = data.equipped_title || data.title;
                if (titleEl && equippedTitle) {
                    const effects = equippedTitle.effects || {};
                    const rarity = equippedTitle.rarity || 'common';
                    titleEl.innerHTML = `<span class="user-title ${rarity}">${effects.title || equippedTitle.name || ''}</span>`;
                } else if (titleEl) {
                    titleEl.textContent = '';
                }
                
                // Apply badges - check both equipped_badges and badges
                const badgesEl = document.getElementById('profileBadges');
                const equippedBadges = data.equipped_badges || data.badges;
                if (badgesEl && equippedBadges && equippedBadges.length > 0) {
                    badgesEl.innerHTML = equippedBadges.map(b => {
                        const effects = b.effects || {};
                        return `<span class="profile-badge" style="background: ${effects.color || 'var(--primary)'}" title="${b.name}">${b.icon}</span>`;
                    }).join('');
                } else if (badgesEl) {
                    badgesEl.innerHTML = '';
                }
                
                // Apply profile background - check both equipped_profile_bg and profile_bg
                const profileCard = document.getElementById('profileCard');
                const equippedProfileBg = data.equipped_profile_bg || data.profile_bg;
                if (profileCard) {
                    profileCard.classList.remove('profile-bg-golden', 'profile-bg-night', 'profile-bg-clouds', 'profile-bg-nature', 'profile-bg-ocean', 'profile-bg-fire');
                    if (equippedProfileBg) {
                        const effects = equippedProfileBg.effects || {};
                        const itemId = equippedProfileBg.item_id || '';
                        
                        if (itemId.includes('golden') || (effects.bg_style === 'gradient' && effects.colors && effects.colors[0] === '#FFD700')) {
                            profileCard.classList.add('profile-bg-golden');
                        } else if (itemId.includes('night') || effects.bg_style === 'stars') {
                            profileCard.classList.add('profile-bg-night');
                        } else if (itemId.includes('clouds') || effects.bg_style === 'clouds') {
                            profileCard.classList.add('profile-bg-clouds');
                        } else if (itemId.includes('nature') || effects.bg_style === 'nature') {
                            profileCard.classList.add('profile-bg-nature');
                        } else if (itemId.includes('ocean') || effects.bg_style === 'waves') {
                            profileCard.classList.add('profile-bg-ocean');
                        } else if (itemId.includes('fire') || effects.bg_style === 'fire') {
                            profileCard.classList.add('profile-bg-fire');
                        } else if (effects.bg_style === 'gradient' && effects.colors) {
                            profileCard.style.background = `linear-gradient(135deg, ${effects.colors.join(', ')})`;
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading profile customization:', e);
            }
        }
        
        // Function to get another user's customization for displaying their items in comments/chat
        async function getUserCustomization(userId) {
            try {
                const res = await fetch(`/api/shop/profile/${userId}`);
                if (!res.ok) return null;
                return await res.json();
            } catch (e) {
                return null;
            }
        }
        
        // Function to apply shop effects to a comment/chat element
        function applyShopEffectsToElement(element, customization) {
            if (!customization) return;
            
            // Apply name color
            const nameEl = element.querySelector('.user-name, .comment-name, .message-name');
            if (nameEl && customization.name_color) {
                const effects = customization.name_color.effects || {};
                const itemId = customization.name_color.item_id || '';
                nameEl.classList.add('user-name');
                
                if (effects.gradient || itemId.includes('rainbow')) nameEl.classList.add('rainbow');
                else if (itemId.includes('gold') || effects.color === '#FFD700') nameEl.classList.add('gold');
                else if (itemId.includes('neon') || effects.color === '#39FF14') nameEl.classList.add('neon');
                else if (itemId.includes('blue') || effects.color === '#0A84FF') nameEl.classList.add('blue');
                else if (itemId.includes('red') || effects.color === '#FF375F') nameEl.classList.add('red');
                else if (itemId.includes('purple') || effects.color === '#BF5AF2') nameEl.classList.add('purple');
                else if (itemId.includes('green') || effects.color === '#30D158') nameEl.classList.add('green');
                else if (itemId.includes('pink') || effects.color === '#FF69B4') nameEl.classList.add('pink');
            }
            
            // Apply title - only if not already present
            // Server-rendered titles use class .user-title-{rarity} (e.g., user-title-legendary)
            if (customization.title && nameEl) {
                // Check if ANY title already exists (server-rendered uses user-title-* pattern)
                const existingAnyTitle = element.querySelector('[class*="user-title-"], .user-title');
                const existingDynamicTitle = element.querySelector('.user-title[data-shop-effect="true"]');
                if (!existingAnyTitle && !existingDynamicTitle) {
                    const titleName = customization.title.name || customization.title.effects?.title;
                    if (titleName) {
                        const rarity = customization.title.rarity || 'common';
                        const titleIcon = customization.title.icon || '';
                        const titleSpan = document.createElement('span');
                        titleSpan.className = `user-title ${rarity}`;
                        titleSpan.setAttribute('data-shop-effect', 'true');
                        titleSpan.textContent = `${titleIcon} ${titleName}`.trim();
                        nameEl.parentNode.insertBefore(titleSpan, nameEl);
                    }
                }
            }
            
            // Apply badges - only if not already present
            // Server-rendered badges use .user-badge-icon class
            if (customization.badges && customization.badges.length > 0 && nameEl) {
                const existingAnyBadges = element.querySelector('.user-badge-icon');
                const existingDynamicBadges = element.querySelector('.user-badges[data-shop-effect="true"]');
                if (!existingAnyBadges && !existingDynamicBadges) {
                    const validBadges = customization.badges.filter(b => b && (b.icon || b.name));
                    if (validBadges.length > 0) {
                        const badgesSpan = document.createElement('span');
                        badgesSpan.className = 'user-badges';
                        badgesSpan.setAttribute('data-shop-effect', 'true');
                        badgesSpan.innerHTML = validBadges.map(b => {
                            const badgeIcon = b.icon || '';
                            return `<span class="user-badge-small" style="background: ${b.effects?.color || 'var(--primary)'}" title="${b.name}">${badgeIcon}</span>`;
                        }).join('');
                        nameEl.parentNode.insertBefore(badgesSpan, nameEl.nextSibling);
                    }
                }
            }
            
            // Apply avatar frame
            const avatarEl = element.querySelector('.comment-avatar, .message-avatar, .user-avatar');
            if (avatarEl && customization.frame) {
                const effects = customization.frame.effects || {};
                const itemId = customization.frame.item_id || '';
                let frameDiv = avatarEl.querySelector('.comment-avatar-frame');
                if (!frameDiv) {
                    frameDiv = document.createElement('div');
                    frameDiv.className = 'comment-avatar-frame';
                    avatarEl.appendChild(frameDiv);
                }
                
                if (itemId.includes('gold') || effects.frame_color === '#FFD700') frameDiv.classList.add('gold');
                else if (itemId.includes('silver') || effects.frame_color === '#C0C0C0') frameDiv.classList.add('silver');
                else if (itemId.includes('bronze') || effects.frame_color === '#CD7F32') frameDiv.classList.add('bronze');
                else if (itemId.includes('angel') || effects.frame_style === 'wings') frameDiv.classList.add('angel');
                else if (itemId.includes('cross') || effects.frame_style === 'cross') frameDiv.classList.add('cross');
                else if (itemId.includes('heart') || effects.frame_style === 'heart') frameDiv.classList.add('heart');
                else if (itemId.includes('fire') || effects.frame_style === 'fire') frameDiv.classList.add('fire');
                else if (itemId.includes('ice') || effects.frame_color === '#00CED1') frameDiv.classList.add('ice');
                else if (itemId.includes('nature') || effects.frame_style === 'nature') frameDiv.classList.add('nature');
                else if (itemId.includes('stars') || effects.frame_style === 'stars') frameDiv.classList.add('stars');
            }
            
            // Apply chat effect
            const messageEl = element.querySelector('.comment-text, .message-text');
            if (messageEl && customization.chat_effect) {
                const effects = customization.chat_effect.effects || {};
                const itemId = customization.chat_effect.item_id || '';
                
                if (itemId.includes('sparkle') || effects.effect === 'sparkle') messageEl.classList.add('sparkle');
                else if (itemId.includes('rainbow') || effects.effect === 'rainbow') messageEl.classList.add('rainbow-text');
                else if (itemId.includes('glow') || effects.effect === 'glow') messageEl.classList.add('glow');
                else if (itemId.includes('fire') || effects.effect === 'fire') messageEl.classList.add('fire-text');
            }
        }

        const AVATAR_DECORATIONS = [
            { name: 'Halo', url: '/static/images/decorations/halo.svg' },
            { name: 'Radiant', url: '/static/images/decorations/radiant.svg' },
            { name: 'Laurel', url: '/static/images/decorations/laurel.svg' },
            { name: 'Crown', url: '/static/images/decorations/crown.svg' },
            { name: 'Sparkle', url: '/static/images/decorations/sparkle.svg' },
            { name: 'Sunburst', url: '/static/images/decorations/sunburst.svg' },
            { name: 'Wings', url: '/static/images/decorations/wings.svg' },
            { name: 'Flame', url: '/static/images/decorations/flame.svg' },
            { name: 'Electric', url: '/static/images/decorations/electric.svg' },
            { name: 'Ice', url: '/static/images/decorations/ice.svg' },
            { name: 'Rose', url: '/static/images/decorations/rose.svg' },
            { name: 'Shield', url: '/static/images/decorations/shield.svg' },
            { name: 'Orbit', url: '/static/images/decorations/orbit.svg' },
            { name: 'Royal Frame', url: 'https://openclipart.org/image/800px/354763' },
            { name: 'Golden Laurel', url: 'https://openclipart.org/image/800px/227363' },
            { name: 'Laurel Classic', url: 'https://openclipart.org/image/800px/282511' },
            { name: 'Floral Wreath', url: 'https://openclipart.org/image/800px/253120' },
            { name: 'Winged Frame', url: 'https://openclipart.org/image/800px/352754' },
            { name: 'Winged Heart', url: 'https://openclipart.org/image/800px/228243' },
            { name: 'Doodle Wings', url: 'https://openclipart.org/image/800px/292258' }
        ];

        const DECOR_ANIMATIONS = {
            '/static/images/decorations/orbit.svg': 'spin',
            '/static/images/decorations/electric.svg': 'pulse',
            'https://openclipart.org/image/800px/354763': 'spin',
            'https://openclipart.org/image/800px/253120': 'pulse'
        };

        function updateHeaderAvatar(url) {
            const headerImg = document.getElementById('headerAvatarImg');
            if (headerImg && url) headerImg.src = url;
        }

        function applyAvatarDecoration(url) {
            currentAvatarDecoration = url || '';
            const headerDecor = document.getElementById('headerAvatarDecor');
            const profileDecor = document.getElementById('profileAvatarDecor');
            const onlineDecor = document.getElementById('onlineAvatarDecor');
            [headerDecor, profileDecor, onlineDecor].forEach(el => {
                if (!el) return;
                el.classList.remove('spin', 'pulse');
                if (!currentAvatarDecoration) {
                    el.classList.add('hidden');
                    el.removeAttribute('src');
                } else {
                    el.src = currentAvatarDecoration;
                    el.classList.remove('hidden');
                    if (DECOR_ANIMATIONS[currentAvatarDecoration]) {
                        el.classList.add(DECOR_ANIMATIONS[currentAvatarDecoration]);
                    }
                }
            });
        }

        function renderAvatarDecorations() {
            const grid = document.getElementById('avatarDecorPresets');
            if (!grid) return;
            if (!AVATAR_DECORATIONS.length) {
                grid.innerHTML = '<div class="shop-note">No presets yet. Upload a decoration or paste a GIF URL.</div>';
                return;
            }
            grid.innerHTML = AVATAR_DECORATIONS.map(d => `
                <div class="decor-option ${currentAvatarDecoration === d.url ? 'active' : ''}" onclick="setAvatarDecorationPreset('${d.url}')">
                    <img src="${d.url}" alt="${escapeHtml(d.name || '')}">
                    <div style="font-size:11px; text-align:center;">${escapeHtml(d.name || 'Decoration')}</div>
                </div>
            `).join('');
        }

        function setAvatarDecorationPreset(url) {
            if (!url) return;
            saveAvatarDecorationUrl(url);
        }

        async function saveProfilePictureUrl() {
            const input = document.getElementById('avatarUrlInput');
            const url = (input?.value || '').trim();
            if (!url) return;
            const res = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kind: 'picture', url })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Update failed');
                return;
            }
            updateHeaderAvatar(data.picture);
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar && data.picture) profileAvatar.src = data.picture;
            const profileEl = document.getElementById('profile');
            if (profileEl && data.picture) profileEl.dataset.userPicture = data.picture;
            showToast('Profile picture updated');
        }

        async function resetProfilePicture() {
            const res = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kind: 'picture', reset: true })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Reset failed');
                return;
            }
            updateHeaderAvatar(data.picture);
            const profileAvatar = document.getElementById('profileAvatar');
            if (profileAvatar && data.picture) profileAvatar.src = data.picture;
            const profileEl = document.getElementById('profile');
            if (profileEl && data.picture) profileEl.dataset.userPicture = data.picture;
            showToast('Profile picture reset');
        }

        async function saveAvatarDecorationUrl(urlOverride = '') {
            const input = document.getElementById('decorUrlInput');
            const url = (urlOverride || input?.value || '').trim();
            if (!url) return;
            const res = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kind: 'decoration', url })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Update failed');
                return;
            }
            applyAvatarDecoration(data.avatar_decoration);
            renderAvatarDecorations();
            showToast('Decoration applied');
        }

        async function clearAvatarDecoration() {
            const res = await fetch('/api/user/avatar', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ kind: 'decoration', reset: true })
            });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Clear failed');
                return;
            }
            applyAvatarDecoration('');
            renderAvatarDecorations();
            showToast('Decoration cleared');
        }

        async function uploadAvatar(kind) {
            const input = kind === 'decoration' ? document.getElementById('decorUploadInput') : document.getElementById('avatarUploadInput');
            const file = input?.files?.[0];
            if (!file) {
                showToast('Select a file first');
                return;
            }
            const form = new FormData();
            form.append('file', file);
            form.append('kind', kind);
            if (kind === 'picture') {
                const removeBg = document.getElementById('avatarRemoveBgToggle');
                form.append('remove_bg', removeBg && removeBg.checked ? '1' : '0');
            }
            const res = await fetch('/api/user/avatar-upload', { method: 'POST', body: form });
            const data = await res.json().catch(() => ({}));
            if (!res.ok || data.error) {
                showToast(data.error || 'Upload failed');
                return;
            }
            if (kind === 'picture') {
                updateHeaderAvatar(data.picture);
                const profileAvatar = document.getElementById('profileAvatar');
                if (profileAvatar && data.picture) profileAvatar.src = data.picture;
                const profileEl = document.getElementById('profile');
                if (profileEl && data.picture) profileEl.dataset.userPicture = data.picture;
                showToast(data.warning ? `Uploaded (note: ${data.warning})` : 'Profile picture uploaded');
            } else {
                applyAvatarDecoration(data.avatar_decoration);
                renderAvatarDecorations();
                showToast('Decoration uploaded');
            }
        }

        // === PROFILE ADD-ONS ===

        // 1. READING STREAK
        function loadStreak() {
            const streakData = JSON.parse(localStorage.getItem('verseStreak') || '{}');
            const today = new Date().toDateString();
            const lastVisit = streakData.lastVisit;
            let streak = streakData.streak || 0;
            
            // Check if this is a new day
            if (lastVisit !== today) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastVisit === yesterday.toDateString()) {
                    streak++;
                } else if (lastVisit !== today) {
                    streak = 1;
                }
                
                streakData.streak = streak;
                streakData.lastVisit = today;
                localStorage.setItem('verseStreak', JSON.stringify(streakData));
            }
            
            // Update UI
            document.getElementById('streakBadge').textContent = streak + (streak === 1 ? ' DAY' : ' DAYS');
            
            const messages = [
                "Start your streak today! ",
                "Keep it going! You're on fire! ",
                "3 days! Building a habit! ",
                "4 days! Consistency is key! ",
                "5 days! Halfway to a week! ",
                "6 days! Almost there! ",
                "1 WEEK! Incredible dedication! ",
                "Over a week! You're unstoppable! "
            ];
            document.getElementById('streakMessage').textContent = 
                messages[Math.min(streak - 1, messages.length - 1)] || `${streak} days! Amazing discipline! `;
            
            // Generate calendar (last 14 days)
            const calendar = document.getElementById('streakCalendar');
            calendar.innerHTML = '';
            
            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayStr = d.toDateString();
                
                const dayEl = document.createElement('div');
                dayEl.className = 'streak-day';
                dayEl.textContent = ['S','M','T','W','T','F','S'][d.getDay()];
                
                if (i === 0) {
                    dayEl.classList.add('today', 'active');
                } else if (i < streak && streakData.lastVisit === today) {
                    dayEl.classList.add('active');
                } else {
                    dayEl.classList.add('inactive');
                }
                
                calendar.appendChild(dayEl);
            }
        }

        // 2. ACHIEVEMENT BADGES
function getSharedVerseCount() {
    return (localStorage.getItem('sharedVerses') || '').split(',').filter(x => x).length;
}

function getStreakCount() {
    const s = JSON.parse(localStorage.getItem('verseStreak') || '{}');
    return s.streak || 0;
}

const ACHIEVEMENTS = [
    // Like Achievements
    { id: 'first_like', icon: '', name: 'First Love', desc: 'Like your first verse', goal: 1, category: 'likes', xp: 25, progress: (d) => d.liked, check: (d) => d.liked >= 1 },
    { id: 'liker_10', icon: '', name: 'Beginning', desc: 'Like 10 verses', goal: 10, category: 'likes', xp: 50, progress: (d) => d.liked, check: (d) => d.liked >= 10 },
    { id: 'liker_50', icon: '', name: 'Appreciator', desc: 'Like 50 verses', goal: 50, category: 'likes', xp: 100, progress: (d) => d.liked, check: (d) => d.liked >= 50 },
    { id: 'liker_100', icon: '', name: 'Admirer', desc: 'Like 100 verses', goal: 100, category: 'likes', xp: 150, progress: (d) => d.liked, check: (d) => d.liked >= 100 },
    { id: 'liker_200', icon: '', name: 'Enthusiast', desc: 'Like 200 verses', goal: 200, category: 'likes', xp: 250, progress: (d) => d.liked, check: (d) => d.liked >= 200 },
    { id: 'liker_500', icon: '', name: 'Devoted', desc: 'Like 500 verses', goal: 500, category: 'likes', xp: 500, progress: (d) => d.liked, check: (d) => d.liked >= 500 },
    { id: 'liker_1000', icon: '', name: 'Beloved', desc: 'Like 1000 verses', goal: 1000, category: 'likes', xp: 1000, progress: (d) => d.liked, check: (d) => d.liked >= 1000 },
    { id: 'liker_2500', icon: '', name: 'Heart of Gold', desc: 'Like 2500 verses', goal: 2500, category: 'likes', xp: 2500, progress: (d) => d.liked, check: (d) => d.liked >= 2500 },

    // Save Achievements
    { id: 'first_save', icon: '', name: 'Bookmark', desc: 'Save your first verse', goal: 1, category: 'saves', xp: 25, progress: (d) => d.saved, check: (d) => d.saved >= 1 },
    { id: 'collector', icon: '', name: 'Collector', desc: 'Save 10 verses', goal: 10, category: 'saves', xp: 50, progress: (d) => d.saved, check: (d) => d.saved >= 10 },
    { id: 'librarian', icon: '', name: 'Librarian', desc: 'Save 50 verses', goal: 50, category: 'saves', xp: 100, progress: (d) => d.saved, check: (d) => d.saved >= 50 },
    { id: 'archivist', icon: '', name: 'Archivist', desc: 'Save 150 verses', goal: 150, category: 'saves', xp: 200, progress: (d) => d.saved, check: (d) => d.saved >= 150 },
    { id: 'curator', icon: '', name: 'Curator', desc: 'Save 300 verses', goal: 300, category: 'saves', xp: 350, progress: (d) => d.saved, check: (d) => d.saved >= 300 },
    { id: 'vault_keeper', icon: '', name: 'Vault Keeper', desc: 'Save 500 verses', goal: 500, category: 'saves', xp: 500, progress: (d) => d.saved, check: (d) => d.saved >= 500 },
    { id: 'hoarder_1000', icon: '', name: 'Divine Hoarder', desc: 'Save 1000 verses', goal: 1000, category: 'saves', xp: 1000, progress: (d) => d.saved, check: (d) => d.saved >= 1000 },

    // Comment Achievements
    { id: 'first_comment', icon: '', name: 'Voice', desc: 'Post a comment', goal: 1, category: 'comments', xp: 50, progress: (d) => d.comments, check: (d) => d.comments >= 1 },
    { id: 'commenter_5', icon: '', name: 'Engaged', desc: 'Post 5 comments', goal: 5, category: 'comments', xp: 75, progress: (d) => d.comments, check: (d) => d.comments >= 5 },
    { id: 'conversationalist', icon: '', name: 'Chatty', desc: 'Post 25 comments', goal: 25, category: 'comments', xp: 150, progress: (d) => d.comments, check: (d) => d.comments >= 25 },
    { id: 'storyteller', icon: '', name: 'Storyteller', desc: 'Post 75 comments', goal: 75, category: 'comments', xp: 300, progress: (d) => d.comments, check: (d) => d.comments >= 75 },
    { id: 'oracle', icon: '', name: 'Oracle', desc: 'Post 150 comments', goal: 150, category: 'comments', xp: 500, progress: (d) => d.comments, check: (d) => d.comments >= 150 },
    { id: 'scribe', icon: '', name: 'Scribe', desc: 'Post 300 comments', goal: 300, category: 'comments', xp: 800, progress: (d) => d.comments, check: (d) => d.comments >= 300 },
    { id: 'philosopher_500', icon: '', name: 'Philosopher', desc: 'Post 500 comments', goal: 500, category: 'comments', xp: 1200, progress: (d) => d.comments, check: (d) => d.comments >= 500 },

    // Reply Achievements
    { id: 'first_reply', icon: '', name: 'Responder', desc: 'Post your first reply', goal: 1, category: 'replies', xp: 30, progress: (d) => d.replies, check: (d) => d.replies >= 1 },
    { id: 'helper', icon: '', name: 'Helper', desc: 'Post 10 replies', goal: 10, category: 'replies', xp: 75, progress: (d) => d.replies, check: (d) => d.replies >= 10 },
    { id: 'encourager', icon: '', name: 'Encourager', desc: 'Post 50 replies', goal: 50, category: 'replies', xp: 200, progress: (d) => d.replies, check: (d) => d.replies >= 50 },
    { id: 'counselor', icon: '', name: 'Counselor', desc: 'Post 150 replies', goal: 150, category: 'replies', xp: 400, progress: (d) => d.replies, check: (d) => d.replies >= 150 },
    { id: 'mentor_300', icon: '', name: 'Mentor', desc: 'Post 300 replies', goal: 300, category: 'replies', xp: 700, progress: (d) => d.replies, check: (d) => d.replies >= 300 },

    // View/Explorer Achievements
    { id: 'first_view', icon: '', name: 'First Glance', desc: 'View 1 verse', goal: 1, category: 'special', xp: 10, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 1 },
    { id: 'explorer', icon: '', name: 'Explorer', desc: 'View 100 verses', goal: 100, category: 'special', xp: 100, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 100 },
    { id: 'scholar', icon: '', name: 'Scholar', desc: 'View 500 verses', goal: 500, category: 'special', xp: 250, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 500 },
    { id: 'sage', icon: '', name: 'Sage', desc: 'View 1000 verses', goal: 1000, category: 'special', xp: 500, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 1000 },
    { id: 'master', icon: '', name: 'Master', desc: 'View 2500 verses', goal: 2500, category: 'special', xp: 1000, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 2500 },
    { id: 'pilgrim', icon: '', name: 'Pilgrim', desc: 'View 5000 verses', goal: 5000, category: 'special', xp: 2000, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 5000 },
    { id: 'seeker_10000', icon: '', name: 'Divine Seeker', desc: 'View 10000 verses', goal: 10000, category: 'special', xp: 5000, progress: (d) => d.total_verses, check: (d) => d.total_verses >= 10000 },

    // Streak Achievements
    { id: 'first_day', icon: '', name: 'First Day', desc: 'Start your streak', goal: 1, category: 'streak', xp: 25, progress: () => getStreakCount(), check: () => getStreakCount() >= 1 },
    { id: 'three_day_streak', icon: '', name: 'On Fire', desc: '3 day streak', goal: 3, category: 'streak', xp: 100, progress: () => getStreakCount(), check: () => getStreakCount() >= 3 },
    { id: 'week_warrior', icon: '', name: 'Week Warrior', desc: '7 day streak', goal: 7, category: 'streak', xp: 250, progress: () => getStreakCount(), check: () => getStreakCount() >= 7 },
    { id: 'fortnight', icon: '', name: 'Unstoppable', desc: '14 day streak', goal: 14, category: 'streak', xp: 500, progress: () => getStreakCount(), check: () => getStreakCount() >= 14 },
    { id: 'month_master', icon: '', name: 'Month Master', desc: '30 day streak', goal: 30, category: 'streak', xp: 1000, progress: () => getStreakCount(), check: () => getStreakCount() >= 30 },
    { id: 'centurion_100', icon: '', name: 'Centurion', desc: '100 day streak', goal: 100, category: 'streak', xp: 3000, progress: () => getStreakCount(), check: () => getStreakCount() >= 100 },
    { id: 'yearly_365', icon: '', name: 'Faithful', desc: '365 day streak', goal: 365, category: 'streak', xp: 10000, progress: () => getStreakCount(), check: () => getStreakCount() >= 365 },

    // Share Achievements
    { id: 'first_share', icon: '', name: 'Spread the Word', desc: 'Share your first verse', goal: 1, category: 'shares', xp: 50, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 1 },
    { id: 'sharer_3', icon: '', name: 'Messenger', desc: 'Share 3 verses', goal: 3, category: 'shares', xp: 75, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 3 },
    { id: 'share_the_word', icon: '', name: 'Evangelist', desc: 'Share 5 verses', goal: 5, category: 'shares', xp: 150, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 5 },
    { id: 'spreader', icon: '', name: 'Spreader', desc: 'Share 20 verses', goal: 20, category: 'shares', xp: 350, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 20 },
    { id: 'missionary', icon: '', name: 'Missionary', desc: 'Share 50 verses', goal: 50, category: 'shares', xp: 700, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 50 },
    { id: 'apostle_100', icon: '', name: 'Apostle', desc: 'Share 100 verses', goal: 100, category: 'shares', xp: 1500, progress: () => getSharedVerseCount(), check: () => getSharedVerseCount() >= 100 },

    // Shop/Purchase Achievements
    { id: 'first_purchase', icon: '', name: 'First Purchase', desc: 'Buy your first shop item', goal: 1, category: 'special', xp: 100, progress: (d) => d.purchases, check: (d) => d.purchases >= 1 },
    { id: 'shopper_5', icon: '', name: 'Shopper', desc: 'Buy 5 items', goal: 5, category: 'special', xp: 200, progress: (d) => d.purchases, check: (d) => d.purchases >= 5 },
    { id: 'collector_items', icon: '', name: 'Item Collector', desc: 'Buy 15 items', goal: 15, category: 'special', xp: 500, progress: (d) => d.purchases, check: (d) => d.purchases >= 15 },
    { id: 'shopaholic', icon: '', name: 'Shopaholic', desc: 'Buy 30 items', goal: 30, category: 'special', xp: 1000, progress: (d) => d.purchases, check: (d) => d.purchases >= 30 },

    // Time-based Achievements
    { id: 'night_owl', icon: '', name: 'Night Owl', desc: 'Visit after midnight', goal: 1, category: 'special', xp: 50, progress: () => (new Date().getHours() < 5 ? 1 : 0), check: () => new Date().getHours() < 5 },
    { id: 'early_bird', icon: '', name: 'Early Bird', desc: 'Visit before 6am', goal: 1, category: 'special', xp: 50, progress: () => (new Date().getHours() < 6 && new Date().getHours() >= 4 ? 1 : 0), check: () => new Date().getHours() < 6 && new Date().getHours() >= 4 },
    { id: 'noon_prayer', icon: '', name: 'Midday Prayer', desc: 'Visit at noon', goal: 1, category: 'special', xp: 25, progress: () => (new Date().getHours() === 12 ? 1 : 0), check: () => new Date().getHours() === 12 },
    { id: 'evening_reflection', icon: '', name: 'Evening Reflection', desc: 'Visit at 6pm', goal: 1, category: 'special', xp: 25, progress: () => (new Date().getHours() === 18 ? 1 : 0), check: () => new Date().getHours() === 18 },
    
    // Social Achievements
    { id: 'liked_comment', icon: '', name: 'Appreciated', desc: 'Get a like on your comment', goal: 1, category: 'special', xp: 50, progress: (d) => d.liked_comments, check: (d) => d.liked_comments >= 1 },
    { id: 'popular_5', icon: '', name: 'Rising Star', desc: 'Get 5 likes on comments', goal: 5, category: 'special', xp: 100, progress: (d) => d.liked_comments, check: (d) => d.liked_comments >= 5 },
    { id: 'influencer_25', icon: '', name: 'Influencer', desc: 'Get 25 likes on comments', goal: 25, category: 'special', xp: 250, progress: (d) => d.liked_comments, check: (d) => d.liked_comments >= 25 },
    
    // Special Milestones
    { id: 'level_5', icon: '', name: 'Rising', desc: 'Reach level 5', goal: 5, category: 'special', xp: 200, progress: () => userXP.level, check: () => userXP.level >= 5 },
    { id: 'level_10', icon: '', name: 'Climbing', desc: 'Reach level 10', goal: 10, category: 'special', xp: 500, progress: () => userXP.level, check: () => userXP.level >= 10 },
    { id: 'level_25', icon: '', name: 'Veteran', desc: 'Reach level 25', goal: 25, category: 'special', xp: 1500, progress: () => userXP.level, check: () => userXP.level >= 25 },
    { id: 'level_50', icon: '', name: 'Legend', desc: 'Reach level 50', goal: 50, category: 'special', xp: 5000, progress: () => userXP.level, check: () => userXP.level >= 50 }
];

function getAchievementProgress(ach, stats, isUnlocked) {
    const goal = Math.max(1, Number(ach.goal || 1));
    let current = 0;
    if (typeof ach.progress === 'function') {
        current = Number(ach.progress(stats)) || 0;
    } else if (typeof ach.check === 'function') {
        current = ach.check(stats) ? goal : 0;
    }
    if (isUnlocked) current = Math.max(current, goal);
    const pct = Math.max(0, Math.min(100, (current / goal) * 100));
    const label = goal > 1 ? `${Math.min(current, goal)}/${goal}` : (isUnlocked ? 'Complete' : 'Locked');
    return { pct, label };
}

let currentAchievementFilter = 'all';
let currentAchievementStats = {};

async function loadAchievements(stats) {
    // If stats not provided, fetch them
    if (!stats) {
        stats = await fetchUserStats();
    }
    currentAchievementStats = stats;
    const unlocked = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
    let totalXPEarned = 0;
    let newUnlocks = false;
    
    // Check for new unlocks and calculate XP
    ACHIEVEMENTS.forEach(ach => {
        if (unlocked.includes(ach.id)) {
            totalXPEarned += ach.xp || 50;
        } else if (ach.check(stats)) {
            unlocked.push(ach.id);
            totalXPEarned += ach.xp || 50;
            newUnlocks = true;
            const awarded = awardXp(ach.xp || 50, 'achievement', ach.id);
            if (settings.notifications) {
                showToast(` Unlocked: ${ach.name}! +${ach.xp || 50} XP`);
            }
            if (awarded && typeof AudioSys !== 'undefined') AudioSys.playSuccess();
        }
    });
    localStorage.setItem('unlockedAchievements', JSON.stringify(unlocked));
    
    // Update achievements list
    renderAchievementsList();
    
    // Update achievements stats header
    const completedEl = document.getElementById('achievementsCompleted');
    const xpEl = document.getElementById('achievementsXP');
    if (completedEl) completedEl.textContent = `${unlocked.length}/${ACHIEVEMENTS.length} Completed`;
    if (xpEl) xpEl.textContent = `+${totalXPEarned} XP Earned`;
    
    return newUnlocks;
}

async function fetchUserStats() {
    try {
        const res = await fetch('/api/profile_stats');
        if (!res.ok) return userStats;
        return await res.json();
    } catch (e) {
        return userStats;
    }
}

function renderAchievementsList() {
    const container = document.getElementById('achievementsList');
    if (!container) return;
    
    const unlocked = JSON.parse(localStorage.getItem('unlockedAchievements') || '[]');
    const stats = currentAchievementStats;
    
    // Filter achievements
    let achievementsToShow = ACHIEVEMENTS;
    if (currentAchievementFilter !== 'all') {
        achievementsToShow = ACHIEVEMENTS.filter(ach => ach.category === currentAchievementFilter);
    }
    
    container.innerHTML = achievementsToShow.map(ach => {
        const isUnlocked = unlocked.includes(ach.id);
        const progress = getAchievementProgress(ach, stats, isUnlocked);
        const categoryLabels = {
            likes: 'Likes', saves: 'Saves', comments: 'Comments', 
            replies: 'Replies', streak: 'Streaks', shares: 'Shares', special: 'Special'
        };
        
        return `
            <div class="achievement-item ${isUnlocked ? 'completed' : ''}" 
                 onclick="showAchievementDetail('${ach.id}', ${isUnlocked})"
                 data-ach-id="${ach.id}">
                <div class="achievement-icon">${ach.icon}</div>
                <div class="achievement-content">
                    <div class="achievement-name">
                        ${ach.name}
                        <span class="achievement-category-tag">${categoryLabels[ach.category] || ach.category}</span>
                        ${isUnlocked ? '' : ''}
                    </div>
                    <div class="achievement-desc">${ach.desc}</div>
                    <div class="achievement-reward"> +${ach.xp || 50} XP</div>
                    <div class="achievement-progress">
                        <div class="achievement-progress-bar">
                            <div class="achievement-progress-fill" style="width: ${progress.pct}%"></div>
                        </div>
                        <div class="achievement-progress-text">${progress.label}</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function filterAchievements(category) {
    currentAchievementFilter = category;
    
    // Update active button
    document.querySelectorAll('.achievement-categories .shop-category-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase().includes(category) || 
            (category === 'all' && btn.textContent.includes('All'))) {
            btn.classList.add('active');
        }
    });
    
    renderAchievementsList();
}

function showAchievementDetail(achId, isUnlocked) {
    const ach = ACHIEVEMENTS.find(a => a.id === achId);
    if (!ach) return;
    
    const stats = currentAchievementStats;
    const progress = getAchievementProgress(ach, stats, isUnlocked);
    
    // Remove existing detail panels
    document.querySelectorAll('.achievement-detail-panel, .achievement-detail-overlay').forEach(el => el.remove());
    
    // Create overlay for mobile
    const overlay = document.createElement('div');
    overlay.className = 'achievement-detail-overlay';
    overlay.onclick = () => {
        overlay.classList.remove('visible');
        panel.classList.remove('visible');
        setTimeout(() => {
            overlay.remove();
            panel.remove();
        }, 200);
    };
    document.body.appendChild(overlay);
    
    // Create detail panel
    const panel = document.createElement('div');
    panel.className = 'achievement-detail-panel';
    panel.innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <div style="font-size: 48px;">${ach.icon}</div>
            <div>
                <div style="font-weight: 700; font-size: 18px;">${ach.name}</div>
                <div style="font-size: 13px; color: var(--text-secondary);">${ach.desc}</div>
            </div>
        </div>
        <div style="background: var(--glass); padding: 12px; border-radius: 8px; margin-bottom: 12px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Status:</span>
                <span style="color: ${isUnlocked ? 'var(--success)' : 'var(--text-secondary)'}; font-weight: 600;">
                    ${isUnlocked ? ' Completed' : 'Locked'}
                </span>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span>Reward:</span>
                <span style="color: var(--primary); font-weight: 600;"> ${ach.xp || 50} XP</span>
            </div>
            <div style="display: flex; justify-content: space-between;">
                <span>Progress:</span>
                <span>${progress.label}</span>
            </div>
        </div>
        <div class="achievement-progress-bar" style="margin-bottom: 8px;">
            <div class="achievement-progress-fill" style="width: ${progress.pct}%; background: ${isUnlocked ? 'var(--success)' : 'var(--primary)'};"></div>
        </div>
        <div style="text-align: center; font-size: 12px; color: var(--text-secondary);">
            ${isUnlocked ? 'Great job! Keep going!' : 'Keep working to unlock this achievement!'}
        </div>
    `;
    document.body.appendChild(panel);
    
    // Show with animation
    requestAnimationFrame(() => {
        overlay.classList.add('visible');
        panel.classList.add('visible');
    });
    
    // Auto-hide after 4 seconds on desktop
    const isMobile = window.innerWidth <= 768;
    if (!isMobile) {
        setTimeout(() => {
            overlay.classList.remove('visible');
            panel.classList.remove('visible');
            setTimeout(() => {
                overlay.remove();
                panel.remove();
            }, 200);
        }, 4000);
    }
}

// Check achievement when stats update
async function checkAchievement(type, value) {
    userStats[type] = value;
    await loadAchievements(userStats);
}

        // 3. FAVORITE BOOKS CHART
        async function loadFavoriteBooks() {
            const container = document.getElementById('favoriteBooksChart');
            container.innerHTML = '';
            
            try {
                // Get liked and saved verses
                const [likedRes, savedRes] = await Promise.all([
                    fetch('/api/liked_verses'),
                    fetch('/api/saved_verses')
                ]);
                const liked = await likedRes.json();
                const saved = await savedRes.json();
                
                // Count by book
                const bookCounts = {};
                [...liked, ...saved].forEach(v => {
                    const book = v.book || v.ref?.split(' ')[0] || 'Unknown';
                    bookCounts[book] = (bookCounts[book] || 0) + 1;
                });
                
                // Sort and get top 5
                const sorted = Object.entries(bookCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (sorted.length === 0) {
                    container.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Start liking verses to see your favorites!</div>';
                    return;
                }
                
                const maxCount = sorted[0][1];
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
                
                sorted.forEach(([book, count], i) => {
                    const bar = document.createElement('div');
                    bar.className = 'book-bar';
                    const pct = (count / maxCount) * 100;
                    bar.innerHTML = `
                        <div class="book-name">${book}</div>
                        <div class="book-progress">
                            <div class="book-fill" style="width: ${pct}%; background: linear-gradient(90deg, ${colors[i]}, ${colors[i]}88);">${pct > 30 ? count : ''}</div>
                        </div>
                        <div class="book-count">${count}</div>
                    `;
                    container.appendChild(bar);
                });
            } catch (e) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6;">Unable to load favorites</div>';
            }
        }

        // 4. VERSE HISTORY
        function loadVerseHistory() {
            const container = document.getElementById('verseHistory');
            const history = JSON.parse(localStorage.getItem('verseHistory') || '[]');
            const today = new Date().toDateString();
            
            // Filter to today's verses only
            const todayVerses = history.filter(v => new Date(v.timestamp).toDateString() === today);
            
            if (todayVerses.length === 0) {
                container.innerHTML = '<div style="text-align: center; opacity: 0.6; padding: 20px;">Verses you see today will appear here!</div>';
                return;
            }
            
            container.innerHTML = '';
            todayVerses.slice().reverse().forEach(v => {
                const item = document.createElement('div');
                item.className = 'verse-history-item';
                const time = new Date(v.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                item.innerHTML = `
                    <div>
                        <div class="verse-history-ref">${v.ref}</div>
                    </div>
                    <div class="verse-history-time">${time}</div>
                `;
                container.appendChild(item);
            });
        }

        // Save verse to history when fetched
        function addToVerseHistory(verse) {
            if (!verse || !verse.ref) return;
            const history = JSON.parse(localStorage.getItem('verseHistory') || '[]');
            history.push({
                ref: verse.ref,
                id: verse.id,
                timestamp: Date.now()
            });
            // Keep last 100
            if (history.length > 100) history.shift();
            localStorage.setItem('verseHistory', JSON.stringify(history));
        }

        // Track shares for achievement
        function trackShare() {
            const shared = (localStorage.getItem('sharedVerses') || '').split(',').filter(x => x);
            shared.push(Date.now());
            localStorage.setItem('sharedVerses', shared.join(','));
            trackDailyAction('share');
            awardXP(35, 'share');
            trackStat('shares');
            showToast(' Verse shared! +35 XP');
        }

        // === DISCOVER TAB FEATURES ===
        
        // Daily Challenge + XP System
        const DAILY_CHALLENGE_TOAST_KEY = 'dailyChallengeCompleteDate';
        const DAILY_CHALLENGE_COMPLETED_AT_PREFIX = 'dailyChallengeCompletedAt:';
        const XP_STORAGE_KEY = 'bibleXpState';
        const ACHIEVEMENT_XP = 750;

        function getXpState() {
            try {
                const saved = JSON.parse(localStorage.getItem(XP_STORAGE_KEY) || '{}');
                return {
                    xp: Number(saved.xp || 0),
                    claimedChallenges: saved.claimedChallenges || {},
                    claimedAchievements: saved.claimedAchievements || {}
                };
            } catch (_) {
                return { xp: 0, claimedChallenges: {}, claimedAchievements: {} };
            }
        }

        function saveXpState(state) {
            localStorage.setItem(XP_STORAGE_KEY, JSON.stringify(state));
        }

        function getLevelFromXp(xp) {
            const level = Math.floor(xp / 1000) + 1;
            return { level };
        }

        async function syncXpWithServer() {
            try {
                const res = await fetch('/api/shop/xp');
                const data = await res.json();
                if (data.xp !== undefined) {
                    // Update localStorage to match server
                    const state = getXpState();
                    state.xp = data.xp;
                    saveXpState(state);
                    return data;
                }
            } catch (e) {
                console.error('Error syncing XP:', e);
            }
            return null;
        }
        
        async function updateXpDisplay() {
            // First try to sync with server
            const serverData = await syncXpWithServer();
            
            const state = getXpState();
            const xpEl = document.getElementById('profileXp');
            const levelEl = document.getElementById('profileLevel');
            const level = serverData ? serverData.level : getLevelFromXp(state.xp).level;
            if (xpEl) xpEl.textContent = `${state.xp} XP`;
            if (levelEl) levelEl.textContent = `Level ${level}`;
        }

        async function awardXp(amount, type, key) {
            const state = getXpState();
            if (type === 'challenge') {
                if (state.claimedChallenges[key]) return false;
                state.claimedChallenges[key] = true;
            } else if (type === 'achievement') {
                if (state.claimedAchievements[key]) return false;
                state.claimedAchievements[key] = true;
            }
            state.xp += Math.max(0, Number(amount || 0));
            saveXpState(state);
            
            // Sync to server
            try {
                await fetch('/api/xp/award', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, action: type || 'achievement' })
                });
            } catch (e) {
                console.error('Error syncing XP to server:', e);
            }
            
            updateXpDisplay();
            return true;
        }

        function trackDailyAction(action, verseId) {
            // Keep signature for existing call sites; server tracks action progress.
            updateChallengeProgress();
        }

        async function initDailyChallenge() {
            const challengeEl = document.getElementById('dailyChallenge');
            if (!challengeEl) return;
            challengeEl.style.display = 'block';
            await updateChallengeProgress();
            if (challengeRefreshInterval) clearInterval(challengeRefreshInterval);
            challengeRefreshInterval = setInterval(updateChallengeProgress, 60000);
        }

        async function updateChallengeProgress() {
            try {
                const res = await fetch('/api/daily_challenge');
                const data = await res.json();
                if (!res.ok || data.error) return;

                const challengeEl = document.getElementById('dailyChallenge');
                if (data.hide_at) {
                    const hideAt = new Date(data.hide_at);
                    if (!Number.isNaN(hideAt.getTime()) && Date.now() >= hideAt.getTime()) {
                        if (challengeEl) challengeEl.style.display = 'none';
                        return;
                    }
                }
                if (challengeEl) challengeEl.style.display = 'block';

                const xpReward = Number(data.xp_reward || 0);
                const challengeText = data.text || 'Save 2 verses to your library';
                document.getElementById('challengeText').textContent = xpReward
                    ? `${challengeText}  ${xpReward} XP`
                    : challengeText;
                document.getElementById('challengeGoal').textContent = data.goal || 2;
                const progress = Math.max(0, Number(data.progress || 0));
                const goal = Math.max(1, Number(data.goal || 2));
                const pct = Math.min(100, (progress / goal) * 100);

                const fillEl = document.getElementById('challengeFill');
                const progressEl = document.getElementById('challengeProgress');
                if (fillEl) fillEl.style.width = pct + '%';
                if (progressEl) progressEl.textContent = String(Math.min(progress, goal));

                const progressBarEl = document.getElementById('challengeProgressBar');
                const progressTextEl = document.getElementById('challengeProgressText');
                const cooldownEl = document.getElementById('challengeCooldown');

                if (data.completed) {
                    document.getElementById('challengeText').textContent = 'Challenge complete!';
                    if (challengeEl) challengeEl.classList.add('complete');
                    const periodKey = String(data.challenge_id || data.date || new Date().toISOString().slice(0, 13));
                    const completedKey = `${DAILY_CHALLENGE_COMPLETED_AT_PREFIX}${periodKey}`;
                    let completedAt = Number(localStorage.getItem(completedKey) || 0);
                    if (!completedAt) {
                        completedAt = Date.now();
                        localStorage.setItem(completedKey, String(completedAt));
                    }
                    const twoHoursMs = 2 * 60 * 60 * 1000;
                    if (Date.now() - completedAt > twoHoursMs) {
                        if (challengeEl) challengeEl.style.display = 'none';
                        return;
                    }
                    if (localStorage.getItem(DAILY_CHALLENGE_TOAST_KEY) !== periodKey) {
                        localStorage.setItem(DAILY_CHALLENGE_TOAST_KEY, periodKey);
                        const awarded = awardXp(xpReward || 100, 'challenge', periodKey);
                        if (awarded) {
                            showToast(` Challenge Complete! +${xpReward || 100} XP`);
                            AudioSys.playSuccess();
                        }
                    }
                    if (progressBarEl) progressBarEl.style.display = 'none';
                    if (progressTextEl) progressTextEl.style.display = 'none';
                    if (cooldownEl) {
                        cooldownEl.style.display = 'block';
                        const expiresAt = data.expires_at ? new Date(data.expires_at) : null;
                        const updateCooldown = () => {
                            if (!expiresAt || Number.isNaN(expiresAt.getTime())) {
                                cooldownEl.textContent = 'Next challenge starting soon...';
                                return;
                            }
                            const now = new Date();
                            const remainingMs = Math.max(0, expiresAt.getTime() - now.getTime());
                            const totalMins = Math.ceil(remainingMs / 60000);
                            const hours = Math.floor(totalMins / 60);
                            const mins = totalMins % 60;
                            if (remainingMs > 0) {
                                cooldownEl.textContent = hours > 0
                                    ? `Next challenge in ${hours}h ${mins}m`
                                    : `Next challenge in ${mins}m`;
                                return;
                            }
                            cooldownEl.textContent = 'Next challenge starting soon...';
                            if (challengeCountdownInterval) {
                                clearInterval(challengeCountdownInterval);
                                challengeCountdownInterval = null;
                            }
                            updateChallengeProgress();
                        };
                        updateCooldown();
                        if (challengeCountdownInterval) clearInterval(challengeCountdownInterval);
                        challengeCountdownInterval = setInterval(updateCooldown, 1000);
                    }
                } else {
                    if (challengeEl) challengeEl.classList.remove('complete');
                    if (progressBarEl) progressBarEl.style.display = 'block';
                    if (progressTextEl) progressTextEl.style.display = 'block';
                    if (cooldownEl) cooldownEl.style.display = 'none';
                    if (challengeCountdownInterval) {
                        clearInterval(challengeCountdownInterval);
                        challengeCountdownInterval = null;
                    }
                }
            } catch (_) {
                // Keep UI stable if endpoint temporarily fails.
            }
        }

        async function loadBiblePicks(popularOnly = false) {
            const selectEl = document.getElementById('biblePickSelect');
            const metaEl = document.getElementById('biblePickMeta');
            if (!selectEl || !metaEl) return;

            metaEl.textContent = 'OpenAI is picking popular Bible selections...';

            try {
                const url = '/api/bible/picks';
                const res = await fetch(url);
                const data = await res.json();
                if (!res.ok || data.error) {
                    metaEl.textContent = 'Unable to load selections.';
                    return;
                }

                const picks = Array.isArray(data.picks) ? data.picks : [];
                renderBiblePicks(picks);
                const total = biblePickState.picks.length;
                metaEl.textContent = total
                    ? `${total} selections ready.`
                    : 'No selections found.';
            } catch (_) {
                metaEl.textContent = 'Network error while loading selections.';
            }
        }

        function renderBiblePicks(picks) {
            const selectEl = document.getElementById('biblePickSelect');
            if (!selectEl) return;

            const sourcePicks = Array.isArray(picks) ? picks : [];
            const books = Array.isArray(bibleReaderState.books) ? bibleReaderState.books : [];
            const combined = [];
            const used = new Set();

            if (books.length) {
                books.forEach(book => {
                    const bookName = String(book.name || book.id || '').trim();
                    if (!bookName) return;
                    let found = null;
                    for (let i = 0; i < sourcePicks.length; i++) {
                        if (used.has(i)) continue;
                        const ref = String(sourcePicks[i].reference || sourcePicks[i].ref || '').trim();
                        const parsed = parsePickReference(ref);
                        const pickBook = parsed ? parsed.book : ref.split(' ')[0];
                        if (bookMatchesName(pickBook, bookName)) {
                            found = sourcePicks[i];
                            used.add(i);
                            break;
                        }
                    }
                    if (found) {
                        combined.push(found);
                    } else {
                        combined.push({ reference: `${bookName} 1`, title: 'Chapter 1', reason: 'Start here' });
                    }
                });
            } else {
                combined.push(...sourcePicks);
            }

            biblePickState.picks = combined;
            selectEl.innerHTML = '<option value=\"\">Select a popular reading...</option>';

            biblePickState.picks.forEach((p, idx) => {
                const ref = (p.reference || p.ref || '').trim();
                if (!ref) return;
                const title = (p.title || '').trim();
                const label = title ? `${ref}  ${title}` : ref;
                const opt = document.createElement('option');
                opt.value = String(idx);
                opt.textContent = label;
                selectEl.appendChild(opt);
            });
        }

        function onBiblePickSelect() {
            const selectEl = document.getElementById('biblePickSelect');
            if (!selectEl) return;
            const idx = parseInt(selectEl.value, 10);
            if (!Number.isFinite(idx) || !biblePickState.picks[idx]) {
                return;
            }

            const pick = biblePickState.picks[idx];
            applyPickToReader(pick);
        }

        function parsePickReference(ref) {
            if (!ref) return null;
            const match = ref.match(/^(.+?)\\s+(\\d+)(?:\\s*[-]\\s*(\\d+))?$/);
            if (!match) return null;
            return {
                book: match[1].trim(),
                chapter: parseInt(match[2], 10) || 1
            };
        }

        function normalizeBookName(name) {
            return String(name || '').toLowerCase().replace(/\\s+/g, ' ').trim();
        }

        function bookMatchesName(a, b) {
            const left = normalizeBookName(a);
            const right = normalizeBookName(b);
            if (!left || !right) return false;
            if (left === right) return true;
            if (left.endsWith('s') && left.slice(0, -1) === right) return true;
            if (right.endsWith('s') && right.slice(0, -1) === left) return true;
            return left.includes(right) || right.includes(left);
        }

        function applyPickToReader(pick) {
            if (!pick) return;
            const ref = (pick.reference || pick.ref || '').trim();
            const parsed = parsePickReference(ref);
            if (!parsed) return;

            const selectEl = document.getElementById('readerBookSelect');
            const chapterEl = document.getElementById('readerChapterInput');
            const metaEl = document.getElementById('readerMeta');
            if (chapterEl) {
                chapterEl.value = String(parsed.chapter || 1);
            }
            if (selectEl) {
                const bookLower = parsed.book.toLowerCase();
                const match = bibleReaderState.books.find(b => {
                    const name = String(b.name || '').toLowerCase();
                    const id = String(b.id || '').toLowerCase();
                    return (
                        name === bookLower ||
                        id === bookLower ||
                        name.includes(bookLower) ||
                        bookLower.includes(name)
                    );
                });
                if (match) {
                    selectEl.value = match.name || match.id;
                } else {
                    let opt = Array.from(selectEl.options).find(o => o.value === parsed.book);
                    if (!opt) {
                        opt = document.createElement('option');
                        opt.value = parsed.book;
                        opt.textContent = parsed.book;
                        selectEl.prepend(opt);
                    }
                    selectEl.value = parsed.book;
                }
            }

            loadBibleChapter();
            if (metaEl) metaEl.textContent = `Selected: ${ref}`;
        }

        function buildReaderPages(verses) {
            const pages = [];
            if (!Array.isArray(verses) || !verses.length) return pages;
            const maxChars = 1400;
            const maxVerses = 12;
            let current = [];
            let charCount = 0;
            verses.forEach(v => {
                const text = String(v.text || '');
                const nextChars = charCount + text.length;
                if (current.length >= maxVerses || (nextChars > maxChars && current.length)) {
                    pages.push(current);
                    current = [];
                    charCount = 0;
                }
                current.push(v);
                charCount += text.length;
            });
            if (current.length) pages.push(current);
            return pages;
        }

        function renderReaderPage() {
            const contentEl = document.getElementById('readerContent');
            const fsContentEl = document.getElementById('readerFullscreenContent');
            const indicatorEl = document.getElementById('readerPageIndicator');
            const fsIndicatorEl = document.getElementById('readerFullscreenPageIndicator');
            const fsNextPageBtn = document.getElementById('readerFullscreenNextPageBtn');
            const fsNextChapterBtn = document.getElementById('readerFullscreenNextChapterBtn');
            const total = readerPages.length;
            const idx = Math.min(readerPageIndex, Math.max(0, total - 1));
            readerPageIndex = idx;
            const page = total ? readerPages[idx] : [];
            const html = page.length
                ? page.map(v => `<div class="reader-verse"><span>${v.verse}</span>${escapeHtml(v.text || '')}</div>`).join('')
                : `<div style="opacity: 0.7;">No verses found.</div>`;
            if (contentEl) contentEl.innerHTML = html;
            if (fsContentEl) fsContentEl.innerHTML = html;
            const label = total ? `Page ${idx + 1}/${total}` : 'Page 0/0';
            if (indicatorEl) indicatorEl.textContent = label;
            if (fsIndicatorEl) fsIndicatorEl.textContent = label;
            if (fsNextPageBtn && fsNextChapterBtn) {
                const isFullscreen = document.body.classList.contains('reader-fullscreen-open');
                if (!isFullscreen) {
                    fsNextChapterBtn.style.display = 'none';
                    fsNextPageBtn.style.display = '';
                } else if (total && idx >= total - 1) {
                    fsNextPageBtn.style.display = 'none';
                    fsNextChapterBtn.style.display = 'inline-flex';
                } else {
                    fsNextPageBtn.style.display = 'inline-flex';
                    fsNextChapterBtn.style.display = 'none';
                }
            }
        }

        function prevReaderPage() {
            if (readerPageIndex <= 0) return;
            readerPageIndex -= 1;
            renderReaderPage();
            AudioSys.playPage();
        }

        function nextReaderPage() {
            if (readerPageIndex >= readerPages.length - 1) return;
            readerPageIndex += 1;
            renderReaderPage();
            AudioSys.playPage();
        }

        function toggleReaderFullscreen() {
            const overlay = document.getElementById('readerFullscreen');
            if (!overlay) return;
            const active = overlay.classList.toggle('active');
            document.body.classList.toggle('reader-fullscreen-open', active);
            AudioSys.playModal();
            const chapter = document.getElementById('readerCurrentChapter');
            const fsChapter = document.getElementById('readerFullscreenChapter');
            if (fsChapter && chapter) fsChapter.textContent = chapter.textContent;
            renderReaderPage();
        }

        function closeReaderFullscreen(e) {
            if (!e || e.target.id !== 'readerFullscreen') return;
            toggleReaderFullscreen();
        }


        async function loadBibleBooks() {
            const selectEl = document.getElementById('readerBookSelect');
            const metaEl = document.getElementById('readerMeta');
            if (!selectEl) return;

            if (metaEl) metaEl.textContent = 'Loading Bible books...';
            try {
                const res = await fetch('/api/bible/books');
                const data = await res.json();
                if (!res.ok || data.error) {
                    if (metaEl) metaEl.textContent = 'Unable to load Bible books.';
                    return;
                }

                bibleReaderState.books = Array.isArray(data.books) ? data.books : [];
                bibleReaderState.translation = data.translation_id || data.translation || 'web';
                selectEl.innerHTML = '';
                bibleReaderState.books.forEach(book => {
                    const opt = document.createElement('option');
                    opt.value = book.name || book.id;
                    opt.textContent = book.name || book.id;
                    selectEl.appendChild(opt);
                });
                if (selectEl.options.length) {
                    selectEl.selectedIndex = 0;
                }
                if (metaEl) metaEl.textContent = `Loaded ${selectEl.options.length} books.`;
                if (biblePickState.picks.length) {
                    renderBiblePicks(biblePickState.picks);
                }
            } catch (_) {
                if (metaEl) metaEl.textContent = 'Network error while loading books.';
            }
        }

        async function loadBibleChapter() {
            const selectEl = document.getElementById('readerBookSelect');
            const chapterEl = document.getElementById('readerChapterInput');
            const metaEl = document.getElementById('readerMeta');
            const contentEl = document.getElementById('readerContent');
            const labelEl = document.getElementById('readerCurrentChapter');
            if (!selectEl || !chapterEl || !contentEl) return;

            const book = selectEl.value;
            let chapter = parseInt(chapterEl.value || '1', 10);
            if (!Number.isFinite(chapter) || chapter < 1) chapter = 1;
            chapterEl.value = String(chapter);

            if (metaEl) metaEl.textContent = `Loading ${book} ${chapter}...`;
            try {
                const translation = bibleReaderState.translation || 'web';
                const url = `/api/bible/chapter?book=${encodeURIComponent(book)}&chapter=${encodeURIComponent(chapter)}&translation=${encodeURIComponent(translation)}`;
                const res = await fetch(url);
                const data = await res.json();
                if (!res.ok || data.error) {
                    contentEl.innerHTML = `<div style="opacity: 0.7;">Unable to load chapter.</div>`;
                    if (metaEl) metaEl.textContent = data.error || 'Unable to load chapter.';
                    readerPages = [];
                    readerPageIndex = 0;
                    renderReaderPage();
                    return;
                }

                const reference = data.reference || `${book} ${chapter}`;
                if (labelEl) labelEl.textContent = `Chapter: ${reference}`;
                const fsLabel = document.getElementById('readerFullscreenChapter');
                if (fsLabel) fsLabel.textContent = `Chapter: ${reference}`;
                readerPages = buildReaderPages(Array.isArray(data.verses) ? data.verses : []);
                readerPageIndex = 0;
                renderReaderPage();
                if (metaEl) {
                    const translationLabel = data.translation || data.translation_id || translation;
                    metaEl.textContent = `${translationLabel}  ${data.verses ? data.verses.length : 0} verses`;
                }
                contentEl.scrollTop = 0;
            } catch (_) {
                contentEl.innerHTML = `<div style="opacity: 0.7;">Network error.</div>`;
                if (metaEl) metaEl.textContent = 'Network error while loading chapter.';
                readerPages = [];
                readerPageIndex = 0;
                renderReaderPage();
            }
        }

        function renderBibleChapter(data) {
            const verses = Array.isArray(data.verses) ? data.verses : [];
            readerPages = buildReaderPages(verses);
            readerPageIndex = 0;
            renderReaderPage();
        }

        function prevBibleChapter() {
            const chapterEl = document.getElementById('readerChapterInput');
            if (!chapterEl) return;
            let chapter = parseInt(chapterEl.value || '1', 10);
            if (!Number.isFinite(chapter) || chapter <= 1) return;
            chapter -= 1;
            chapterEl.value = String(chapter);
            loadBibleChapter();
        }

        function nextBibleChapter() {
            const chapterEl = document.getElementById('readerChapterInput');
            if (!chapterEl) return;
            let chapter = parseInt(chapterEl.value || '1', 10);
            if (!Number.isFinite(chapter)) chapter = 1;
            chapter += 1;
            chapterEl.value = String(chapter);
            loadBibleChapter();
        }

        // Quick Filters for Discover
        let currentFilter = 'all';
        function filterDiscover(type) {
            currentFilter = type;
            document.querySelectorAll('.quick-filters .filter-chip').forEach(chip => {
                chip.classList.remove('active');
                if (chip.textContent.toLowerCase().includes(type === 'all' ? 'all' : type)) {
                    chip.classList.add('active');
                }
            });
            showToast(`Filtered: ${type.charAt(0).toUpperCase() + type.slice(1)}`);
        }

        // Verse of the Day
        function loadVerseOfDay() {
            const verses = [
                { ref: 'John 3:16', text: 'For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life.' },
                { ref: 'Philippians 4:13', text: 'I can do all things through Christ which strengtheneth me.' },
                { ref: 'Jeremiah 29:11', text: 'For I know the thoughts that I think toward you, saith the LORD, thoughts of peace, and not of evil, to give you an expected end.' },
                { ref: 'Romans 8:28', text: 'And we know that all things work together for good to them that love God, to them who are the called according to his purpose.' },
                { ref: 'Psalm 23:1', text: 'The LORD is my shepherd; I shall not want.' },
                { ref: 'Isaiah 41:10', text: 'Fear thou not; for I am with thee: be not dismayed; for I am thy God: I will strengthen thee; yea, I will help thee; yea, I will uphold thee with the right hand of my righteousness.' },
                { ref: 'Matthew 11:28', text: 'Come unto me, all ye that labour and are heavy laden, and I will give you rest.' }
            ];
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const verse = verses[dayOfYear % verses.length];
            
            document.getElementById('verseOfDayContent').textContent = `"${verse.text}"`;
            document.getElementById('verseOfDayRef').textContent = ` ${verse.ref}`;
            document.getElementById('vodDate').textContent = new Date().toLocaleDateString();
        }

        // === RECOMMENDATIONS TAB FEATURES ===

        let currentRecFilter = 'all';
        function filterRecs(type) {
            currentRecFilter = type;
            document.querySelectorAll('.rec-category').forEach(cat => cat.classList.remove('active'));
            event.target.classList.add('active');
            showToast(`Recommendations: ${type.charAt(0).toUpperCase() + type.slice(1)}`);
        }

        async function getMoodVerse(mood) {
            try {
                const excludeIds = getRecentRecIds(20);
                const url = excludeIds.length
                    ? `/api/mood/${encodeURIComponent(mood)}?exclude=${excludeIds.join(',')}`
                    : `/api/mood/${encodeURIComponent(mood)}`;
                const res = await fetch(url, { cache: 'no-store' });
                const data = await res.json();
                if (!res.ok || data.error) {
                    throw new Error(data.error || 'Failed to load verse');
                }
                const verse = { ref: data.ref, text: data.text, id: data.id };
                
                addToRecHistory({ ...verse, reason: `For when you're feeling ${mood}` });
                
                const recList = document.getElementById('recList');
                recList.innerHTML = `
                    <div class="rec-card" style="animation: slideIn 0.3s ease;">
                        <div class="rec-reason"> ${mood.charAt(0).toUpperCase() + mood.slice(1)}</div>
                        <div style="font-style: italic; margin-bottom: 8px;">${verse.text}</div>
                        <div style="font-weight: 700; color: var(--primary);">${verse.ref}</div>
                    </div>
                `;
                
                showToast(`Verses for when you're feeling ${mood}`);
            } catch (e) {
                showToast('Unable to fetch a new verse. Try again.');
            }
        }

        function addToRecHistory(verse) {
            const history = JSON.parse(localStorage.getItem('recHistory') || '[]')
                .filter(item => item && item.id !== verse.id);
            history.unshift({ ...verse, timestamp: Date.now() });
            if (history.length > 20) history.pop();
            localStorage.setItem('recHistory', JSON.stringify(history));
            renderRecHistory();
        }

        function getRecentRecIds(limit = 15) {
            const history = JSON.parse(localStorage.getItem('recHistory') || '[]');
            const ids = [];
            history.forEach(item => {
                if (item && item.id && !ids.includes(item.id)) ids.push(item.id);
            });
            return ids.slice(0, limit);
        }

        function renderRecHistory() {
            const history = JSON.parse(localStorage.getItem('recHistory') || '[]');
            const container = document.getElementById('recHistoryList');
            
            if (history.length === 0) {
                container.innerHTML = '<div style="opacity: 0.6; text-align: center; padding: 20px;">Your recommendations will appear here</div>';
                return;
            }
            
            container.innerHTML = history.map(v => `
                <div class="rec-card" style="opacity: 0.8;">
                    <div class="rec-reason">${v.reason || 'Recommended'}</div>
                    <div style="font-size: 13px; font-style: italic; margin-bottom: 4px;">${v.text.substring(0, 80)}...</div>
                    <div style="font-size: 12px; font-weight: 600; color: var(--primary);">${v.ref}</div>
                </div>
            `).join('');
        }

        // === LIBRARY TAB FEATURES ===

        let currentLibraryTab = 'all';
        function switchLibraryTab(tab) {
            currentLibraryTab = tab;
            document.querySelectorAll('.library-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('collectionsView').style.display = tab === 'collections' ? 'block' : 'none';
            document.getElementById('favoritesDropZone').style.display = tab === 'favorites' ? 'block' : 'none';
            document.getElementById('versesListCard').style.display = 'block';
            document.getElementById('librarySearch').style.display = tab === 'collections' ? 'none' : 'block';
            
            if (tab === 'all') loadLibrary();
        }

        function showCollection(type) {
            showToast(`Showing ${type} collection`);
            switchLibraryTab('all');
        }

        function createNewCollection() {
            const name = prompt('Enter collection name:');
            if (name) {
                showToast(`Created collection: ${name}`);
            }
        }

        function searchLibrary() {
            const query = document.getElementById('librarySearch').value.toLowerCase();
            const cards = document.querySelectorAll('.verse-card');
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(query) ? 'block' : 'none';
            });
        }

        function sortLibrary() {
            const sort = document.getElementById('sortSelect').value;
            showToast(`Sorted by: ${sort}`);
            loadLibrary();
        }

        // === COMMENTS TAB FEATURES ===

        function addEmoji(emoji) {
            const input = document.getElementById('commentInput');
            input.value += emoji;
            input.focus();
        }

        function handleCommentKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                postComment();
            }
        }

        function handleCommunityKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                postCommunityMessage();
            }
        }

        function handleDeepLinkParams() {
            try {
                const params = new URLSearchParams(window.location.search);
                const dmUser = parseInt(params.get('dmUser') || '0', 10);
                if (dmUser) {
                    switchTab('comments');
                    switchCommentsView('dm');
                    openDmThread(dmUser);
                    params.delete('dmUser');
                    const next = params.toString();
                    const newUrl = window.location.pathname + (next ? `?${next}` : '') + window.location.hash;
                    window.history.replaceState({}, '', newUrl);
                }
            } catch (_) {}
        }

        function isCommentsInputActive() {
            if (replyActiveKey) return true;
            const active = document.activeElement;
            if (!active) return false;
            const id = active.id || '';
            if (id === 'commentInput' || id === 'communityInput') return true;
            if (id === 'dmInput' || id === 'dmSearchInput') return true;
            if (id.startsWith('reply-input-')) return true;
            return active.closest && active.closest('.reply-input-area');
        }

        let currentCommunityFilter = 'all';
        function filterCommunity(tag) {
            currentCommunityFilter = tag;
            showToast(`Filtered by: #${tag}`);
            loadCommunityMessages();
        }

        function renderCommentWithReactions(comment) {
            const reactions = comment.reactions || { '': 0, '': 0, '': 0, '': 0 };
            return `
                <div class="comment" data-comment-id="${comment.id}">
                    <div class="comment-header">
                        <strong>${escapeHtml(comment.google_name || 'Anonymous')}</strong>
                        <span>${formatLocalTimestamp(comment.timestamp, {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text)}</div>
                    <div class="reaction-bar">
                        ${Object.entries(reactions).map(([emoji, count]) => `
                            <button class="reaction-btn ${count > 0 ? 'active' : ''}" onclick="addReaction(${comment.id}, '${emoji}', undefined, this)">
                                ${emoji} ${count > 0 ? count : ''}
                            </button>
                        `).join('')}
                        <button class="reply-btn" onclick="showReplyBox(${comment.id})">Reply</button>
                    </div>
                    <div class="comment-replies" id="replies-${comment.id}"></div>
                    <div class="reply-input-area" id="reply-box-${comment.id}" style="display: none;">
                            <input type="text" class="comment-input" name="reply_text" autocomplete="off" data-form-type="other" placeholder="Write a reply..." id="reply-input-${comment.id}">
                        <button class="send-btn" onclick="postReply(${comment.id})"></button>
                    </div>
                </div>
            `;
        }

        function animateVerseReveal() {
            const el = document.querySelector('.verse-container');
            if (!el) return;
            el.classList.remove('verse-reveal');
            void el.offsetWidth;
            el.classList.add('verse-reveal');
        }

        function animateActionFeedback(iconId, burstEmoji = '') {
            const icon = document.getElementById(iconId);
            const btn = icon ? icon.closest('.action-btn') : null;
            if (icon) {
                icon.classList.remove('spark');
                void icon.offsetWidth;
                icon.classList.add('spark');
                setTimeout(() => icon.classList.remove('spark'), 520);
            }
            if (btn) {
                btn.classList.add('pop-success');
                setTimeout(() => btn.classList.remove('pop-success'), 420);
                if (burstEmoji) spawnReactionBurst(btn, burstEmoji, 7);
            }
        }

        function spawnReactionBurst(targetEl, emoji = '', count = 6) {
            if (!targetEl || document.body.classList.contains('no-animations')) return;
            const rect = targetEl.getBoundingClientRect();
            const cx = rect.left + rect.width / 2;
            const cy = rect.top + rect.height / 2;
            for (let i = 0; i < count; i++) {
                const chip = document.createElement('span');
                chip.className = 'reaction-burst';
                chip.textContent = emoji;
                chip.style.left = `${cx + (Math.random() * 22 - 11)}px`;
                chip.style.top = `${cy + (Math.random() * 8 - 4)}px`;
                chip.style.setProperty('--dx', `${(Math.random() * 30 - 15).toFixed(1)}px`);
                document.body.appendChild(chip);
                setTimeout(() => chip.remove(), 700);
            }
        }

        async function addReaction(commentId, type, emoji, btnEl = null) {
            try {
                if (emoji === undefined) {
                    emoji = type;
                    type = 'comment';
                }
                const normalizedReaction = ({ '': 'heart', '': 'pray', '': 'cross' }[emoji] || emoji || '').toLowerCase();
                const itemType = type === 'community' ? 'community' : 'comment';
                const res = await fetch('/api/comments/reaction', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ item_id: commentId, item_type: itemType, reaction: normalizedReaction })
                });
                const data = await res.json();
                if (!res.ok || data.error) {
                    showToast(data.error || 'Reaction failed');
                    return;
                }
                const burstMap = { heart: '', pray: '', cross: '' };
                const burstEmoji = burstMap[normalizedReaction] || '';
                spawnReactionBurst(btnEl || document.body, burstEmoji, 5);
                if (itemType === 'community') {
                    loadCommunityMessages();
                } else {
                    loadComments();
                }
            } catch (e) {
                showToast('Reaction failed');
            }
        }

        function showReplyBox(commentId, type = 'comment') {
            const box = document.getElementById(`reply-box-${type}-${commentId}`) || document.getElementById(`reply-box-${commentId}`);
            if (!box) return;
            const key = `${type}-${commentId}`;
            const isOpen = openReplyKey === key;
            openReplyKey = isOpen ? null : key;
            replyActiveKey = openReplyKey;
            if (type === 'comment') {
                commentVerseLocked = true;
            }
            document.querySelectorAll('.reply-input-area').forEach(el => {
                el.style.display = 'none';
            });
            if (!isOpen) {
                box.style.display = 'flex';
                const input = document.getElementById(`reply-input-${type}-${commentId}`) || document.getElementById(`reply-input-${commentId}`);
                if (input) {
                    if (replyDrafts[key]) input.value = replyDrafts[key];
                    input.focus();
                }
            }
        }

        async function postReply(commentId, type = 'comment') {
            const input = document.getElementById(`reply-input-${type}-${commentId}`) || document.getElementById(`reply-input-${commentId}`);
            if (!input) return;
            if (!input.value.trim()) return;
            if (commentRestriction.restricted) {
                showToast(commentRestriction.reason ? `Chat disabled: ${commentRestriction.reason}` : 'Chat disabled');
                return;
            }
            try {
                const parentType = type === 'community' ? 'community' : 'comment';
                const res = await fetch('/api/comments/replies', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        parent_type: parentType,
                        parent_id: commentId,
                        text: input.value.trim()
                    })
                });
                const data = await res.json();
                if (!res.ok || data.error) {
                    showToast(data.message || data.error || 'Reply failed');
                    return;
                }
                input.value = '';
                const draftKey = `${type}-${commentId}`;
                delete replyDrafts[draftKey];
                openReplyKey = null;
                replyActiveKey = null;
                if (parentType === 'community') loadCommunityMessages(true);
                else loadComments(true);
                loadProfileStats();
                awardXP(20, 'reply');
                trackStat('replies');
                showToast('Reply posted! +20 XP');
            } catch (e) {
                showToast('Reply failed');
            }
        }

        async function updateRestrictionUI() {
            try {
                const res = await fetch('/api/restriction_status');
                if (!res.ok) return;
                const data = await res.json();
                commentRestriction = {
                    restricted: !!data.restricted,
                    reason: data.reason || '',
                    expires_at: data.expires_at || null
                };
                applyRestrictionState();
            } catch (_) {}
        }

        function applyRestrictionState() {
            const banner = document.getElementById('commentRestrictionBanner');
            const commBanner = document.getElementById('communityRestrictionBanner');
            const commentInput = document.getElementById('commentInput');
            const commentSend = document.getElementById('commentSendBtn');
            const commentArea = document.getElementById('commentInputArea');
            const communityInput = document.getElementById('communityInput');
            const communitySend = document.getElementById('communitySendBtn');
            const communityArea = document.getElementById('communityInputArea');
            const dmInput = document.getElementById('dmInput');

            const restricted = !!commentRestriction.restricted;
            const reason = (commentRestriction.reason || 'policy').trim();
            const expires = commentRestriction.expires_at ? new Date(commentRestriction.expires_at) : null;
            const untilText = expires && !Number.isNaN(expires.getTime())
                ? ` until ${expires.toLocaleString()}`
                : '';
            const message = `Chat disabled: ${reason}${untilText}.`;

            if (banner) {
                banner.textContent = restricted ? message : '';
                banner.style.display = restricted ? 'block' : 'none';
            }
            if (commBanner) {
                commBanner.textContent = restricted ? message : '';
                commBanner.style.display = restricted ? 'block' : 'none';
            }
            if (commentInput) commentInput.disabled = restricted;
            if (commentSend) commentSend.disabled = restricted;
            if (commentArea) commentArea.classList.toggle('is-disabled', restricted);
            if (communityInput) communityInput.disabled = restricted;
            if (communitySend) communitySend.disabled = restricted;
            if (communityArea) communityArea.classList.toggle('is-disabled', restricted);
            if (dmInput) dmInput.disabled = restricted;

            document.querySelectorAll('.reply-btn').forEach(btn => { btn.disabled = restricted; });
            document.querySelectorAll('.reply-input-area .comment-input').forEach(inp => { inp.disabled = restricted; });
            document.querySelectorAll('.reply-input-area .send-btn').forEach(btn => { btn.disabled = restricted; });
        }

        function switchCommentsView(view) {
            currentCommentsView = view === 'community' ? 'community' : (view === 'dm' ? 'dm' : 'verse');
            openReplyKey = null;
            replyActiveKey = null;
            const verseSection = document.getElementById('verseCommentsSection');
            const communitySection = document.getElementById('communityCommentsSection');
            const dmSection = document.getElementById('dmCommentsSection');
            const verseBtn = document.getElementById('commentsViewVerseBtn');
            const communityBtn = document.getElementById('commentsViewCommunityBtn');
            const dmBtn = document.getElementById('commentsViewDmBtn');
            if (verseSection) verseSection.style.display = currentCommentsView === 'verse' ? 'block' : 'none';
            if (communitySection) communitySection.style.display = currentCommentsView === 'community' ? 'block' : 'none';
            if (dmSection) dmSection.style.display = currentCommentsView === 'dm' ? 'block' : 'none';
            if (verseBtn) verseBtn.classList.toggle('active', currentCommentsView === 'verse');
            if (communityBtn) communityBtn.classList.toggle('active', currentCommentsView === 'community');
            if (dmBtn) dmBtn.classList.toggle('active', currentCommentsView === 'dm');
            if (currentCommentsView === 'community') {
                loadCommunityMessages();
            } else if (currentCommentsView === 'dm') {
                loadDmThreads(true);
                loadDmMessages(true);
            } else {
                if (!activeCommentVerseId && currentVerse) {
                    setActiveCommentVerse(currentVerse);
                }
                loadComments();
            }
            applyRestrictionState();
        }

        function setAboutSlide(index) {
            const track = document.getElementById('aboutSliderTrack');
            if (!track || aboutIsSliding) return;
            const total = getAboutVideos().length || 1;
            aboutIsSliding = true;
            aboutSlideIndex = ((index % total) + total) % total;
            updateAboutDots();
            track.style.transform = `translateX(-${aboutSlideIndex * 100}%)`;
            updateAboutProgressBars();
            updateAboutNowPlaying();
            if (aboutSyncTimer) clearTimeout(aboutSyncTimer);
            aboutSyncTimer = setTimeout(() => {
                syncAboutVideoPlayback();
            }, 180);
            setTimeout(() => { aboutIsSliding = false; }, 360);
        }

        function aboutPrev() {
            setAboutSlide(aboutSlideIndex - 1);
        }

        function aboutNext() {
            setAboutSlide(aboutSlideIndex + 1);
        }

        function syncAboutVideoPlayback() {
            const videos = getAboutVideos();
            if (currentTab !== 'about') {
                videos.forEach(v => {
                    v.muted = true;
                    if (!v.paused) v.pause();
                });
                updateAboutPausedOverlay();
                return;
            }
            videos.forEach((v, i) => {
                if (i === aboutSlideIndex) {
                    v.muted = false;
                    v.volume = aboutVolume;
                    if (v.readyState < 2) v.load();
                    const p = v.play();
                    if (p && typeof p.catch === 'function') p.catch(() => {});
                } else {
                    v.muted = true;
                    if (!v.paused) v.pause();
                }
            });
            updateAboutPausedOverlay();
        }

        function pauseAboutPlayback() {
            getAboutVideos().forEach(v => {
                v.muted = true;
                if (!v.paused) v.pause();
            });
            updateAboutPausedOverlay();
            updateAboutProgressBars();
            updateAboutNowPlaying();
        }

        function toggleAboutPlayback() {
            if (aboutTouchMoved) {
                aboutTouchMoved = false;
                return;
            }
            const activeVideo = getAboutVideos()[aboutSlideIndex];
            if (!activeVideo) return;
            if (activeVideo.paused) {
                activeVideo.muted = false;
                activeVideo.volume = aboutVolume;
                const p = activeVideo.play();
                if (p && typeof p.catch === 'function') p.catch(() => {});
            } else {
                activeVideo.pause();
            }
            updateAboutPausedOverlay();
            updateAboutNowPlaying();
        }

        function updateAboutPausedOverlay() {
            const videos = getAboutVideos();
            videos.forEach((video, idx) => {
                const frame = document.getElementById(`aboutFrame${idx}`);
                if (frame) frame.classList.toggle('paused', !!video.paused);
            });
            updateAboutNowPlaying();
        }

        function initAboutVideoEvents() {
            const videos = getAboutVideos();
            aboutVideoErrorCount = 0;
            videos.forEach((v, idx) => {
                v.volume = aboutVolume;
                if (currentTab !== 'about') v.muted = true;
                v.addEventListener('play', updateAboutPausedOverlay);
                v.addEventListener('pause', updateAboutPausedOverlay);
                v.addEventListener('ended', updateAboutPausedOverlay);
                v.addEventListener('timeupdate', updateAboutProgressBars);
                v.addEventListener('loadedmetadata', updateAboutProgressBars);
                v.addEventListener('error', () => {
                    const frame = document.getElementById(`aboutFrame${idx}`);
                    if (!frame) return;
                    const label = frame.querySelector('.about-paused-indicator');
                    frame.classList.add('paused');
                    if (label) label.textContent = 'Video format not supported';
                    aboutVideoErrorCount += 1;
                    if (aboutVideoErrorCount >= videos.length) {
                        const activeFrame = document.getElementById(`aboutFrame${aboutSlideIndex}`) || frame;
                        const activeLabel = activeFrame ? activeFrame.querySelector('.about-paused-indicator') : null;
                        if (activeFrame) activeFrame.classList.add('paused');
                        if (activeLabel) activeLabel.textContent = 'Video files missing on server';
                    }
                });
            });
            updateAboutPausedOverlay();
            updateAboutProgressBars();
            updateAboutNowPlaying();
        }

        function getAboutVideos() {
            return Array.from(document.querySelectorAll('.about-video'));
        }

        function initAboutVolumeControl() {
            const slider = document.getElementById('aboutVolumeSlider');
            const saved = localStorage.getItem('aboutVideoVolume');
            const initial = saved !== null ? Number(saved) : 1;
            if (!Number.isNaN(initial)) {
                aboutVolume = Math.max(0, Math.min(1, initial));
            }
            if (slider) slider.value = String(aboutVolume);
            setAboutVolume(aboutVolume);
        }

        function setAboutVolume(value) {
            const n = Math.max(0, Math.min(1, Number(value)));
            if (Number.isNaN(n)) return;
            aboutVolume = n;
            getAboutVideos().forEach(v => { v.volume = aboutVolume; });
            localStorage.setItem('aboutVideoVolume', String(aboutVolume));
            updateAboutNowPlaying();
        }

        function updateAboutDots() {
            const dots = Array.from(document.querySelectorAll('#aboutDots .about-dot'));
            dots.forEach((dot, idx) => dot.classList.toggle('active', idx === aboutSlideIndex));
        }

        function updateAboutProgressBars() {
            const videos = getAboutVideos();
            videos.forEach((v, idx) => {
                const fill = document.getElementById(`aboutProgressFill${idx}`);
                if (!fill) return;
                if (idx < aboutSlideIndex) {
                    fill.style.width = '100%';
                    return;
                }
                if (idx > aboutSlideIndex) {
                    fill.style.width = '0%';
                    return;
                }
                const duration = Number(v.duration || 0);
                const current = Number(v.currentTime || 0);
                const pct = duration > 0 ? Math.max(0, Math.min(100, (current / duration) * 100)) : (v.paused ? 0 : 5);
                fill.style.width = `${pct}%`;
            });
        }

        function updateAboutNowPlaying() {
            const label = document.getElementById('aboutNowPlaying');
            const videos = getAboutVideos();
            const total = videos.length || 2;
            const active = videos[aboutSlideIndex];
            const state = active && !active.paused ? 'Playing' : 'Paused';
            const volPct = Math.round((aboutVolume || 0) * 100);
            if (label) {
                label.textContent = `Slide ${aboutSlideIndex + 1}/${total}  ${state}  Vol ${volPct}%`;
            }
        }

        function startAboutProgressTicker() {
            if (aboutProgressTimer) return;
            aboutProgressTimer = setInterval(updateAboutProgressBars, 120);
        }

        function stopAboutProgressTicker() {
            if (!aboutProgressTimer) return;
            clearInterval(aboutProgressTimer);
            aboutProgressTimer = null;
        }

        function updateTabThemeClass(tab) {
            const classes = ['tab-discover', 'tab-recommendations', 'tab-library', 'tab-comments', 'tab-profile', 'tab-about'];
            classes.forEach(c => document.body.classList.remove(c));
            document.body.classList.add(`tab-${tab}`);
        }

        function setupGlobalShortcuts() {
            document.addEventListener('keydown', (e) => {
                if (currentTab !== 'about') return;
                const activeEl = document.activeElement;
                const tag = activeEl && activeEl.tagName ? activeEl.tagName.toLowerCase() : '';
                if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    aboutPrev();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    aboutNext();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    toggleAboutPlayback();
                }
            });
        }

        function setupAboutSliderGestures() {
            const wrap = document.querySelector('.about-slider-wrap');
            if (!wrap) return;
            wrap.addEventListener('touchstart', (e) => {
                if (!e.touches || !e.touches.length) return;
                aboutTouchStartX = e.touches[0].clientX;
                aboutTouchMoved = false;
            }, { passive: true });
            wrap.addEventListener('touchmove', (e) => {
                if (aboutTouchStartX === null || !e.touches || !e.touches.length) return;
                const deltaX = e.touches[0].clientX - aboutTouchStartX;
                if (Math.abs(deltaX) > 8) aboutTouchMoved = true;
            }, { passive: true });
            wrap.addEventListener('touchend', (e) => {
                if (aboutTouchStartX === null || !e.changedTouches || !e.changedTouches.length) return;
                const deltaX = e.changedTouches[0].clientX - aboutTouchStartX;
                aboutTouchStartX = null;
                if (Math.abs(deltaX) < 40) return;
                if (deltaX < 0) aboutNext();
                else aboutPrev();
            }, { passive: true });
        }

        function updateOnlineUsers() {
            fetch('/api/presence/online')
                .then(res => res.json())
                .then(data => {
                    const count = Number(data.count || 0);
                    const el = document.getElementById('onlineCount');
                    if (el) el.textContent = String(Math.max(1, count));
                })
                .catch(() => {});
        }

        function startCommentsPolling() {
            if (commentsRefreshInterval) clearInterval(commentsRefreshInterval);
            commentsRefreshInterval = setInterval(() => {
                if (currentTab !== 'comments') return;
                if (!isCommentsInputActive()) {
                    if (currentCommentsView === 'community') loadCommunityMessages();
                    else if (currentCommentsView === 'dm') {
                        loadDmThreads();
                        loadDmMessages();
                    } else loadComments();
                }
                updateOnlineUsers();
            }, 3000);
        }

        function stopCommentsPolling() {
            if (commentsRefreshInterval) {
                clearInterval(commentsRefreshInterval);
                commentsRefreshInterval = null;
            }
        }

        // Simulate online users updating
        setInterval(updateOnlineUsers, 30000);

        // Settings
        function openSettings() {
            document.getElementById('settingsModal').classList.add('active');
            AudioSys.playModal();
        }

        function closeSettings(e) {
            if (!e || e.target.id === 'settingsModal') {
                document.getElementById('settingsModal').classList.remove('active');
                AudioSys.playModal();
            }
        }

        // ===== AUDIO SYSTEM =====
        const AudioSys = {
            ctx: null,
            master: null,
            noiseBuffer: null,
            lastPlay: 0,
            init() {
                if (!this.ctx) {
                    this.ctx = new (window.AudioContext || window.webkitAudioContext)();
                    this.master = this.ctx.createGain();
                    this.master.gain.value = 0.26;
                    this.master.connect(this.ctx.destination);
                    this.noiseBuffer = this._createNoiseBuffer();
                }
            },
            _createNoiseBuffer() {
                const buffer = this.ctx.createBuffer(1, this.ctx.sampleRate, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < data.length; i++) {
                    data[i] = (Math.random() * 2 - 1) * 0.7;
                }
                return buffer;
            },
            _allow() {
                if (!settings.sound) return false;
                this.init();
                if (this.ctx.state === 'suspended') this.ctx.resume();
                const now = performance.now();
                if (now - this.lastPlay < 50) return false;
                this.lastPlay = now;
                return true;
            },
            _playOsc({freq, type = 'sine', dur = 0.12, gain = 0.2, attack = 0.002, decay = 0.08, detune = 0, filter} = {}) {
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                osc.detune.value = detune;
                g.gain.setValueAtTime(0.0001, this.ctx.currentTime);
                g.gain.linearRampToValueAtTime(gain, this.ctx.currentTime + attack);
                g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + dur + decay);
                let node = osc;
                if (filter) {
                    const f = this.ctx.createBiquadFilter();
                    f.type = filter.type || 'lowpass';
                    f.frequency.value = filter.freq || 1200;
                    f.Q.value = filter.q || 0.7;
                    node.connect(f);
                    node = f;
                }
                node.connect(g);
                g.connect(this.master);
                osc.start();
                osc.stop(this.ctx.currentTime + dur + decay);
            },
            _playNoise({dur = 0.08, gain = 0.08, freq = 1200, q = 0.8, type = 'bandpass'} = {}) {
                const source = this.ctx.createBufferSource();
                source.buffer = this.noiseBuffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = type;
                filter.frequency.value = freq;
                filter.Q.value = q;
                const g = this.ctx.createGain();
                g.gain.setValueAtTime(0.0001, this.ctx.currentTime);
                g.gain.linearRampToValueAtTime(gain, this.ctx.currentTime + 0.01);
                g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + dur);
                source.connect(filter);
                filter.connect(g);
                g.connect(this.master);
                source.start();
                source.stop(this.ctx.currentTime + dur);
            },
            playTap() {
                if (!this._allow()) return;
                this._playOsc({freq: 420, type: 'triangle', dur: 0.05, gain: 0.18, filter: {type: 'lowpass', freq: 1800}});
                this._playNoise({dur: 0.035, gain: 0.06, freq: 1600});
            },
            playClick() {
                this.playTap();
            },
            playSwitch() {
                if (!this._allow()) return;
                this._playOsc({freq: 520, type: 'sine', dur: 0.06, gain: 0.16});
                setTimeout(() => this._playOsc({freq: 760, type: 'sine', dur: 0.07, gain: 0.14}), 40);
            },
            playPage() {
                if (!this._allow()) return;
                this._playNoise({dur: 0.08, gain: 0.06, freq: 900, q: 0.6});
                this._playOsc({freq: 300, type: 'triangle', dur: 0.08, gain: 0.06});
            },
            playSuccess() {
                if (!this._allow()) return;
                this._playOsc({freq: 520, type: 'sine', dur: 0.08, gain: 0.12});
                setTimeout(() => this._playOsc({freq: 660, type: 'sine', dur: 0.12, gain: 0.12}), 60);
                setTimeout(() => this._playOsc({freq: 820, type: 'sine', dur: 0.14, gain: 0.1}), 120);
            },
            playError() {
                if (!this._allow()) return;
                this._playOsc({freq: 140, type: 'sawtooth', dur: 0.18, gain: 0.12, filter: {type: 'lowpass', freq: 600}});
                this._playNoise({dur: 0.12, gain: 0.05, freq: 400});
            },
            playNotification() {
                if (!this._allow()) return;
                this._playOsc({freq: 880, type: 'sine', dur: 0.1, gain: 0.12});
                setTimeout(() => this._playOsc({freq: 1320, type: 'sine', dur: 0.14, gain: 0.1}), 80);
            },
            playModal() {
                if (!this._allow()) return;
                this._playOsc({freq: 360, type: 'triangle', dur: 0.1, gain: 0.09});
            }
        };

        document.addEventListener('pointerdown', (e) => {
            if (!settings.sound) return;
            const target = e.target.closest('button, .btn, .action-btn, .tab-btn, .nav-item, .icon-btn, .send-btn, .bible-reader-btn, .toggle, .segment-btn');
            if (target) AudioSys.playTap();
        });

        function applyTheme() {
            document.documentElement.setAttribute('data-theme', settings.darkMode ? 'dark' : 'light');
            const toggle = document.getElementById('darkToggle');
            if (toggle) toggle.classList.toggle('active', settings.darkMode);
            document.body.classList.toggle('noir-mode', settings.darkMode);
        }

        function toggleTheme() {
            themeAuto = false;
            settings.darkMode = !settings.darkMode;
            applyTheme();
            AudioSys.playClick();
            saveSettings();
        }

        function setFontSize(size, btn = null) {
            settings.fontSize = size;
            // Remove old font size classes from both html and body
            document.documentElement.classList.remove('font-small', 'font-medium', 'font-large');
            document.body.classList.remove('font-small', 'font-medium', 'font-large');
            // Add new font size class to both
            document.documentElement.classList.add('font-' + size);
            document.body.classList.add('font-' + size);
            applyGlobalFontScale();
            
            // Update button states
            document.querySelectorAll('#fontSizeSegment .segment-btn').forEach(b => b.classList.remove('active'));
            if (btn) {
                btn.classList.add('active');
            } else {
                const fontSizeMap = {small: 0, medium: 1, large: 2};
                const fontBtns = document.querySelectorAll('#fontSizeSegment .segment-btn');
                if (fontBtns[fontSizeMap[size]]) fontBtns[fontSizeMap[size]].classList.add('active');
            }
            
            AudioSys.playClick();
            saveSettings();
            showToast(`Font size: ${size}`);
        }

        function toggleAnimations() {
            settings.animations = !settings.animations;
            document.body.classList.toggle('no-animations', !settings.animations);
            document.getElementById('animToggle').classList.toggle('active');
            
            // Pause/resume ambient orbs
            document.querySelectorAll('.ambient-orb').forEach(orb => {
                orb.style.animationPlayState = settings.animations ? 'running' : 'paused';
            });
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.animations ? 'Animations ON' : 'Animations OFF');
        }

        function toggleSound() {
            settings.sound = !settings.sound;
            document.getElementById('soundToggle').classList.toggle('active');
            if (settings.sound) AudioSys.playSuccess();
            saveSettings();
            showToast(settings.sound ? 'Sound ON ' : 'Sound OFF ');
        }

        function toggleCompact() {
            settings.compact = !settings.compact;
            document.body.classList.toggle('compact-mode', settings.compact);
            document.getElementById('compactToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.compact ? 'Compact mode ON' : 'Compact mode OFF');
        }

        function toggleNotifications() {
            settings.notifications = !settings.notifications;
            document.getElementById('notificationToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.notifications ? 'Notifications ON ' : 'Notifications OFF ');
        }
        
        function toggleParticles() {
            settings.particles = !settings.particles;
            document.body.classList.toggle('particles-on', settings.particles);
            document.getElementById('particlesToggle').classList.toggle('active');
            
            if (settings.particles) {
                createParticles();
            } else {
                document.querySelectorAll('.particle').forEach(p => p.remove());
            }
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.particles ? 'Crosses ON ' : 'Crosses OFF');
        }
        
        function toggleHighContrast() {
            settings.highContrast = !settings.highContrast;
            document.body.classList.toggle('high-contrast', settings.highContrast);
            document.getElementById('contrastToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.highContrast ? 'High contrast ON' : 'High contrast OFF');
        }

        function toggleFocusMode() {
            settings.focusMode = !settings.focusMode;
            document.body.classList.toggle('focus-mode', settings.focusMode);
            document.getElementById('focusModeToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.focusMode ? 'Focus mode ON' : 'Focus mode OFF');
        }

        function toggleAutoCopy() {
            settings.autoCopyVerse = !settings.autoCopyVerse;
            document.getElementById('autoCopyToggle').classList.toggle('active');
            AudioSys.playClick();
            saveSettings();
            showToast(settings.autoCopyVerse ? 'Auto-copy ON' : 'Auto-copy OFF');
        }

        async function requestWakeLock() {
            if (!('wakeLock' in navigator)) return false;
            try {
                wakeLockHandle = await navigator.wakeLock.request('screen');
                wakeLockHandle.addEventListener('release', () => {
                    wakeLockHandle = null;
                    if (settings.keepAwake) {
                        setTimeout(() => requestWakeLock(), 300);
                    }
                });
                return true;
            } catch (e) {
                console.error('Wake lock failed:', e);
                return false;
            }
        }

        async function toggleWakeLock() {
            settings.keepAwake = !settings.keepAwake;
            document.getElementById('wakeLockToggle').classList.toggle('active');
            saveSettings();

            if (settings.keepAwake) {
                const ok = await requestWakeLock();
                showToast(ok ? 'Screen awake ON' : 'Wake lock unavailable');
            } else {
                if (wakeLockHandle) {
                    try { await wakeLockHandle.release(); } catch (_) {}
                    wakeLockHandle = null;
                }
                showToast('Screen awake OFF');
            }
        }

        async function changeUsername() {
            const input = document.getElementById('usernameInput');
            const newName = (input?.value || '').trim();
            if (!newName) {
                showToast('Enter a username');
                return;
            }

            try {
                const res = await fetch('/api/user/update-name', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    showToast(data.error || 'Name update failed');
                    return;
                }

                const profileName = document.getElementById('profileUserName');
                if (profileName) profileName.textContent = data.name;
                showToast('Username updated');
            } catch (e) {
                showToast('Error updating username');
            }
        }
        
        // Text to Speech Functions
        function toggleTTS() {
            settings.ttsEnabled = !settings.ttsEnabled;
            document.getElementById('ttsToggle').classList.toggle('active');
            
            if (!settings.ttsEnabled) {
                TTS.stop();
            }
            
            AudioSys.playClick();
            saveSettings();
            showToast(settings.ttsEnabled ? ' Auto-speak ON' : ' Auto-speak OFF');
        }
        
        function changeTTSSpeed(speed) {
            settings.ttsSpeed = parseFloat(speed);
            saveSettings();
            showToast(`Speech speed: ${speed}x`);
        }
        
        function testTTS() {
            const testText = "For God so loved the world, that he gave his only begotten Son.";
            TTS.speak(testText, settings.ttsSpeed);
            showToast(' Playing test...');
        }
        
        function speakVerse(verseText, verseRef) {
            if (settings.ttsEnabled && verseText) {
                const textToSpeak = `${verseText}. ${verseRef}.`;
                TTS.speak(textToSpeak, settings.ttsSpeed);
            }
        }

        async function changeInterval(val) {
            if (!isAdmin) {
                showToast('Admin access required');
                return;
            }
            
            settings.interval = parseInt(val);
            saveSettings();
            
            const res = await fetch('/api/set_interval', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({interval: settings.interval})
            });
            
            if (res.ok) {
                if (settings.notifications) showToast(`Interval set to ${val}s`);
            } else {
                showToast('Failed to update interval');
            }
        }

        function saveSettings() {
            localStorage.setItem('bibleSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            // Default settings with new options
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaults = {
                darkMode: false,
                fontSize: 'medium',
                animations: true,
                sound: true,
                autoRec: true,
                compact: false,
                notifications: true,
                interval: 60,
                particles: false,
                highContrast: false,
                focusMode: false,
                autoCopyVerse: false,
                keepAwake: false,
                reducedMotion: false,
                ttsEnabled: false,
                ttsSpeed: 1
            };
            
            const saved = localStorage.getItem('bibleSettings');
            if (saved) {
                settings = {...defaults, ...JSON.parse(saved)};
                themeAuto = false;
            } else {
                settings = {...defaults, darkMode: !!prefersDark};
                themeAuto = true;
            }
            
            // Apply theme (sync to system when auto)
            applyTheme();
            const schemeMedia = window.matchMedia ? window.matchMedia('(prefers-color-scheme: dark)') : null;
            if (schemeMedia && themeAuto) {
                schemeMedia.addEventListener('change', (e) => {
                    if (!themeAuto) return;
                    settings.darkMode = e.matches;
                    applyTheme();
                });
            }
            
            // Apply font size class to both html and body
            document.documentElement.classList.add('font-' + settings.fontSize);
            document.body.classList.add('font-' + settings.fontSize);
            applyGlobalFontScale();
            
            // Update font size button states
            const fontSizeMap = {small: 0, medium: 1, large: 2};
            const fontBtns = document.querySelectorAll('#fontSizeSegment .segment-btn');
            if (fontBtns[fontSizeMap[settings.fontSize]]) {
                fontBtns.forEach(b => b.classList.remove('active'));
                fontBtns[fontSizeMap[settings.fontSize]].classList.add('active');
            }
            
            // Apply animations
            if (!settings.animations) {
                document.body.classList.add('no-animations');
                document.getElementById('animToggle').classList.remove('active');
                document.querySelectorAll('.ambient-orb').forEach(orb => {
                    orb.style.animationPlayState = 'paused';
                });
            }
            
            // Apply sound
            if (!settings.sound) document.getElementById('soundToggle').classList.remove('active');
            
            // Apply auto recommendations
            if (!settings.autoRec) document.getElementById('autoRecToggle').classList.remove('active');
            
            // Apply compact mode
            if (settings.compact) {
                document.body.classList.add('compact-mode');
                document.getElementById('compactToggle').classList.add('active');
            }
            
            // Apply notifications
            if (!settings.notifications) document.getElementById('notificationToggle').classList.remove('active');
            
            // Apply particles
            if (settings.particles) {
                document.body.classList.add('particles-on');
                document.getElementById('particlesToggle').classList.add('active');
                createParticles();
            }
            
            // Apply high contrast
            if (settings.highContrast) {
                document.body.classList.add('high-contrast');
                document.getElementById('contrastToggle').classList.add('active');
            }

            if (settings.focusMode) {
                document.body.classList.add('focus-mode');
                document.getElementById('focusModeToggle').classList.add('active');
            }

            if (settings.autoCopyVerse) {
                document.getElementById('autoCopyToggle').classList.add('active');
            }

            if (settings.keepAwake) {
                document.getElementById('wakeLockToggle').classList.add('active');
                requestWakeLock();
            }
            
            // Apply TTS settings
            if (settings.ttsEnabled) {
                document.getElementById('ttsToggle').classList.add('active');
            }
            if (settings.ttsSpeed) {
                document.getElementById('ttsSpeedSelect').value = settings.ttsSpeed;
            }
            
            // Apply interval
            if (settings.interval) document.getElementById('intervalSelect').value = settings.interval;
            
            setupAutoRecommendations();

            fetch('/api/user_info')
                .then(r => r.json())
                .then(data => {
                    if (data && data.name) {
                        const input = document.getElementById('usernameInput');
                        if (input) input.value = data.name;
                        const profileName = document.getElementById('profileUserName');
                        if (profileName) profileName.textContent = data.name;
                    }
                })
                .catch(() => {});
        }
        
        // Create floating particles
        function createParticles() {
            const container = document.querySelector('.particles');
            if (!container) return;
            
            container.innerHTML = '';
            for (let i = 0; i < 18; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                p.style.left = Math.random() * 100 + '%';
                p.style.animationDuration = (10 + Math.random() * 18) + 's';
                p.style.animationDelay = Math.random() * 16 + 's';
                p.style.opacity = 0.18 + Math.random() * 0.25;
                container.appendChild(p);
            }

            for (let i = 0; i < 18; i++) {
                const s = document.createElement('div');
                s.className = 'particle cross-image';
                s.style.left = Math.random() * 100 + '%';
                s.style.animationDuration = (18 + Math.random() * 22) + 's';
                s.style.animationDelay = Math.random() * 18 + 's';
                s.style.opacity = 0.65 + Math.random() * 0.3;
                const size = 70 + Math.random() * 60;
                s.style.width = `${size}px`;
                s.style.height = `${size}px`;
                s.style.transform = `translateY(100vh) rotate(${Math.random() * 40 - 20}deg)`;
                container.appendChild(s);
            }
        }

        // Toast with sound
        function showAccountLock(title, message, reason) {
            if (document.querySelector('.account-lock')) return;
            const overlay = document.createElement('div');
            overlay.className = 'account-lock';
            overlay.innerHTML = `
                <div class="account-lock-card">
                    <h2>${escapeHtml(title || 'Access blocked')}</h2>
                    <p>${escapeHtml(message || 'Your access has been blocked.')}</p>
                    ${reason ? `<div style="margin-top:12px; padding:10px; border-radius:12px; background: rgba(255,255,255,0.08);">${escapeHtml(reason)}</div>` : ''}
                    <div style="margin-top:16px;">
                        <button class="bible-reader-btn" onclick="window.location.href='/logout'">Logout</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function showToast(msg, type = 'info', duration = 2800) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast';
            toast.classList.add('show');
            
            // Play appropriate sound
            if (settings.sound) {
                if (type === 'success' || msg.includes('success') || msg.includes('') || msg.includes('ON')) {
                    AudioSys.playSuccess();
                } else if (type === 'error' || msg.includes('error') || msg.includes('') || msg.includes('OFF')) {
                    AudioSys.playError();
                } else {
                    AudioSys.playNotification();
                }
            }
            
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        function logout() {
            // Clear timer on logout
            localStorage.removeItem('bibleAppStartTime');
            localStorage.removeItem('bibleAppIsAdmin');
            window.location.href = '/logout';
        }

        function showUser() {
            switchTab('profile');
        }

        // Responsive handler
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                document.querySelectorAll('.tab-view.active').forEach(el => el.classList.add('desktop-active'));
            } else {
                document.querySelectorAll('.tab-view').forEach(el => el.classList.remove('desktop-active'));
            }
        });

        // ===== SHOP SYSTEM =====
        let shopItems = [];
        let userInventory = [];
        let userXP = { xp: 0, level: 1 };
        let currentShopTab = 'shop';
        let currentCategory = 'all';
        
        // Format large numbers (1000 -> 1k, 1000000 -> 1m)
        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'm';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            }
            return num.toString();
        }
        
        async function loadShopData() {
            try {
                const itemsRes = await fetch('/api/shop/items');
                const itemsData = await itemsRes.json();
                if (itemsData.items) shopItems = itemsData.items;
                
                const xpRes = await fetch('/api/shop/xp');
                const xpData = await xpRes.json();
                if (xpData.xp !== undefined) {
                    userXP = xpData;
                    updateShopXPDisplay();
                }
                
                await loadInventory();
                renderShopItems();
            } catch (e) {
                console.error('Error loading shop:', e);
            }
        }
        
        async function loadInventory() {
            try {
                const res = await fetch('/api/shop/inventory');
                const data = await res.json();
                if (data.inventory) userInventory = data.inventory;
            } catch (e) {
                console.error('Error loading inventory:', e);
            }
        }
        
        function updateShopXPDisplay() {
            const xpEl = document.getElementById('shopXpAmount');
            const levelEl = document.getElementById('shopLevel');
            if (xpEl) xpEl.textContent = formatNumber(userXP.xp) + ' XP';
            if (levelEl) levelEl.textContent = 'Level ' + userXP.level;
        }
        
        let currentInventoryCategory = 'all';
        
        function filterInventory(category) {
            currentInventoryCategory = category;
            document.querySelectorAll('#inventory .shop-category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderInventory();
        }
        
        function updateInventoryXPDisplay() {
            const xpEl = document.getElementById('inventoryXpAmount');
            const levelEl = document.getElementById('inventoryLevel');
            if (xpEl) xpEl.textContent = formatNumber(userXP.xp) + ' XP';
            if (levelEl) levelEl.textContent = 'Level ' + userXP.level;
        }
        
        function filterShop(category) {
            currentCategory = category;
            document.querySelectorAll('.shop-category-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderShopItems();
        }
        
        function renderShopItems() {
            const container = document.getElementById('shopItems');
            let items = shopItems;
            
            if (currentCategory !== 'all') {
                items = items.filter(item => item.category === currentCategory);
            }
            
            if (items.length === 0) {
                container.innerHTML = '<div class="shop-empty"><div class="shop-empty-icon"></div><p>No items found</p></div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                const owned = userInventory.find(i => i.item_id === item.item_id);
                const rarityClass = item.rarity || 'common';
                
                return '<div class="shop-item ' + rarityClass + ' ' + (owned ? 'owned' : '') + '" data-item-id="' + item.item_id + '">' +
                    '<span class="shop-item-icon">' + (item.icon || '') + '</span>' +
                    '<div class="shop-item-name">' + item.name + '</div>' +
                    '<div class="shop-item-desc">' + item.description + '</div>' +
                    '<span class="shop-item-rarity ' + rarityClass + '">' + item.rarity + '</span>' +
                    '<div class="shop-item-price ' + (owned ? 'owned' : '') + '">' + (owned ? ' Owned' : ' ' + formatNumber(item.price) + ' XP') + '</div>' +
                    '<button class="shop-item-btn" ' + (owned ? 'disabled' : '') + ' onclick="purchaseItem(' + "'" + item.item_id + "'" + ', ' + item.price + ')">' + (owned ? 'Owned' : 'Buy') + '</button>' +
                    '</div>';
            }).join('');
        }
        
        function renderInventory() {
            const container = document.getElementById('inventoryItems');
            
            let items = userInventory;
            if (currentInventoryCategory !== 'all') {
                items = items.filter(item => item.category === currentInventoryCategory);
            }
            
            if (items.length === 0) {
                container.innerHTML = '<div class="shop-empty"><div class="shop-empty-icon"></div><p>No items in this category</p></div>';
                return;
            }
            
            container.innerHTML = items.map(item => {
                const rarityClass = item.rarity || 'common';
                const isEquipped = item.equipped;
                
                return '<div class="shop-item ' + rarityClass + ' ' + (isEquipped ? 'equipped' : '') + '" data-item-id="' + item.item_id + '">' +
                    '<span class="shop-item-icon">' + (item.icon || '') + '</span>' +
                    '<div class="shop-item-name">' + item.name + '</div>' +
                    '<div class="shop-item-desc">' + item.description + '</div>' +
                    '<span class="shop-item-rarity ' + rarityClass + '">' + item.rarity + '</span>' +
                    '<div class="shop-item-price owned">' + (isEquipped ? ' Equipped' : 'Owned') + '</div>' +
                    '<button class="shop-item-btn ' + (isEquipped ? 'unequip' : 'equip') + '" onclick="toggleEquipItem(' + "'" + item.item_id + "'" + ', ' + (!isEquipped) + ')">' + (isEquipped ? 'Unequip' : 'Equip') + '</button>' +
                    '</div>';
            }).join('');
        }
        
        // XP Guide - Functional XP Actions
        const XP_ACTIONS = {
            like: { min: 25, max: 50, cooldown: 1000, dailyMax: 100 },
            save: { min: 25, max: 50, cooldown: 1000, dailyMax: 100 },
            comment: { min: 100, max: 100, cooldown: 5000, dailyMax: 50 },
            reply: { min: 15, max: 25, cooldown: 3000, dailyMax: 100 },
            share: { min: 25, max: 50, cooldown: 60000, dailyMax: 20 },
            view: { min: 5, max: 10, cooldown: 500, dailyMax: 200 },
            streak: { min: 10, max: 60, cooldown: 86400000, dailyMax: 1 },
            trivia_correct: { min: 20, max: 50, cooldown: 0, dailyMax: 50 },
            prayer: { min: 75, max: 75, cooldown: 60000, dailyMax: 10 },
            memorize: { min: 100, max: 100, cooldown: 0, dailyMax: 10 },
            study_note: { min: 50, max: 200, cooldown: 0, dailyMax: 20 },
            achievement: { min: 25, max: 2000, cooldown: 0, dailyMax: 1000 }
        };
        
        let xpActionCooldowns = {};
        let xpDailyCounts = JSON.parse(localStorage.getItem('xpDailyCounts') || '{}');
        
        // Reset daily counts at midnight
        const lastReset = localStorage.getItem('xpDailyReset');
        const today = new Date().toDateString();
        if (lastReset !== today) {
            xpDailyCounts = {};
            localStorage.setItem('xpDailyCounts', JSON.stringify(xpDailyCounts));
            localStorage.setItem('xpDailyReset', today);
        }
        
        async function earnXP(actionType, multiplier = 1, customAmount = null) {
            const action = XP_ACTIONS[actionType];
            if (!action) {
                console.error('Unknown XP action:', actionType);
                return null;
            }
            
            // Check cooldown
            const now = Date.now();
            if (xpActionCooldowns[actionType] && now < xpActionCooldowns[actionType]) {
                const remaining = Math.ceil((xpActionCooldowns[actionType] - now) / 1000);
                console.log(`XP action ${actionType} on cooldown: ${remaining}s remaining`);
                return null;
            }
            
            // Check daily limit
            const today = new Date().toDateString();
            const dailyKey = `${actionType}_${today}`;
            const currentCount = xpDailyCounts[dailyKey] || 0;
            if (currentCount >= action.dailyMax) {
                console.log(`XP action ${actionType} daily limit reached`);
                return null;
            }
            
            // Calculate XP amount
            let amount;
            if (customAmount !== null) {
                amount = customAmount;
            } else {
                amount = Math.floor(Math.random() * (action.max - action.min + 1)) + action.min;
            }
            amount = Math.floor(amount * multiplier);
            
            // Apply cooldown and track daily count
            xpActionCooldowns[actionType] = now + action.cooldown;
            xpDailyCounts[dailyKey] = currentCount + 1;
            localStorage.setItem('xpDailyCounts', JSON.stringify(xpDailyCounts));
            
            // Award XP
            const result = await awardXP(amount, actionType);
            if (result) {
                trackStat(actionType);
                return result;
            }
            return null;
        }
        
        function renderXPGuide() {
            const container = document.getElementById('xpGuideContent');
            if (!container) return;
            
            const today = new Date().toDateString();
            
            const guideData = {
                daily: {
                    title: ' Daily Actions',
                    items: [
                        { icon: '', action: 'Like a verse', type: 'like', xp: '25-50', bonus: 'Streak bonus +50' },
                        { icon: '', action: 'Save a verse', type: 'save', xp: '25-50', bonus: '' },
                        { icon: '', action: 'Post a comment', type: 'comment', xp: '100', bonus: '' },
                        { icon: '', action: 'Read verse (streak)', type: 'view', xp: '5-10', bonus: 'Per verse viewed' },
                        { icon: '', action: 'Complete daily challenge', type: 'daily_challenge', xp: '50-500', bonus: 'Auto-awarded' }
                    ]
                },
                social: {
                    title: ' Social Interactions',
                    items: [
                        { icon: '', action: 'Get a like on comment', type: 'liked_comment', xp: '10', bonus: 'Auto-awarded' },
                        { icon: '', action: 'Share a verse', type: 'share', xp: '25-50', bonus: '' },
                        { icon: '', action: 'Reply to someone', type: 'reply', xp: '15-25', bonus: '' },
                        { icon: '', action: 'Add prayer to journal', type: 'prayer', xp: '75', bonus: 'Limited daily' }
                    ]
                },
                study: {
                    title: ' Bible Study',
                    items: [
                        { icon: '', action: 'Memorize a verse', type: 'memorize', xp: '100', bonus: '' },
                        { icon: '', action: 'Write study note', type: 'study_note', xp: '50-200', bonus: 'Based on length' },
                        { icon: '', action: 'Correct trivia answer', type: 'trivia_correct', xp: '20-50', bonus: 'Streak bonus' },
                        { icon: '', action: 'Maintain reading streak', type: 'streak', xp: '10-60', bonus: '+2 per streak day' }
                    ]
                },
                special: {
                    title: ' Achievements & Milestones',
                    items: [
                        { icon: '', action: 'Complete achievement', type: 'achievement', xp: '25-2000', bonus: 'Based on difficulty' },
                        { icon: '', action: 'Level up bonus', type: 'level_up', xp: 'Bonus', bonus: 'Higher level = more' },
                        { icon: '', action: 'First purchase', type: 'first_purchase', xp: '100', bonus: 'One-time' },
                        { icon: '', action: 'Special events', type: 'event', xp: 'Varies', bonus: 'Holiday bonuses' }
                    ]
                }
            };
            
            container.innerHTML = Object.entries(guideData).map(([key, category]) => `
                <div class="xp-guide-category xp-guide-${key}">
                    <div class="xp-guide-category-title">${category.title}</div>
                    ${category.items.map(item => {
                        const dailyKey = item.type ? `${item.type}_${today}` : '';
                        const usedToday = xpDailyCounts[dailyKey] || 0;
                        const action = XP_ACTIONS[item.type];
                        const limitText = action ? `${usedToday}/${action.dailyMax} today` : '';
                        
                        return `
                        <div class="xp-guide-item" ${item.type ? `onclick="xpGuideAction('${item.type}', this)" style="cursor: pointer;"` : ''}>
                            <div class="xp-guide-action">
                                <span class="xp-guide-icon">${item.icon}</span>
                                <div>
                                    <div class="xp-guide-text">${item.action}</div>
                                    ${item.bonus ? `<div class="xp-guide-bonus">${item.bonus}</div>` : ''}
                                    ${limitText ? `<div class="xp-guide-bonus" style="color: var(--primary);">${limitText}</div>` : ''}
                                </div>
                            </div>
                            <div class="xp-guide-amount"> ${item.xp} XP</div>
                        </div>
                    `}).join('')}
                </div>
            `).join('');
            
            // Update XP display in guide
            const guideXp = document.getElementById('guideXpAmount');
            const guideLevel = document.getElementById('guideLevel');
            if (guideXp) guideXp.textContent = formatNumber(userXP.xp) + ' XP';
            if (guideLevel) guideLevel.textContent = 'Level ' + userXP.level;
        }
        
        async function xpGuideAction(actionType, element) {
            // Visual feedback
            element.style.background = 'var(--primary-glow)';
            setTimeout(() => {
                element.style.background = '';
            }, 200);
            
            const result = await earnXP(actionType);
            if (result) {
                showToast(` +XP earned for ${actionType}!`);
                renderXPGuide(); // Refresh to update daily limits
            } else {
                showToast(' Action on cooldown or daily limit reached');
            }
        }
        
        async function purchaseItem(itemId, price) {
            if (userXP.xp < price) {
                showToast(' Not enough XP!');
                return;
            }
            
            try {
                const res = await fetch('/api/shop/purchase', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    userXP.xp = data.remaining_xp;
                    updateShopXPDisplay();
                    await loadInventory();
                    renderShopItems();
                    showToast(' Purchased ' + data.name + '!');
                    trackStat('purchases');
                } else {
                    showToast(' ' + (data.error || 'Purchase failed'));
                }
            } catch (e) {
                showToast(' Purchase failed');
            }
        }
        
        async function toggleEquipItem(itemId, equip) {
            try {
                const res = await fetch('/api/shop/equip', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: itemId, equip: equip })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    await loadInventory();
                    renderInventory();
                    showToast(equip ? ' Item equipped!' : 'Item unequipped');
                } else {
                    showToast(' ' + (data.error || 'Failed'));
                }
            } catch (e) {
                console.error('Equip error:', e);
            }
        }
        
        const originalSwitchTab = switchTab;
        switchTab = function(tab, btn) {
            originalSwitchTab(tab, btn);
            if (tab === 'shop') loadShopData();
        };
        
        async function awardXP(amount, action) {
            try {
                const res = await fetch('/api/xp/award', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount, action: action })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    userXP.xp = data.new_total;
                    userXP.level = data.level;
                    updateShopXPDisplay();
                    updateInventoryXPDisplay();
                    if (data.leveled_up) showToast('Level Up! You are now level ' + data.level + '!');
                    return data;
                }
            } catch (e) {
                console.error('Award XP error:', e);
            }
        }
        
        // Track stats for achievements
        async function trackStat(type, increment = 1) {
            userStats[type] = (userStats[type] || 0) + increment;
            await checkAchievement(type, userStats[type]);
            
            // Save to localStorage
            localStorage.setItem('userAchievements', JSON.stringify({
                completed: userAchievements,
                stats: userStats
            }));
        }
        // Start
        init();
    </script>
</body>
</html>





